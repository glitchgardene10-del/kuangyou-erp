<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±…æœå“¡è–ªè³‡ç³»çµ± (v3.0 ç©©å®šå›æ­¸ç‰ˆ)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” éæ³•å­˜å–ï¼\n\nè«‹ç”±ã€Œç®¡ç†å¾Œå°ã€ç™»å…¥å¾Œæ“ä½œã€‚");
                window.location.href = 'index.html'; 
                return;
            }
            try {
                const user = JSON.parse(userSession);
                console.log("âœ… Identity Verified:", user.name);
            } catch (e) {
                window.location.href = 'index.html';
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: "Noto Sans TC", sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .drop-zone { border: 2px dashed #94a3b8; background-color: white; border-radius: 12px; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 120px; position: relative; overflow: hidden; }
        .drop-zone:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .drop-zone.uploaded { border-color: #10b981; background-color: #ecfdf5; }

        .sys-th { background-color: #334155; color: white; padding: 12px; text-align: left; white-space: nowrap; position: sticky; top: 0; z-index: 20; font-size: 13px; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sys-td { border-bottom: 1px solid #e2e8f0; padding: 6px; background-color: white; }
        .sys-input { width: 100%; min-width: 70px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: right; font-family: "Roboto Mono", monospace; font-size: 13px; transition: all 0.2s; }
        .sys-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        .sys-input-text { text-align: left; min-width: 150px; } 
        .deduct-input { color: #dc2626; border-color: #fca5a5; } 
        .rate-input { color: #059669; font-weight: bold; border-color: #6ee7b7; background-color: #f0fdf4; } 
        
        .batch-input { width: 100%; padding: 6px; border: 2px solid #60a5fa; border-radius: 6px; text-align: right; background-color: #eff6ff; color: #1e40af; font-weight: bold; font-size: 12px; }
        .batch-deduct { border-color: #f87171; background-color: #fef2f2; color: #b91c1c; }
        .batch-rate { border-color: #34d399; background-color: #ecfdf5; color: #047857; }
        .batch-row td { background-color: #f1f5f9; border-bottom: 2px solid #cbd5e1; padding: 10px 6px; position: sticky; top: 43px; z-index: 15; }

        .auto-cell { background-color: #f0f9ff; color: #0369a1; font-weight: bold; text-align: center; font-family: "Roboto Mono", monospace; }
        .auto-input-bg { background-color: #eef2ff; color: #3730a3; font-weight: bold; border-color: #c7d2fe; }
        .leave-header { background-color: #0284c7 !important; }
        .extra-header { background-color: #ca8a04 !important; }
        .deduct-header { background-color: #b91c1c !important; }
        .rate-header { background-color: #059669 !important; }

        /* è–ªè³‡å–®åˆ—å°æ¨£å¼ */
        .payslip-canvas { width: 794px; min-height: 1123px; background: white; padding: 40px 50px; margin: 0 auto; color: #000; box-sizing: border-box; position: relative; font-family: "Noto Sans TC", sans-serif; line-height: 1.4; }
        #preview-viewport { overflow: auto; background-color: #475569; padding: 40px; display: flex; justify-content: center; align-items: flex-start; border-radius: 12px; box-shadow: inset 0 0 20px rgba(0,0,0,0.3); }
        #preview-scaler { transform: scale(0.85); transform-origin: top center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .rp-header-container { text-align: center; margin-bottom: 20px; }
        .rp-title { font-size: 16px; font-weight: 900; margin-bottom: 5px; line-height: 1.3; white-space: nowrap; letter-spacing: 0.5px; }
        .rp-subtitle { font-size: 20px; font-weight: bold; text-decoration: underline; }
        .header-split { display: flex; justify-content: space-between; align-items: flex-end; border: 2px solid #000; padding: 15px 20px; margin-bottom: 20px; background-color: #f8fafc; border-radius: 4px; }
        .info-left { display: flex; flex-direction: column; gap: 10px; width: 55%; text-align: left; }
        .info-row { display: flex; align-items: baseline; font-size: 15px; font-weight: 600; color: #333; }
        .info-label { margin-right: 5px; white-space: nowrap; width: 90px; }
        .info-val { font-weight: 800; color: #000; font-size: 16px; border-bottom: 1px solid #000; padding-bottom: 4px; padding-left: 5px; padding-right: 10px; min-width: 80px; display: inline-block; }
        .name-val { font-size: 18px; }
        .info-right { display: flex; flex-direction: column; gap: 12px; width: 35%; text-align: right; justify-content: flex-end; }
        .sum-row { font-size: 16px; font-weight: bold; }
        .sum-val { font-family: "Roboto Mono", monospace; font-size: 22px; margin-left: 5px; font-weight: 800; }
        .grid-box { display: flex; width: 100%; border: 2px solid #000; }
        .col-L { width: 50%; border-right: 2px solid #000; }
        .col-R { width: 50%; }
        .tbl { width: 100%; border-collapse: collapse; }
        .td-row { border-bottom: 1px solid #ccc; height: 30px; }
        .td-content { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; height: 100%; }
        .tbl tr:last-child .td-row { border-bottom: none; }
        .label { font-size: 13px; font-weight: 600; color: #1f293b; }
        .val { font-family: "Roboto Mono", monospace; font-weight: 700; font-size: 14px; color: #000; }
        .t-blue { color: #1d4ed8; } .t-red { color: #b91c1c; } .bg-hl { background-color: #eff6ff; } .bg-red-light { background-color: #fef2f2; }
        .footer { margin-top: 20px; border: 1px solid #000; padding: 15px; font-size: 12px; line-height: 1.6; }
        .footer-section { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #ccc; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; }
        .badge-personal { background-color: #dbeafe; color: #1e40af; } .badge-public { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-[1800px] mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
        <div class="flex flex-col mb-8 border-b pb-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">ğŸ’° å±…æœå“¡è–ªè³‡ç³»çµ± <span class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded ml-2 align-middle font-normal">v3.0 ç©©å®šå›æ­¸ç‰ˆ</span></h1>
                <div class="flex gap-3">
                    <button onclick="location.reload()" class="text-sm text-slate-500 hover:text-red-500 font-bold px-4 py-2 border border-slate-300 rounded hover:bg-slate-50 transition">â†º é‡ç½®ç³»çµ±</button>
                </div>
            </div>
            <div id="firebase-status" class="mt-2 text-sm font-bold text-slate-400 flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-slate-300" id="status-dot"></span>
                <span id="status-text">æ­£åœ¨é€£æ¥è³‡æ–™åº«...</span>
            </div>
        </div>

        <div id="step-1" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div id="drop-main" class="drop-zone group bg-blue-50 border-blue-300">
                <input type="file" id="fileMain" accept=".xlsx" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="window.loadFile(this, 'main')">
                <div class="text-3xl mb-2 pointer-events-none">ğŸ“</div>
                <h3 class="font-bold text-blue-800 text-sm mb-1 pointer-events-none">1. è–ªè³‡å ±è¡¨ (æ•´åˆæª”)</h3>
                <p id="msg-main" class="text-xs text-blue-600 pointer-events-none">æ˜ç´°ç¸½è¨ˆ / è–ªè³‡è¡¨</p>
            </div>
            <div id="drop-a" class="drop-zone group">
                <input type="file" id="fileA" accept=".xlsx,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="window.loadFile(this, 'a')">
                <div class="text-3xl mb-2 text-slate-400 pointer-events-none">ğŸ“„</div>
                <h3 class="font-bold text-slate-700 text-sm mb-1 pointer-events-none">2. æ‹†å¸³è¡¨æ˜ç´°</h3>
                <p id="msg-a" class="text-xs text-slate-400 pointer-events-none">è¨ˆç®— AA11, AA05, AA06</p>
            </div>
            <div id="drop-b" class="drop-zone group border-purple-300 bg-purple-50">
                <input type="file" id="fileB" accept=".xlsx,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="window.loadFile(this, 'b')">
                <div class="text-3xl mb-2 text-purple-400 pointer-events-none">ğŸšŒ</div>
                <h3 class="font-bold text-purple-700 text-sm mb-1 pointer-events-none">3. çå‹µæ´¥è²¼æ¸…å†Š</h3>
                <p id="msg-b" class="text-xs text-slate-400 pointer-events-none">è¨ˆç®—åé„‰/äº¤é€š</p>
            </div>
        </div>

        <div id="step-2" class="hidden mb-12 animate-fade-in-up">
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6 flex justify-between items-center">
                <div class="flex gap-4 items-center">
                    <h4 class="font-bold text-yellow-800 text-sm">âš™ï¸ å…¨åŸŸé è¨­å€¼ï¼š</h4>
                    <label class="text-sm font-bold text-slate-700">é è¨­æ™‚è–ª <input type="number" id="config-base-rate" value="230" class="sys-input w-24 text-center border-yellow-400 bg-white font-bold text-lg"></label>
                    <label class="text-sm font-bold text-slate-700">è½‰å ´åŸºæ•¸ <input type="number" id="config-trans-rate" value="190" class="sys-input w-24 text-center border-yellow-400 bg-white font-bold text-lg"></label>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.autoFillLeaves()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-1 px-4 rounded text-sm shadow flex items-center gap-1 transition">
                        <span>ğŸ”„</span> è‡ªå‹•è®€å–è«‹å‡æ™‚æ•¸
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-end mb-4">
                <h3 class="text-xl font-bold text-slate-800 border-l-4 border-blue-500 pl-3">æ­¥é©Ÿ 2: è¼¸å…¥è®Šå‹•åƒæ•¸ & å€‹åˆ¥è€ƒæ ¸èª¿æ•´</h3>
                <div class="flex gap-2">
                    <button onclick="window.exportParams()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-1 px-4 rounded text-sm shadow flex items-center gap-1 transition">ğŸ’¾ å„²å­˜è®Šå‹•åƒæ•¸</button>
                    <button onclick="document.getElementById('paramFile').click()" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-1 px-4 rounded text-sm shadow flex items-center gap-1 transition">ğŸ“‚ è®€å–è®Šå‹•åƒæ•¸</button>
                    <input type="file" id="paramFile" hidden accept=".json" onchange="window.importParams(this)">
                </div>
            </div>
            
            <div class="overflow-x-auto border border-slate-200 rounded-xl max-h-[600px] shadow-inner bg-white">
                <table class="sys-table w-full">
                    <thead class="bg-slate-800 text-white sticky top-0 z-20 shadow-md">
                        <tr>
                            <th class="sys-th w-16 text-center">ç·¨è™Ÿ</th>
                            <th class="sys-th w-24 sticky left-0 z-30 bg-slate-800 shadow-r">å§“å</th>
                            <th class="sys-th rate-header w-20 text-xs">æ™‚è–ªåŸºæ•¸<br>(è€ƒæ ¸)</th>
                            <th class="sys-th auto-cell w-20 text-xs">AA11<br>(è‡ªå‹•)</th>
                            <th class="sys-th auto-cell w-20 text-xs">AA05<br>(è‡ªå‹•)</th>
                            <th class="sys-th auto-cell w-20 text-xs">AA06<br>(è‡ªå‹•)</th>
                            <th class="sys-th auto-cell w-20 text-xs">åé„‰<br>(è‡ªå‹•)</th>
                            <th class="sys-th auto-cell w-20 text-xs">äº¤é€š<br>(è‡ªå‹•)</th>
                            <th class="sys-th extra-header text-orange-50 w-20 text-xs">è£œå·¥æ™‚<br>(H)</th>
                            <th class="sys-th extra-header text-orange-50 w-20 text-xs">è£œäº¤é€š<br>(H)</th>
                            <th class="sys-th extra-header text-indigo-50 text-indigo-800 w-20 text-xs">è‡ªæ<br>(è‡ªå‹•%)</th> 
                            <th class="sys-th leave-header text-white w-20 text-xs">ç‰¹ä¼‘<br>(æ™‚)</th>
                            <th class="sys-th leave-header text-white w-20 text-xs">å–ªå‡<br>(æ™‚)</th>
                            <th class="sys-th leave-header text-white w-20 text-xs">ç¥­å„€<br>(æ™‚)</th>
                            <th class="sys-th w-24">æŠ€èƒ½å¼·åŒ–</th>
                            <th class="sys-th w-24 bg-indigo-50 text-indigo-800">ä¸™è­‰(è‡ªå‹•)</th> 
                            <th class="sys-th w-24">ç”Ÿæ—¥ç¦®é‡‘</th>
                            <th class="sys-th w-24">æœå‹™çé‡‘</th>
                            <th class="sys-th w-24">æœƒè­°å‡ºå¸­</th>
                            <th class="sys-th text-blue-200 w-24">ä¸­ç§‹/ç«¯åˆ</th>
                            <th class="sys-th w-24">å…¶ä»–(è–ªè³‡)</th>
                            <th class="sys-th deduct-header w-24 text-red-50">å…¶ä»–æ‰£æ¬¾</th>
                            <th class="sys-th w-40">å€‹äººå‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody class="bg-slate-50 border-b-2 border-slate-300 sticky top-[60px] z-10 shadow-sm">
                        <tr class="batch-row">
                            <td colspan="2" class="sys-td text-right font-bold text-blue-600 pr-4">âš¡ æ‰¹æ¬¡å¡«å¯«ï¼š</td>
                            <td class="sys-td"><input type="number" class="batch-input batch-rate" oninput="window.applyBatch('base_rate', this.value)"></td>
                            <td colspan="5" class="sys-td text-center text-gray-300">--</td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('add_work', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('add_trans', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('pension_rate', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('leave_special', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('leave_funeral', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('leave_ritual', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('skill', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('license_bonus', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('birthday', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('service', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('meeting', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('festival', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input" oninput="window.applyBatch('other', this.value)"></td>
                            <td class="sys-td"><input type="number" class="batch-input batch-deduct" oninput="window.applyBatch('other_deduct', this.value)"></td>
                            <td class="sys-td text-center text-gray-300">--</td>
                        </tr>
                    </tbody>
                    <tbody id="tbody-manual" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-center">
                <button onclick="window.calculateAndShow()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-full shadow-lg text-xl transition transform hover:-translate-y-1 flex items-center gap-3">
                    <span>ğŸ”„</span> æ›´æ–°è¨ˆç®—çµæœä¸¦é è¦½
                </button>
            </div>
        </div>

        <div id="step-3" class="hidden animate-fade-in-up">
            <div class="mb-10 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-bold text-slate-800">ğŸ“Š è–ªè³‡è¨ˆç®—ç¸½è¡¨</h3>
                    <div class="flex gap-4 items-center">
                        <div class="bg-blue-50 text-blue-800 px-5 py-3 rounded-lg border border-blue-100 shadow-sm">
                            <span class="text-sm font-bold block opacity-70">æœ¬æœˆè–ªè³‡ç¸½è¨ˆ</span>
                            <span class="text-2xl font-black font-mono tracking-tight" id="total-salary-sum">0</span>
                        </div>
                        <div class="bg-red-50 text-red-800 px-5 py-3 rounded-lg border border-red-100 shadow-sm">
                            <span class="text-sm font-bold block opacity-70">å¯¦ç™¼è–ªè³‡ç¸½è¨ˆ</span>
                            <span class="text-2xl font-black font-mono tracking-tight" id="total-net-sum">0</span>
                        </div>
                        
                        <div class="flex flex-col items-end gap-1 ml-4 border-l pl-4 border-slate-300">
                            <div class="flex items-center gap-2">
                                <label class="text-xs font-bold text-slate-600">æ­¸æª”æœˆä»½:</label>
                                <input type="month" id="archive-month" class="border border-slate-300 rounded px-2 py-1 text-sm font-bold text-slate-700">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.deleteArchivedData()" class="bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-3 rounded shadow flex items-center gap-1 text-sm transition" title="åˆªé™¤è©²æœˆæ‰€æœ‰è³‡æ–™">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                                <button onclick="window.archiveData()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded shadow flex items-center gap-2 text-sm transition transform hover:-translate-y-0.5">
                                    ğŸ’¾ å¯«å…¥ (æœƒè¨ˆæ­¸æª”)
                                </button>
                            </div>
                        </div>

                    </div>
                    <button onclick="window.exportCSV()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-5 rounded text-sm transition hover:bg-slate-900 ml-auto flex items-center gap-2">ğŸ“¥ ä¸‹è¼‰ CSV</button>
                </div>
                <div class="overflow-x-auto border rounded-lg bg-white shadow-inner max-h-[400px]">
                    <table class="sys-table w-full text-sm">
                        <thead class="text-xs uppercase bg-slate-800 text-white sticky top-0"><tr id="thead-result"></tr></thead>
                        <tbody id="tbody-result" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex flex-col xl:flex-row gap-8 border-t-2 border-slate-200 pt-8">
                <div class="w-full xl:w-1/3 space-y-6 sticky top-4 h-fit">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-blue-100 ring-1 ring-blue-50">
                        <h3 class="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2"><span>ğŸ–¨ï¸</span> è¼¸å‡ºä¸­å¿ƒ</h3>
                        
                        <div class="mb-6">
                            <label class="block font-bold mb-2 text-sm text-slate-600">å…¨é«”å…¬å‘Šäº‹é …ï¼š</label>
                            <textarea id="custom-note" class="w-full border border-slate-300 p-3 rounded-lg text-sm h-24 resize-none focus:ring-2 focus:ring-blue-200 outline-none" placeholder="åœ¨æ­¤è¼¸å…¥è£œå……èªªæ˜ (å…¨é«”å…¬å‘Š)..." oninput="window.renderPreview()"></textarea>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                            <label class="block font-bold mb-2 text-sm text-slate-600">é è¦½å“¡å·¥ï¼š</label>
                            <select id="sel-emp" class="w-full border border-slate-300 p-2 rounded-lg mb-3 outline-none bg-white" onchange="window.renderPreview()">
                                <option>è«‹é¸æ“‡å“¡å·¥...</option>
                            </select>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="window.downloadCurrentJPG()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow flex justify-center items-center gap-2 text-sm transition">
                                    ğŸ–¼ï¸ ä¸‹è¼‰åœ–ç‰‡
                                </button>
                                <button onclick="window.downloadCurrentPDF()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow flex justify-center items-center gap-2 text-sm transition">
                                    ğŸ“„ ä¸‹è¼‰ PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-red-50 p-6 rounded-xl shadow-md border border-red-100">
                        <h4 class="font-bold text-red-800 mb-3 flex items-center gap-2"><span>ğŸ“¦</span> æ‰¹æ¬¡ä½œæ¥­</h4>
                        <div class="grid grid-cols-1 gap-3">
                            <button id="btn-batch" onclick="window.batchProcess()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition text-sm">ä¸‹è¼‰æ‰€æœ‰ PDF (ZIP)</button>
                            <button id="btn-batch-jpg" onclick="window.batchProcessJPG()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg shadow transition text-sm">ä¸‹è¼‰æ‰€æœ‰åœ–ç‰‡ (ZIP)</button>
                        </div>
                        <div id="progress-box" class="hidden mt-4">
                            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden"><div id="p-bar" class="bg-red-500 h-2 rounded-full w-0 transition-all duration-200"></div></div>
                            <p id="p-text" class="text-xs text-center mt-2 font-bold text-slate-600"></p>
                        </div>
                    </div>
                </div>

                <div class="w-full xl:w-2/3 bg-slate-600 rounded-xl p-8 overflow-auto flex justify-center shadow-inner" id="preview-viewport" style="height: 900px;">
                    <div id="preview-scaler">
                        <div id="payslip-entity" class="payslip-canvas">
                            <div class="rp-header-container">
                                <div class="rp-title">å…‰ç¥æœ‰é™å…¬å¸é™„è¨­èŠ±è“®ç¸£å…‰ç¥ç§ç«‹å±…å®¶å¼æœå‹™é¡é•·æœŸç…§é¡§æœå‹™æ©Ÿæ§‹</div>
                                <div class="rp-subtitle" id="dynamic-date">è–ªè³‡å–®</div>
                            </div>
                            
                            <div class="header-split">
                                <div class="info-left">
                                    <div class="info-row"><span class="info-label">å§“åï¼š</span><span class="info-val name-val" data-k="å§“å"></span></div>
                                    <div class="info-row"><span class="info-label">æŠ•ä¿ç´šè·ï¼š</span><span class="info-val" data-k="æŠ•ä¿ç´šè·"></span></div>
                                    <div class="info-row"><span class="info-label">åŠ ç­è²»åŸºæ•¸ï¼š</span><span class="info-val" data-k="åŠ ç­è²»åŸºæ•¸"></span></div>
                                    <div class="info-row"><span class="info-label">å‹é€€ææ’¥(6%)ï¼š</span><span class="info-val" data-k="å‹é€€ææ’¥"></span></div>
                                </div>
                                <div class="info-right">
                                    <div class="sum-row t-blue">æœ¬æœˆè–ªè³‡ï¼š<span class="sum-val" data-k="æœ¬æœˆè–ªè³‡"></span> å…ƒ</div>
                                    <div class="sum-row t-red">å¯¦é ˜è–ªè³‡ï¼š<span class="sum-val" data-k="å¯¦é ˜è–ªè³‡"></span> å…ƒ</div>
                                </div>
                            </div>

                            <div class="grid-box">
                                <div class="col-L">
                                    <table class="tbl">
                                        <tbody>
                                            <tr><td colspan="2"><div class="sub-th"><span>å·¥æ™‚æ˜ç´° (å°æ™‚)</span><span>ç¸½è¨ˆï¼š<span class="val" data-k="å·¥æ™‚ç¸½è¨ˆ"></span></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">æœ¬æœˆå·¥ä½œæ—¥æ™‚æ•¸</span><span class="val" data-k="æœ¬æœˆå·¥æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å·¥ä½œæ—¥åŠ ç­(9-10)</span><span class="val" data-k="å¹³åŠ (9-10)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å·¥ä½œæ—¥åŠ ç­(11-12)</span><span class="val" data-k="å¹³åŠ (11-12)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥åŠ ç­(0-2)</span><span class="val" data-k="ä¼‘åŠ (0-2)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥åŠ ç­(3-8)</span><span class="val" data-k="ä¼‘åŠ (3-8)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥åŠ ç­(9-10)</span><span class="val" data-k="ä¼‘åŠ (9-10)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">åœ‹å®šå‡æ—¥åŠ ç­(0-8)</span><span class="val" data-k="åœ‹åŠ (0-8)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">åœ‹å®šå‡æ—¥åŠ ç­(9-10)</span><span class="val" data-k="åœ‹åŠ (9-10)æ™‚"></span></div></td></tr>
                                            
                                            <tr><td colspan="2" style="padding-top: 10px;"><div class="sub-th"><span>è½‰å ´æ˜ç´°</span><span>ç¸½è¨ˆï¼š<span class="val" data-k="è½‰å ´ç¸½è¨ˆ"></span></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å·¥ä½œæ—¥è½‰å ´æ™‚æ•¸</span><span class="val" data-k="è½‰å ´å·¥æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">è½‰å ´(9-10)</span><span class="val" data-k="å¹³è½‰(9-10)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">è½‰å ´(11-12)</span><span class="val" data-k="å¹³è½‰(11-12)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥è½‰å ´(0-2)</span><span class="val" data-k="ä¼‘è½‰(0-2)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥è½‰å ´(3-8)</span><span class="val" data-k="ä¼‘è½‰(3-8)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥è½‰å ´(9-10)</span><span class="val" data-k="ä¼‘è½‰(9-10)æ™‚"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">åœ‹å®šå‡æ—¥è½‰å ´</span><span class="val" data-k="åœ‹è½‰å·¥æ™‚"></span></div></td></tr>
                                            
                                            <tr><td colspan="2" style="padding-top: 20px;"></td></tr>
                                            <tr><td colspan="2" style="border-top: 2px solid #000; background-color: #e2e8f0; font-weight: bold; padding: 5px; text-align: center; border-bottom: 1px solid #000;">ä»£æ‰£æ˜ç´°</td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å‹ä¿è²»</span><span class="val" data-k="å‹ä¿è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å¥ä¿è²»</span><span class="val" data-k="å¥ä¿è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å¥ä¿è²»(çœ·å±¬)</span><span class="val" data-k="å¥ä¿è²»(çœ·å±¬)"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å‹é€€è‡ªæ (<span data-k="è‡ªæè¶´æ•¸"></span>%)</span><span class="val" data-k="å‹é€€è‡ªæ"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-red">å…¶ä»–</span><span class="val t-red" data-k="å…¶ä»–æ‰£æ¬¾"></span></div></td></tr>
                                            <tr class="bg-red-light"><td class="td-row"><div class="td-content"><span class="label t-red font-bold">ä»£æ‰£å°è¨ˆ</span><span class="val t-red" data-k="ä»£æ‰£ç¸½è¨ˆ"></span></div></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-R">
                                    <table class="tbl">
                                        <tbody>
                                            <tr><td colspan="2" style="background-color: #e2e8f0; font-weight: bold; padding: 5px; text-align: center; border-bottom: 1px solid #000;">è–ªè³‡æ˜ç´° (å…ƒ)</td></tr>
                                            <tr class="bg-hl td-row"><td colspan="2"><div class="td-content"><span class="label font-bold">æœ¬è–ª</span><span class="val" data-k="æœ¬è–ª"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">å·¥ä½œæ—¥åŠ ç­è²»</span><span class="val" data-k="å·¥ä½œæ—¥åŠ ç­è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡æ—¥åŠ ç­è²»</span><span class="val" data-k="ä¼‘å‡æ—¥åŠ ç­è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">åœ‹å®šå‡æ—¥åŠ ç­è²»</span><span class="val" data-k="åœ‹å®šåŠ ç­è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">è½‰å ´äº¤é€šè²»</span><span class="val" data-k="è½‰å ´è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¼‘å‡è½‰å ´è²»</span><span class="val" data-k="ä¼‘å‡è½‰å ´è²»"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">åœ‹å®šè½‰å ´è²»</span><span class="val" data-k="åœ‹å®šè½‰å ´è²»"></span></div></td></tr>
                                            <tr><td colspan="2" style="border-top: 1px dashed #999; height: 2px;"></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">AA11</span><span class="val" data-k="AA11"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">AA05</span><span class="val" data-k="AA05"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">AA06</span><span class="val" data-k="AA06"></span></div></td></tr>

                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">åé„‰åŠ çµ¦</span><span class="val" data-k="åé„‰åŠ çµ¦"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">äº¤é€šåŠ çµ¦</span><span class="val" data-k="äº¤é€šåŠ çµ¦"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label">ä¸™è­‰åŠ çµ¦</span><span class="val" data-k="ä¸™è­‰åŠ çµ¦"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">æŠ€èƒ½å¼·åŒ–</span><span class="val" data-k="æŠ€èƒ½å¼·åŒ–çå‹µé‡‘"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">ç”Ÿæ—¥ç¦®é‡‘</span><span class="val" data-k="ç”Ÿæ—¥ç¦®é‡‘"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">æœå‹™çé‡‘</span><span class="val" data-k="æœå‹™çé‡‘"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">æœƒè­°å‡ºå¸­</span><span class="val" data-k="æœƒè­°å‡ºå¸­"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">ä¸­ç§‹/ç«¯åˆç¦®é‡‘</span><span class="val" data-k="ä¸­ç§‹ç«¯åˆ"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">å…¶ä»–(è–ªè³‡)</span><span class="val" data-k="å…¶ä»–"></span></div></td></tr>
                                            
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">ç‰¹ä¼‘</span><span class="val" data-k="ç‰¹ä¼‘"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">å–ªå‡</span><span class="val" data-k="å–ªå‡"></span></div></td></tr>
                                            <tr><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">æ­²æ™‚ç¥­å„€</span><span class="val" data-k="æ­²æ™‚ç¥­å„€"></span></div></td></tr>
                                            
                                            <tr><td colspan="2" style="height: 50px;"></td></tr>
                                            <tr class="bg-hl" style="border-top: 2px solid #000;"><td class="td-row"><div class="td-content"><span class="label t-blue font-bold">æ‡‰ç™¼å°è¨ˆ</span><span class="val t-blue" data-k="æœ¬æœˆè–ªè³‡"></span></div></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="footer">
                                <strong>å‚™è¨»èªªæ˜ / å…¬å‘Šäº‹é …ï¼š</strong>
                                <div id="footer-note" style="margin-top:5px; color: #000;">
                                    </div>
                                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 5px; font-size: 10px; color: #666;">
                                    æœ¬è–ªè³‡å–®åƒ…ä¾›æ ¸å°ä½¿ç”¨ï¼Œå¦‚æœ‰å¡—æ”¹ç„¡æ•ˆã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, updateDoc, doc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        let app, db, auth;
        const statusText = document.getElementById("status-text");
        const statusDot = document.getElementById("status-dot");

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    statusText.innerText = "Firebase å·²é€£ç·š (èº«åˆ†é©—è­‰æˆåŠŸ)";
                    statusDot.classList.replace("bg-slate-300", "bg-green-500");
                } else {
                    statusText.innerText = "ç­‰å¾…ç™»å…¥...";
                    statusDot.classList.replace("bg-slate-300", "bg-yellow-400");
                }
            });

        } catch (e) {
            console.error(e);
            statusText.innerText = "åˆå§‹åŒ–å¤±æ•—";
            statusDot.classList.replace("bg-slate-300", "bg-red-500");
        }

        let rawH=[], rawS=[], rawA=[], rawB=[], merged=[], results=[], empMap=new Map(), aaMap=new Map(), aa05Map=new Map(), aa06Map=new Map(), subsidyMap=new Map();
        let dbEmployees = new Map(); 
        let currentDateLabel = "è–ªè³‡å–®";
        const { jsPDF } = window.jspdf;

        let savedManualData = {};

        // ç¶å®šå…¨åŸŸ
        window.loadFile = loadFile;
        window.saveInput = saveInput;
        window.applyBatch = applyBatch;
        window.calculateAndShow = calculateAndShow;
        window.exportParams = exportParams;
        window.importParams = importParams;
        window.renderPreview = renderPreview;
        window.downloadCurrentJPG = downloadCurrentJPG;
        window.downloadCurrentPDF = downloadCurrentPDF;
        window.batchProcess = batchProcess;
        window.batchProcessJPG = batchProcessJPG;
        window.exportCSV = exportCSV;
        window.archiveData = archiveData;
        window.deleteArchivedData = deleteArchivedData;
        window.autoFillLeaves = autoFillLeaves;

        function loadFile(input, type) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                if(type === 'main') {
                    const sheetHName = wb.SheetNames.find(n => n.includes('æ˜ç´°ç¸½è¨ˆ'));
                    const sheetSName = wb.SheetNames.find(n => n.includes('è–ªè³‡è¡¨'));
                    if(!sheetHName || !sheetSName) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ã€Œæ˜ç´°ç¸½è¨ˆã€æˆ–ã€Œè–ªè³‡è¡¨ã€åˆ†é ");
                    rawH = XLSX.utils.sheet_to_json(wb.Sheets[sheetHName], {header:1});
                    rawS = XLSX.utils.sheet_to_json(wb.Sheets[sheetSName], {header:1});
                    if(rawS.length > 1 && rawS[1][0]) {
                        const match = rawS[1][0].toString().match(/(\d{4}å¹´\d{1,2}æœˆ)/);
                        if(match) {
                            currentDateLabel = match[1] + " è–ªè³‡å–®";
                            document.getElementById('dynamic-date').innerText = currentDateLabel;
                            const y = match[1].substring(0, 4);
                            const m = match[1].substring(5, match[1].indexOf('æœˆ')).padStart(2, '0');
                            document.getElementById('archive-month').value = `${y}-${m}`;
                        }
                    }
                    document.getElementById('drop-main').classList.add('uploaded');
                } else if(type === 'a') {
                    rawA = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    document.getElementById('drop-a').classList.add('uploaded');
                } else if(type === 'b') {
                    rawB = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    document.getElementById('drop-b').classList.add('uploaded');
                }
                if(rawH.length && rawS.length && rawA.length && rawB.length) processAll();
            };
            r.readAsArrayBuffer(input.files[0]);
        }

        function exportParams() {
            if (Object.keys(savedManualData).length === 0) {
                alert("ç›®å‰æ²’æœ‰ä»»ä½•è®Šå‹•åƒæ•¸å¯å„²å­˜ï¼");
                return;
            }
            const blob = new Blob([JSON.stringify(savedManualData)], {type: "application/json"});
            const datePrefix = currentDateLabel.replace(" è–ªè³‡å–®", "") || "temp";
            saveAs(blob, `${datePrefix}_è–ªè³‡è®Šå‹•åƒæ•¸.json`);
        }

        function importParams(input) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    savedManualData = JSON.parse(e.target.result);
                    if (merged.length > 0) {
                        renderManualTable();
                        alert("åƒæ•¸è®€å–æˆåŠŸï¼è¡¨æ ¼å·²æ›´æ–°ã€‚");
                    } else {
                        alert("åƒæ•¸è®€å–æˆåŠŸï¼è«‹ç¹¼çºŒä¸Šå‚³ Excel æª”æ¡ˆä»¥é¡¯ç¤ºè³‡æ–™ã€‚");
                    }
                } catch (err) {
                    alert("åƒæ•¸æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼");
                }
                input.value = '';
            };
            r.readAsText(input.files[0]);
        }

        async function processAll() {
            const q = query(collection(db, "employees"), where("role", "==", "caregiver"));
            const querySnapshot = await getDocs(q);
            dbEmployees.clear();
            querySnapshot.forEach((doc) => {
                dbEmployees.set(doc.data().name, { id: doc.id, ...doc.data() });
            });

            aaMap.clear(); aa05Map.clear(); aa06Map.clear(); subsidyMap.clear();

            for(let i=2; i<rawA.length; i++) {
                const r = rawA[i];
                if(r.length < 15) continue;
                const name = r[1]?.toString().trim() || "";
                const code = r[12]?.toString().trim() || "";
                const qty = parseFloat(r[14]) || 0;
                if(name) {
                    if (code === 'AA11') aaMap.set(name, (aaMap.get(name) || 0) + qty);
                    else if (code === 'AA05') aa05Map.set(name, (aa05Map.get(name) || 0) + qty);
                    else if (code === 'AA06') aa06Map.set(name, (aa06Map.get(name) || 0) + qty);
                }
            }

            for(let i=2; i<rawB.length; i++) { 
                const r = rawB[i];
                const name = r[2]?.toString().trim() || "";
                const amt = parseFloat(r[12]) || 0;
                if(name && amt > 0) subsidyMap.set(name, amt / 2);
            }

            const hMap = new Map();
            for(let i=3; i<rawH.length; i++) {
                if(rawH[i][3]) hMap.set(rawH[i][3].toString().trim(), rawH[i]);
            }
            
            merged = [];
            for(let i=3; i<rawS.length; i++) {
                const r = rawS[i];
                const name = r[3]?.toString().trim();
                
                if(name && hMap.has(name) && dbEmployees.has(name)) {
                    merged.push({ 
                        id: r[1]||"", name: name, 
                        hRow: hMap.get(name), sRow: r, 
                        aaAmt: (aaMap.get(name)||0) * 50,
                        aa05Amt: (aa05Map.get(name)||0) * 50,
                        aa06Amt: (aa06Map.get(name)||0) * 50,
                        subAmt: subsidyMap.get(name) || 0 
                    });
                }
            }

            await syncFirestoreData();
            renderManualTable();
        }

        async function syncFirestoreData() {
            statusText.innerText = "æ­£åœ¨åŒæ­¥ Firebase è¨­å®š...";
            statusDot.className = "w-3 h-3 rounded-full bg-yellow-400 animate-pulse";
            
            try {
                merged.forEach(m => {
                    const dbData = dbEmployees.get(m.name);
                    if (dbData) {
                        if (!savedManualData[m.name]) savedManualData[m.name] = {};
                        const rate = Number(dbData.hourlyWage) || 230;
                        const bonus = Number(dbData.hourlyBonus) || 0;
                        savedManualData[m.name]['base_rate'] = rate + bonus;
                        if (dbData.hasLicense === true && savedManualData[m.name]['license_bonus'] === undefined) {
                            savedManualData[m.name]['license_bonus'] = 1000;
                        }
                        if (dbData.pensionRate !== undefined && dbData.pensionRate !== null && savedManualData[m.name]['pension_rate'] === undefined) {
                            savedManualData[m.name]['pension_rate'] = Number(dbData.pensionRate);
                        }
                    }
                });
                statusText.innerText = "Firebase é€£ç·šæˆåŠŸ (è³‡æ–™å·²åŒæ­¥)";
                statusDot.className = "w-3 h-3 rounded-full bg-green-500";
            } catch (error) {
                console.error("Firebase Sync Error:", error);
                statusText.innerText = "Firebase é€£ç·šå¤±æ•—";
                statusDot.className = "w-3 h-3 rounded-full bg-red-500";
            }
        }

        // â˜… æ–°å¢ï¼šè‡ªå‹•è®€å–è«‹å‡æ™‚æ•¸
        async function autoFillLeaves() {
            const monthStr = document.getElementById('archive-month').value;
            if (!monthStr) return alert("è«‹å…ˆè®€å– Excel ä»¥ç¢ºå®šæœˆä»½ï¼Œæˆ–æ‰‹å‹•é¸æ“‡æ­¸æª”æœˆä»½");
            
            const startStr = monthStr + "-01";
            const endStr = dayjs(monthStr).endOf('month').format('YYYY-MM-DD');
            
            alert(`æ­£åœ¨æœå°‹ ${monthStr} çš„è«‹å‡ç´€éŒ„...`);
            
            try {
                let matchCount = 0;
                
                // æ‰¹æ¬¡è™•ç†ï¼šå°æ¯å€‹åœ¨åˆ—è¡¨ä¸­çš„å±…æœå“¡
                for (let emp of merged) {
                    const dbData = dbEmployees.get(emp.name);
                    if (!dbData) continue;

                    const q = query(collection(db, "leave_records"), 
                        where("empId", "==", dbData.id)
                    );
                    const snap = await getDocs(q);
                    
                    let sp = 0, fu = 0, ri = 0; // ç‰¹ä¼‘, å–ªå‡, ç¥­å„€

                    snap.forEach(doc => {
                        const r = doc.data();
                        if (r.date >= startStr && r.date <= endStr) {
                            const hours = Number(r.hours) || 0;
                            if (r.type.includes('ç‰¹ä¼‘')) sp += hours;
                            else if (r.type.includes('å–ª')) fu += hours;
                            else if (r.type.includes('ç¥­å„€')) ri += hours;
                        }
                    });

                    if (sp > 0 || fu > 0 || ri > 0) {
                        matchCount++;
                        if (!savedManualData[emp.name]) savedManualData[emp.name] = {};
                        if (sp > 0) savedManualData[emp.name]['leave_special'] = sp;
                        if (fu > 0) savedManualData[emp.name]['leave_funeral'] = fu;
                        if (ri > 0) savedManualData[emp.name]['leave_ritual'] = ri;
                    }
                }
                
                renderManualTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼é¡¯ç¤ºæ•¸å€¼
                alert(`âœ… è®€å–å®Œæˆï¼\nå…±æ›´æ–°äº† ${matchCount} ä½å±…æœå“¡çš„è«‹å‡è³‡æ–™ã€‚`);
                
            } catch (e) {
                console.error(e);
                alert("è®€å–å¤±æ•—");
            }
        }

        function renderManualTable() {
            const defaultBaseRate = document.getElementById('config-base-rate').value || 230;
            const tb = document.getElementById('tbody-manual');

            tb.innerHTML = merged.map((e,i) => {
                const saved = savedManualData[e.name] || {};
                const getVal = (k) => saved[k] !== undefined ? saved[k] : 0;
                const getBaseRate = () => saved['base_rate'] !== undefined ? saved['base_rate'] : defaultBaseRate;
                const getNote = () => saved['note'] || '';
                
                const dbData = dbEmployees.get(e.name) || {};
                const dbPension = dbData.pensionRate || 0;
                const dbLicense = dbData.hasLicense ? 'âœ…' : '-';

                return `
                <tr class="hover:bg-slate-50">
                    <td class="sys-td text-center text-xs text-gray-500">${e.id}</td>
                    <td class="sys-td font-bold sticky left-0 bg-white border-r shadow-sm">${e.name}</td>
                    
                    <td class="sys-td relative">
                        <input type="number" id="base_rate_${i}" value="${getBaseRate()}" class="sys-input rate-input base_rate-input auto-input-bg" onfocus="this.select()" onchange="saveInput('${e.name}', 'base_rate', this.value)">
                        <div class="text-[10px] text-indigo-400 text-center absolute bottom-0 w-full left-0 pointer-events-none">DBé€£å‹•</div>
                    </td>

                    <td class="sys-td text-center text-green-600 bg-green-50 font-bold auto-cell">${e.aaAmt}</td>
                    <td class="sys-td text-center text-green-600 bg-green-50 font-bold auto-cell">${e.aa05Amt}</td>
                    <td class="sys-td text-center text-green-600 bg-green-50 font-bold auto-cell">${e.aa06Amt}</td>
                    
                    <td class="sys-td text-center text-purple-600 bg-purple-50 font-bold auto-cell">${e.subAmt*2}</td>
                    <td class="sys-td text-center text-purple-600 bg-purple-50 font-bold auto-cell">${e.subAmt*2}</td>
                    
                    <td class="sys-td extra-col"><input type="number" class="sys-input add_work-input" id="add_work_${i}" value="${getVal('add_work')}" onfocus="this.select()" onchange="saveInput('${e.name}', 'add_work', this.value)"></td>
                    <td class="sys-td extra-col"><input type="number" class="sys-input add_trans-input" id="add_trans_${i}" value="${getVal('add_trans')}" onfocus="this.select()" onchange="saveInput('${e.name}', 'add_trans', this.value)"></td>
                    
                    <td class="sys-td extra-col relative">
                        <input type="number" class="sys-input pension_rate-input auto-input-bg" id="pension_rate_${i}" value="${getVal('pension_rate')}" onfocus="this.select()" onchange="saveInput('${e.name}', 'pension_rate', this.value)">
                        <div class="text-[10px] text-indigo-400 text-center absolute bottom-0 w-full left-0 pointer-events-none">DB:${dbPension}%</div>
                    </td>

                    <td class="sys-td leave-col"><input type="number" class="sys-input leave_special-input" id="leave_special_${i}" value="${getVal('leave_special')}" onfocus="this.select()" onchange="saveInput('${e.name}', 'leave_special', this.value)"></td>
                    <td class="sys-td leave-col"><input type="number" class="sys-input leave_funeral-input" id="leave_funeral_${i}" value="${getVal('leave_funeral')}" onfocus="this.select()" onchange="saveInput('${e.name}', 'leave_funeral', this.value)"></td>
                    <td class="sys-td leave-col"><input type="number" class="sys-input leave_ritual-input" id="leave_ritual_${i}" value="${getVal('leave_ritual')}" onfocus="this.select()" onchange="saveInput('${e.name}', 'leave_ritual', this.value)"></td>

                    <td class="sys-td"><input type="number" id="skill_${i}" value="${getVal('skill')}" class="sys-input skill-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'skill', this.value)"></td>
                    
                    <td class="sys-td relative">
                        <input type="number" id="license_bonus_${i}" value="${getVal('license_bonus')}" class="sys-input license_bonus-input auto-input-bg" onfocus="this.select()" onchange="saveInput('${e.name}', 'license_bonus', this.value)">
                        <div class="text-[10px] text-indigo-400 text-center absolute bottom-0 w-full left-0 pointer-events-none">DB:${dbLicense}</div>
                    </td>
                    
                    <td class="sys-td"><input type="number" id="birthday_${i}" value="${getVal('birthday')}" class="sys-input birthday-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'birthday', this.value)"></td>
                    <td class="sys-td"><input type="number" id="service_${i}" value="${getVal('service')}" class="sys-input service-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'service', this.value)"></td>
                    <td class="sys-td"><input type="number" id="meeting_${i}" value="${getVal('meeting')}" class="sys-input meeting-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'meeting', this.value)"></td>
                    <td class="sys-td"><input type="number" id="festival_${i}" value="${getVal('festival')}" class="sys-input festival-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'festival', this.value)"></td>
                    <td class="sys-td"><input type="number" id="other_${i}" value="${getVal('other')}" class="sys-input other-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'other', this.value)"></td>
                    
                    <td class="sys-td"><input type="number" id="other_deduct_${i}" value="${getVal('other_deduct')}" class="sys-input deduct-input other_deduct-input" onfocus="this.select()" onchange="saveInput('${e.name}', 'other_deduct', this.value)"></td>

                    <td class="sys-td"><input type="text" id="note_${i}" value="${getNote()}" class="sys-input sys-input-text note-input" onchange="saveInput('${e.name}', 'note', this.value)"></td>
                </tr>
            `}).join('');
            document.getElementById('step-2').classList.remove('hidden');
        }

        function saveInput(name, field, value) {
            if (!savedManualData[name]) savedManualData[name] = {};
            savedManualData[name][field] = field === 'note' ? value : Number(value);
        }

        function applyBatch(key, val) {
            document.querySelectorAll(`.${key}-input`).forEach((el, index) => {
                el.value = val;
                const name = merged[index].name;
                saveInput(name, key, val);
            });
        }

        function calculateAndShow() {
            calculate();
            document.getElementById('step-3').classList.remove('hidden');
            const sel = document.getElementById('sel-emp');
            if(sel.options.length > 1) {
                sel.selectedIndex = 1; 
                renderPreview();
            }
            document.getElementById('step-3').scrollIntoView({behavior: 'smooth'});
        }

        const IDX = { h: { work_day:[16], work_ot_9_10:[25,91], work_ot_11_12:[27,93], hol_ot_0_2:[45,111], hol_ot_3_8:[47,113], hol_ot_9_10:[49,115], nat_ot_0_8:[29,31,95,97], nat_ot_9_10:[33,99], trans_work:[15], trans_work_9_10:[26,92], trans_work_11_12:[28,94], trans_hol_0_2:[46,112], trans_hol_3_8:[48,114], trans_hol_9_10:[50,116], trans_nat:[30,32,96,98] }, s: { license:60, remote:61, trans:62, add_120:63, add_140:64, skill:65, level:67, labor:80, health:81, health_dep:82, pension:83 } };
        // â˜… NaN ä¿®å¾©ï¼šé‡å°ç©ºå€¼æˆ–éæ•¸å­—å¼·åˆ¶è½‰ 0
        const val = (r,i) => {
            if(i === undefined || i === -1) return 0;
            return (r[i]==null || isNaN(Number(r[i]))) ? 0 : Number(r[i]);
        };
        const sum = (r,idxs) => { 
            let s=0; 
            if(!idxs) return 0;
            idxs.forEach(i => s += val(r,i)); 
            return Math.round(s/60*1000)/1000; 
        };
        const fmt = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

        function calculate() {
            const baseRateGlobal = document.getElementById('config-base-rate') ? (Number(document.getElementById('config-base-rate').value) || 230) : 230;
            const transRateInput = document.getElementById('config-trans-rate');
            const trans_rate = transRateInput ? (Number(transRateInput.value) || 190) : 190;

            let totalSalarySum = 0;
            let totalNetSum = 0;

            results = merged.map((emp, i) => {
                const h = {}; for(let k in IDX.h) h[k] = sum(emp.hRow, IDX.h[k]);
                
                const saved = savedManualData[emp.name] || {};
                const m = {
                    skill: saved['skill'] || 0,
                    license: saved['license_bonus'] || 0,
                    birthday: saved['birthday'] || 0,
                    service: saved['service'] || 0,
                    meeting: saved['meeting'] || 0,
                    festival: saved['festival'] || 0,
                    other: saved['other'] || 0,
                    other_deduct: saved['other_deduct'] || 0
                };
                
                const personal_base_rate = saved['base_rate'] !== undefined ? saved['base_rate'] : baseRateGlobal;
                const add_work = saved['add_work'] || 0;
                const add_trans = saved['add_trans'] || 0;
                const pension_rate = Number(saved['pension_rate']) || 0;
                const note = saved['note'] || "";

                const leave_special_h = saved['leave_special'] || 0;
                const leave_funeral_h = saved['leave_funeral'] || 0;
                const leave_ritual_h = saved['leave_ritual'] || 0;

                const leave_special_amt = Math.round(leave_special_h * personal_base_rate);
                const leave_funeral_amt = Math.round(leave_funeral_h * personal_base_rate);
                const leave_ritual_amt = Math.round(leave_ritual_h * personal_base_rate);

                const s = emp.sRow;
                const ins_level = val(s, 67);

                h.work_day += add_work;
                h.trans_work += add_trans;

                const base = Math.round(personal_base_rate * h.work_day);
                
                const total_work_hours = Math.round((h.work_day + h.work_ot_9_10 + h.work_ot_11_12 + h.hol_ot_0_2 + h.hol_ot_3_8 + h.hol_ot_9_10 + h.nat_ot_0_8 + h.nat_ot_9_10)*1000)/1000;
                const total_trans_hours = Math.round((h.trans_work + h.trans_work_9_10 + h.trans_work_11_12 + h.trans_hol_0_2 + h.trans_hol_3_8 + h.trans_hol_9_10 + h.trans_nat)*1000)/1000;

                let hourly_bonus = 0;
                let final_license = (saved['license_bonus'] !== undefined) ? m.license : val(s, IDX.s.license);

                const ot_numerator = base + final_license + m.service + hourly_bonus + emp.aa05Amt + emp.aa06Amt;
                const ot_base = h.work_day > 0 ? Math.round(ot_numerator / h.work_day) : 0;
                
                const pay = {
                    wot: Math.round(ot_base*1.34*h.work_ot_9_10 + ot_base*1.67*h.work_ot_11_12),
                    hot: Math.round(ot_base*1.34*h.hol_ot_0_2 + ot_base*1.67*h.hol_ot_3_8 + ot_base*2.67*h.hol_ot_9_10),
                    not: Math.round(ot_base*2*h.nat_ot_0_8 + ot_base*2.34*h.nat_ot_9_10),
                    trans: Math.round(trans_rate*h.trans_work + trans_rate*1.34*h.trans_work_9_10 + trans_rate*1.67*h.trans_work_11_12),
                    htrans: Math.round(trans_rate*1.34*h.trans_hol_0_2 + trans_rate*1.67*h.trans_hol_3_8 + trans_rate*2.67*h.trans_hol_9_10),
                    ntrans: Math.round(trans_rate*2*h.trans_nat)
                };
                
                const total = Math.round(base + pay.wot + pay.hot + pay.not + pay.trans + pay.htrans + pay.ntrans + emp.aaAmt + emp.aa05Amt + emp.aa06Amt + final_license + emp.subAmt*2 + hourly_bonus + m.skill + m.birthday + m.service + m.meeting + m.festival + m.other + leave_special_amt + leave_funeral_amt + leave_ritual_amt);
                
                const pension_self = Math.round(ins_level * (pension_rate / 100));
                const pension_employer = Math.round(ins_level * 0.06);

                const deduct = val(s,IDX.s.labor) + val(s,IDX.s.health) + val(s,IDX.s.health_dep) + pension_self + m.other_deduct;

                totalSalarySum += total;
                totalNetSum += (total - deduct);

                const dbData = dbEmployees.get(emp.name);
                const empId = dbData ? dbData.id : null;

                const ot_hours = h.work_ot_9_10 + h.work_ot_11_12 + h.hol_ot_0_2 + h.hol_ot_3_8 + h.hol_ot_9_10 + h.nat_ot_0_8 + h.nat_ot_9_10;
                const ot_trans_hours = h.trans_work_9_10 + h.trans_work_11_12 + h.trans_hol_0_2 + h.trans_hol_3_8 + h.trans_hol_9_10 + h.trans_nat;

                return {
                    "ç·¨è™Ÿ": emp.id, "å§“å": emp.name, "empId": empId,
                    "æŠ•ä¿ç´šè·": ins_level, "åŠ ç­è²»åŸºæ•¸": ot_base, "æœ¬æœˆè–ªè³‡": total, "å¯¦é ˜è–ªè³‡": total-deduct,
                    "å·¥æ™‚ç¸½è¨ˆ": total_work_hours, "è½‰å ´ç¸½è¨ˆ": total_trans_hours,
                    "å‹é€€ææ’¥": pension_employer, "å‹é€€è‡ªæ": pension_self, "è‡ªæè¶´æ•¸": pension_rate,
                    "æœ¬æœˆå·¥æ™‚": h.work_day, 
                    "å¹³åŠ (9-10)æ™‚": h.work_ot_9_10, "å¹³åŠ (11-12)æ™‚": h.work_ot_11_12,
                    "ä¼‘åŠ (0-2)æ™‚": h.hol_ot_0_2, "ä¼‘åŠ (3-8)æ™‚": h.hol_ot_3_8, "ä¼‘åŠ (9-10)æ™‚": h.hol_ot_9_10,
                    "åœ‹åŠ (0-8)æ™‚": h.nat_ot_0_8, "åœ‹åŠ (9-10)æ™‚": h.nat_ot_9_10,
                    "è½‰å ´å·¥æ™‚": h.trans_work, 
                    "å¹³è½‰(9-10)æ™‚": h.trans_work_9_10, "å¹³è½‰(11-12)æ™‚": h.trans_work_11_12,
                    "ä¼‘è½‰(0-2)æ™‚": h.trans_hol_0_2, "ä¼‘è½‰(3-8)æ™‚": h.trans_hol_3_8, "ä¼‘è½‰(9-10)æ™‚": h.trans_hol_9_10, "åœ‹è½‰å·¥æ™‚": h.trans_nat,
                    "æœ¬è–ª": base, "å·¥ä½œæ—¥åŠ ç­è²»": pay.wot, "ä¼‘å‡æ—¥åŠ ç­è²»": pay.hot, "åœ‹å®šåŠ ç­è²»": pay.not,
                    "è½‰å ´è²»": pay.trans, "ä¼‘å‡è½‰å ´è²»": pay.htrans, "åœ‹å®šè½‰å ´è²»": pay.ntrans,
                    "AA11": emp.aaAmt, "AA05": emp.aa05Amt, "AA06": emp.aa06Amt,
                    "ä¸™è­‰åŠ çµ¦": final_license, 
                    "åé„‰åŠ çµ¦": emp.subAmt, "äº¤é€šåŠ çµ¦": emp.subAmt,
                    "æŠ€èƒ½å¼·åŒ–çå‹µé‡‘": m.skill,
                    "ç”Ÿæ—¥ç¦®é‡‘": m.birthday, "æœå‹™çé‡‘": m.service, "æœƒè­°å‡ºå¸­": m.meeting, "ä¸­ç§‹ç«¯åˆ": m.festival, "å…¶ä»–": m.other,
                    "å…¶ä»–æ‰£æ¬¾": m.other_deduct,
                    "ç‰¹ä¼‘": leave_special_amt, "å–ªå‡": leave_funeral_amt, "æ­²æ™‚ç¥­å„€": leave_ritual_amt,
                    "å‹ä¿è²»": val(s,IDX.s.labor), "å¥ä¿è²»": val(s,IDX.s.health), "å¥ä¿è²»(çœ·å±¬)": val(s,IDX.s.health_dep), "ä»£æ‰£ç¸½è¨ˆ": deduct,
                    "å€‹äººå‚™è¨»": note,
                    "æ­¸æª”_åŠ ç­å·¥æ™‚": ot_hours,
                    "æ­¸æª”_åŠ ç­è½‰å ´": ot_trans_hours
                };
            });

            document.getElementById('total-salary-sum').innerText = fmt(totalSalarySum);
            document.getElementById('total-net-sum').innerText = fmt(totalNetSum);

            const keys = Object.keys(results[0]).filter(k => !k.startsWith("æ­¸æª”_") && k !== "empId");
            document.getElementById('thead-result').innerHTML = keys.map(k=>`<th class="sys-th">${k}</th>`).join('');
            document.getElementById('tbody-result').innerHTML = results.map(r=>`<tr>${keys.map(k=>`<td class="sys-td">${typeof r[k]==='number'?fmt(r[k]):r[k]}</td>`).join('')}</tr>`).join('');
            
            empMap.clear();
            const sel = document.getElementById('sel-emp');
            const currentSel = sel.value;
            sel.innerHTML = '<option>è«‹é¸æ“‡å“¡å·¥...</option>';
            results.forEach(r => { empMap.set(r.å§“å, r); sel.add(new Option(`${r.ç·¨è™Ÿ} ${r.å§“å}`, r.å§“å)); });
            
            if(currentSel && empMap.has(currentSel)) {
                sel.value = currentSel;
                renderPreview();
            }
        }

        async function archiveData() {
            const month = document.getElementById('archive-month').value;
            if(!month) return alert("è«‹é¸æ“‡æ­¸æª”æœˆä»½ï¼");
            
            // â˜… NaN æª¢æŸ¥ï¼šç¢ºä¿æ•¸æ“šæ­£å¸¸æ‰å‡†æ­¸æª”
            const hasNaN = results.some(r => isNaN(r['å¯¦é ˜è–ªè³‡']) || isNaN(r['æœ¬æœˆè–ªè³‡']));
            if(hasNaN) {
                return alert("âŒ éŒ¯èª¤ï¼šåµæ¸¬åˆ°æ•¸å€¼ç•°å¸¸ (NaN)ï¼Œè«‹å…ˆæª¢æŸ¥ Excel æˆ–åƒæ•¸æ˜¯å¦æ­£ç¢ºï¼");
            }

            if(!confirm(`ç¢ºå®šè¦å°‡ ${month} çš„è–ªè³‡è³‡æ–™å¯«å…¥è³‡æ–™åº«å—ï¼Ÿ`)) return;

            const btn = document.querySelector('button[onclick="window.archiveData()"]');
            const oldText = btn.innerHTML;
            btn.innerText = "â³ å¯«å…¥ä¸­...";
            btn.disabled = true;

            try {
                let count = 0;
                for(let r of results) {
                    if(!r.empId) continue; 

                    const q = query(collection(db, "monthly_records"), 
                        where("empId", "==", r.empId), 
                        where("yearMonth", "==", month));
                    const snap = await getDocs(q);

                    // â˜… æœƒè¨ˆæ­¸æª”çµæ§‹
                    const finalResult = {
                        grossSalary: r['æœ¬æœˆè–ªè³‡'],
                        netSalary: r['å¯¦é ˜è–ªè³‡'],
                        employerPension: r['å‹é€€ææ’¥'],
                        employeePension: r['å‹é€€è‡ªæ'],
                        totalDeduction: r['ä»£æ‰£ç¸½è¨ˆ'],
                        calculatedAt: new Date().toISOString()
                    };

                    const data = {
                        empId: r.empId,
                        yearMonth: month,
                        salary: r['æœ¬æœˆè–ªè³‡'], 
                        workHours: r['æœ¬æœˆå·¥æ™‚'],
                        transitHours: r['è½‰å ´å·¥æ™‚'],
                        otWorkHours: r['æ­¸æª”_åŠ ç­å·¥æ™‚'], 
                        otTransitHours: r['æ­¸æª”_åŠ ç­è½‰å ´'],
                        totalBaseHours: parseFloat((r['æœ¬æœˆå·¥æ™‚'] + r['è½‰å ´å·¥æ™‚']).toFixed(2)),
                        finalResult: finalResult, 
                        updatedAt: new Date().toISOString()
                    };

                    if(!snap.empty) {
                        await updateDoc(doc(db, "monthly_records", snap.docs[0].id), data);
                    } else {
                        await addDoc(collection(db, "monthly_records"), { ...data, createdAt: new Date().toISOString() });
                    }
                    count++;
                }
                alert(`âœ… æˆåŠŸæ­¸æª” ${count} ç­†è³‡æ–™ (å«æœƒè¨ˆæ•¸æ“š)ï¼`);

            } catch(e) {
                console.error(e);
                alert("âŒ æ­¸æª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™");
            } finally {
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        async function deleteArchivedData() {
            const month = document.getElementById('archive-month').value;
            if(!month) return alert("è«‹é¸æ“‡è¦åˆªé™¤çš„æœˆä»½ï¼");
            
            if(!confirm(`âš ï¸ å±éšªæ“ä½œï¼\nç¢ºå®šè¦åˆªé™¤ [${month}] æ‰€æœ‰å·²æ­¸æª”çš„è³‡æ–™å—ï¼Ÿ`)) return;

            const btn = document.querySelector('button[onclick="window.deleteArchivedData()"]');
            const oldText = btn.innerHTML;
            btn.innerText = "â³ åˆªé™¤ä¸­...";
            btn.disabled = true;

            try {
                const q = query(collection(db, "monthly_records"), where("yearMonth", "==", month));
                const querySnapshot = await getDocs(q);

                if(querySnapshot.empty) {
                    alert("æŸ¥ç„¡è©²æœˆä»½çš„æ­¸æª”è³‡æ–™ï¼Œç„¡éœ€åˆªé™¤ã€‚");
                    btn.innerHTML = oldText;
                    btn.disabled = false;
                    return;
                }

                const batch = writeBatch(db);
                let count = 0;
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                    count++;
                });

                await batch.commit();
                alert(`âœ… å·²æˆåŠŸåˆªé™¤ ${count} ç­†æ­¸æª”ç´€éŒ„ã€‚`);

            } catch(e) {
                console.error(e);
                alert("âŒ åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™");
            } finally {
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        function exportCSV() {
            const ws = XLSX.utils.json_to_sheet(results);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è–ªè³‡çµæœ");
            XLSX.writeFile(wb, "è–ªè³‡è¨ˆç®—çµæœ.csv");
        }

        const target = document.getElementById('payslip-entity');

        function renderPreview() {
            const name = document.getElementById('sel-emp').value;
            const globalNote = document.getElementById('custom-note').value;
            
            if(!name || name==='è«‹é¸æ“‡å“¡å·¥...') return;

            const d = empMap.get(name);
            const el = document.getElementById('payslip-entity');
            
            el.querySelectorAll('[data-k]').forEach(dom => {
                const k = dom.getAttribute('data-k');
                if(d[k]!==undefined) dom.textContent = typeof d[k]==='number' ? fmt(d[k]) : d[k];
            });

            let footerHtml = '';
            if (d['å€‹äººå‚™è¨»']) footerHtml += `<div class="footer-section"><span class="badge badge-personal">[å€‹äºº]</span>${d['å€‹äººå‚™è¨»']}</div>`;
            if (globalNote) footerHtml += `<div class="footer-section"><span class="badge badge-public">[å…¬å‘Š]</span>${globalNote.replace(/\n/g, '<br>')}</div>`;
            document.getElementById('footer-note').innerHTML = footerHtml;
        }

        async function captureAndSave(filename, saveZip=false) {
            const element = document.getElementById('payslip-entity');
            const viewport = document.getElementById('preview-scaler');
            const originalTransform = viewport.style.transform;
            viewport.style.transform = 'none'; 
            
            await document.fonts.ready;
            const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false, windowWidth: 794 });
            viewport.style.transform = originalTransform;

            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const pdf = new jsPDF('p', 'mm', 'a4');
            pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            
            if(saveZip) return pdf.output('blob');
            else pdf.save(filename);
        }

        async function downloadCurrentPDF() {
            const name = document.getElementById('sel-emp').value;
            if(!name || name==='è«‹é¸æ“‡å“¡å·¥...') return alert("è«‹å…ˆé¸æ“‡å“¡å·¥");
            const btn = document.querySelector('button[onclick="window.downloadCurrentPDF()"]');
            const oldTxt = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = "â³";
            await captureAndSave(`${name}_è–ªè³‡å–®.pdf`);
            btn.disabled = false; btn.innerHTML = oldTxt;
        }

        async function downloadCurrentJPG() {
            const name = document.getElementById('sel-emp').value;
            if(!name || name==='è«‹é¸æ“‡å“¡å·¥...') return alert("è«‹å…ˆé¸æ“‡å“¡å·¥");
            const element = document.getElementById('payslip-entity');
            const viewport = document.getElementById('preview-scaler');
            const originalTransform = viewport.style.transform;
            viewport.style.transform = 'none';
            const canvas = await html2canvas(element, { scale: 2 });
            viewport.style.transform = originalTransform;
            canvas.toBlob(blob => saveAs(blob, `${name}_è–ªè³‡å–®.jpg`));
        }

        async function batchProcessJPG() {
            const btn = document.getElementById('btn-batch-jpg');
            const box = document.getElementById('progress-box');
            const bar = document.getElementById('p-bar');
            const txt = document.getElementById('p-text');
            const sel = document.getElementById('sel-emp');

            btn.disabled = true;
            box.classList.remove('hidden');
            const zip = new JSZip();

            for(let i=0; i<results.length; i++) {
                const emp = results[i];
                sel.value = emp.å§“å;
                renderPreview(); 
                txt.innerText = `æ­£åœ¨è™•ç†ï¼š${emp.å§“å} (${i+1}/${results.length})`;
                bar.style.width = `${Math.round((i+1)/results.length*100)}%`;
                await new Promise(r => setTimeout(r, 100));

                const element = document.getElementById('payslip-entity');
                const viewport = document.getElementById('preview-scaler');
                const originalTransform = viewport.style.transform;
                viewport.style.transform = 'none'; 
                await document.fonts.ready;
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false, windowWidth: 794 });
                viewport.style.transform = originalTransform;

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const base64Data = imgData.replace(/^data:image\/(png|jpeg);base64,/, "");
                zip.file(`${emp.å§“å}_è–ªè³‡å–®.jpg`, base64Data, {base64: true});
            }

            txt.innerText = "æ­£åœ¨å£“ç¸®åœ–æª”...";
            const content = await zip.generateAsync({type:"blob"});
            const datePrefix = currentDateLabel.replace(" è–ªè³‡å–®", "") || "è–ªè³‡å–®";
            saveAs(content, `${datePrefix}_å…¨å“¡è–ªè³‡å–®_åœ–ç‰‡åŒ….zip`);
            txt.innerText = "å®Œæˆï¼";
            btn.disabled = false;
        }

        async function batchProcess() {
            const btn = document.getElementById('btn-batch');
            const box = document.getElementById('progress-box');
            const bar = document.getElementById('p-bar');
            const txt = document.getElementById('p-text');
            const sel = document.getElementById('sel-emp');

            btn.disabled = true;
            box.classList.remove('hidden');
            const zip = new JSZip();

            for(let i=0; i<results.length; i++) {
                const emp = results[i];
                document.getElementById('sel-emp').value = emp.å§“å;
                renderPreview();
                txt.innerText = `æ­£åœ¨éŒ„è£½ï¼š${emp.å§“å} (${i+1}/${results.length})`;
                bar.style.width = `${Math.round((i+1)/results.length*100)}%`;
                await new Promise(r => setTimeout(r, 100));
                const blob = await captureAndSave(`${emp.å§“å}.pdf`, true);
                zip.file(`${emp.å§“å}_è–ªè³‡å–®.pdf`, blob);
            }

            txt.innerText = "æ­£åœ¨å£“ç¸®...";
            const content = await zip.generateAsync({type:"blob"});
            const datePrefix = currentDateLabel.replace(" è–ªè³‡å–®", "") || "è–ªè³‡å–®";
            saveAs(content, `${datePrefix}_å…¨å“¡è–ªè³‡å–®.zip`);
            txt.innerText = "å®Œæˆï¼";
            btn.disabled = false;
        }
    </script>
</body>
</html>