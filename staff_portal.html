<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å…‰ç¥ERP">
    <meta name="theme-color" content="#2563eb">
    
    <title>è¡Œæ”¿äººå“¡å…¥å£ç¶²ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; } 
        .btn-press:active { transform: scale(0.95); transition: transform 0.1s; }
        .modal { transition: opacity 0.25s ease; }
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .tab-inactive { color: #94a3b8; }
        .status-late { background-color: #fffbeb; border-color: #fcd34d; color: #b45309; } 
        .status-done { background-color: #f3f4f6; border-color: #e5e7eb; color: #9ca3af; pointer-events: none; }
        ::-webkit-scrollbar { display: none; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, deleteDoc, doc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let todayAttendance = null;
        let currentTab = 'my'; 
        let systemSettings = { allowedProxies: [], workStartTime: "08:30", workEndTime: "17:30", clockBuffer: 5 };
        let todayLeaves = []; // ç™½åå–® (å«å¯©æ ¸ä¸­)
        let currentLocationType = 'office'; 

        window.loginAs = loginAs;
        window.logout = logout;
        window.clockIn = clockIn;
        window.clockOut = clockOut;
        window.sendCorrectionRequest = sendCorrectionRequest; 
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.submitLeave = submitLeave;
        window.submitOvertime = submitOvertime;
        window.deleteRequest = deleteRequest;
        window.switchRequestTab = switchRequestTab;
        window.switchLocation = switchLocation;
        window.checkPeriodAutoFill = checkPeriodAutoFill;

        // 1. è‡ªå‹•ç™»å…¥
        (function() {
            const localUser = localStorage.getItem('kuangyou_user_persistent');
            if (localUser) {
                try { currentUser = JSON.parse(localUser); setTimeout(() => doLoginSuccess(), 100); } 
                catch(e) { localStorage.removeItem('kuangyou_user_persistent'); }
            }
        })();

        onSnapshot(doc(db, "system_settings", "config"), (docSnap) => {
            if(docSnap.exists()) {
                systemSettings = { ...systemSettings, ...docSnap.data() };
                if(currentUser) { checkPermissionAndTabs(); updateClockUI(); }
            }
        });

        // 2. ç™»å…¥
        async function loginAs() {
            const code = document.getElementById('login-code').value.trim();
            const pwd = document.getElementById('login-password').value.trim();
            const remember = document.getElementById('remember-me').checked;

            if(!code || !pwd) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");

            try {
                const q = query(collection(db, "employees"), where("code", "==", code));
                const snapshot = await getDocs(q);
                if (snapshot.empty) return alert("âŒ æ‰¾ä¸åˆ°æ­¤å“¡å·¥");
                const userDoc = snapshot.docs[0];
                const userData = userDoc.data();

                if (userData.role !== 'admin') return alert("â›” æ¬Šé™ä¸è¶³");
                if (userData.resignDate) return alert("â›” æ­¤å¸³è™Ÿå·²é›¢è·");

                if (userData.password === pwd) {
                    currentUser = { id: userDoc.id, name: userData.name, role: userData.role };
                    if (remember) localStorage.setItem('kuangyou_user_persistent', JSON.stringify(currentUser));
                    else sessionStorage.setItem('kuangyou_user_temp', JSON.stringify(currentUser));
                    doLoginSuccess();
                } else { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
            } catch (e) { alert("ç™»å…¥å¤±æ•—"); }
        }

        function doLoginSuccess() {
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('main-panel').classList.remove('hidden');
            document.getElementById('welcome-name').innerText = currentUser.name;
            checkPermissionAndTabs();
            loadBalances();      
            loadTodayLeaves(); // â˜… æ”¹åï¼šè®€å–ä»Šæ—¥æ‰€æœ‰å‡å–®
            loadTodayAttendance();
            loadRequests();
            setInterval(updateClockUI, 1000);
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('kuangyou_user_persistent');
                location.reload();
            }
        }

        function checkPermissionAndTabs() {
            const hasProxy = systemSettings.allowedProxies?.includes(currentUser.id);
            const proxyTab = document.getElementById('tab-proxy');
            if (hasProxy) proxyTab.classList.remove('hidden');
            else { proxyTab.classList.add('hidden'); if(currentTab === 'proxy') switchRequestTab('my'); }
        }

        function loadBalances() {
            const q = query(collection(db, "leave_ledger"), where("empId", "==", currentUser.id));
            onSnapshot(q, (snap) => {
                let annual = 0; 
                let comp = 0;   
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.remaining > 0) {
                        if(d.sourceType && d.sourceType.includes("è£œä¼‘")) comp += d.remaining;
                        else annual += d.remaining; 
                    }
                });
                document.getElementById('bal-annual').innerText = annual + " H";
                document.getElementById('bal-comp').innerText = comp + " H";
            });
        }

        // â˜… ä¿®æ”¹ï¼šè®€å–ä»Šæ—¥å‡å–® (å« Pending & Approved)
        function loadTodayLeaves() {
            const today = dayjs().format('YYYY-MM-DD');
            // ç§»é™¤ status ç¯©é¸ï¼ŒæŠ“å–æ‰€æœ‰é¡åˆ¥ç‚º leave çš„å–®
            const q = query(collection(db, "requests"), 
                where("empId", "==", currentUser.id), 
                where("date", "==", today),
                where("category", "==", "leave")
            );
            onSnapshot(q, (snap) => {
                todayLeaves = [];
                snap.forEach(doc => todayLeaves.push(doc.data()));
                updateClockUI(); 
            });
        }

        function switchLocation(type) {
            currentLocationType = type;
            document.getElementById('btn-loc-office').className = type === 'office' ? 'flex-1 py-1 text-center bg-blue-600 text-white rounded-lg text-sm font-bold transition shadow' : 'flex-1 py-1 text-center text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold transition';
            document.getElementById('btn-loc-field').className = type === 'field' ? 'flex-1 py-1 text-center bg-purple-600 text-white rounded-lg text-sm font-bold transition shadow' : 'flex-1 py-1 text-center text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold transition';
            
            const noteInput = document.getElementById('location-note');
            if (type === 'field') {
                noteInput.classList.remove('hidden');
                noteInput.focus();
            } else {
                noteInput.classList.add('hidden');
            }
        }

        function checkPeriodAutoFill() {
            const period = document.getElementById('leave-period').value;
            const hoursInput = document.getElementById('leave-hours');
            if (period === 'full') {
                hoursInput.value = 8;
                hoursInput.disabled = true;
                hoursInput.classList.add('bg-gray-100');
            } else {
                hoursInput.disabled = false;
                hoursInput.classList.remove('bg-gray-100');
                if (hoursInput.value == 8) hoursInput.value = ''; 
            }
        }

        // 3. æ‰“å¡ UI é‚è¼¯ (â˜… ä¿®æ”¹ï¼šç™½åå–®åŒ…å« Pending)
        function loadTodayAttendance() {
            const todayStr = dayjs().format('YYYY-MM-DD');
            const q = query(collection(db, "attendance"), where("empId", "==", currentUser.id), where("date", "==", todayStr));
            onSnapshot(q, (snap) => {
                todayAttendance = !snap.empty ? { id: snap.docs[0].id, ...snap.docs[0].data() } : null;
                updateClockUI();
            });
        }

        function updateClockUI() {
            const now = dayjs();
            const todayStr = now.format('YYYY-MM-DD');
            const startLimit = dayjs(`${todayStr} ${systemSettings.workStartTime}`).add(systemSettings.clockBuffer, 'minute');
            const endLimit = dayjs(`${todayStr} ${systemSettings.workEndTime}`);

            // â˜… ä¿®æ”¹ï¼šç™½åå–®åˆ¤å®š (æ¥å— Approved æˆ– Pending)
            const exemptStart = todayLeaves.some(r => 
                (r.status === 'approved' || r.status === 'pending') && 
                (r.period === 'start' || r.period === 'full')
            );
            const exemptEnd = todayLeaves.some(r => 
                (r.status === 'approved' || r.status === 'pending') && 
                (r.period === 'end' || r.period === 'full')
            );

            // æç¤ºæ–‡å­—
            const startText = exemptStart ? `<div class="text-[10px] text-blue-200 mt-1">âœ¨ å·²ç”³è«‹è«‹å‡ (å…è¨±æ‰“å¡)</div>` : "";
            const endText = exemptEnd ? `<div class="text-[10px] text-blue-200 mt-1">âœ¨ å·²ç”³è«‹è«‹å‡ (å…è¨±æ‰“å¡)</div>` : "";

            // ä¸Šç­æŒ‰éˆ•
            const inBtn = document.getElementById('btn-clock-in');
            if (todayAttendance && todayAttendance.inTime) {
                inBtn.className = "p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 border-b-4 h-32 transition status-done";
                inBtn.innerHTML = `<span class="text-3xl grayscale">ğŸŒ</span><div class="font-bold text-slate-500">å·²ç°½åˆ° ${todayAttendance.inTime}</div><div class="text-[10px] text-slate-400">${todayAttendance.location || 'å…¬å¸'}</div>`;
                inBtn.onclick = null;
            } else {
                // é²åˆ°ä¸”ç„¡è±å… -> è£œç™»
                if (now.isAfter(startLimit) && !exemptStart) {
                    inBtn.className = "p-4 rounded-2xl shadow-md flex flex-col items-center justify-center gap-2 border-b-4 h-32 transition cursor-pointer status-late btn-press";
                    inBtn.innerHTML = `<span class="text-3xl">âš ï¸</span><span class="font-bold">ç”³è«‹è£œç™»</span><span class="text-[10px]">å·²éä¸Šç­æ™‚é–“</span>`;
                    inBtn.onclick = () => sendCorrectionRequest('ä¸Šç­', todayStr, now.format('HH:mm'));
                } else {
                    // æ­£å¸¸ æˆ– æœ‰è±å… -> è—è‰²æ‰“å¡
                    inBtn.className = "bg-blue-500 p-4 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-2 btn-press border-b-4 border-blue-700 h-32 cursor-pointer transition text-white";
                    inBtn.innerHTML = `<span class="text-4xl">ğŸŒ</span><span class="font-bold">ä¸Šç­æ‰“å¡</span>${startText}`;
                    inBtn.onclick = clockIn;
                }
            }

            // ä¸‹ç­æŒ‰éˆ•
            const outBtn = document.getElementById('btn-clock-out');
            if (todayAttendance && todayAttendance.outTime) {
                outBtn.className = "p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 border-b-4 h-32 transition status-done";
                outBtn.innerHTML = `<span class="text-3xl grayscale">ğŸŒ™</span><div class="font-bold text-slate-500">å·²ç°½é€€ ${todayAttendance.outTime}</div><div class="text-[10px] text-slate-400">${todayAttendance.locationOut || todayAttendance.location || 'å…¬å¸'}</div>`;
                outBtn.onclick = null;
            } else {
                // æ—©é€€ä¸”ç„¡è±å… -> è£œç™»
                if (now.isBefore(endLimit) && !exemptEnd) {
                    outBtn.className = "p-4 rounded-2xl shadow-md flex flex-col items-center justify-center gap-2 border-b-4 h-32 transition cursor-pointer status-late btn-press";
                    outBtn.innerHTML = `<span class="text-3xl">âš ï¸</span><span class="font-bold">ç”³è«‹è£œç™»</span><span class="text-[10px]">å°šæœªåˆ°ä¸‹ç­æ™‚é–“</span>`;
                    outBtn.onclick = () => sendCorrectionRequest('ä¸‹ç­', todayStr, now.format('HH:mm'));
                } else {
                    outBtn.className = "bg-slate-700 p-4 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-2 btn-press border-b-4 border-slate-900 h-32 cursor-pointer transition text-white";
                    outBtn.innerHTML = `<span class="text-4xl">ğŸŒ™</span><span class="font-bold">ä¸‹ç­æ‰“å¡</span>${endText}`;
                    outBtn.onclick = clockOut;
                }
            }
        }

        function getLocationData() {
            if (currentLocationType === 'office') return "ğŸ¢ å…¬å¸";
            const note = document.getElementById('location-note').value.trim();
            if (!note) {
                alert("ğŸš— å¤–å‹¤æ¨¡å¼è«‹å‹™å¿…å¡«å¯«ã€Œåœ°é»ã€æˆ–ã€Œæ¡ˆä¸»åç¨±ã€ï¼");
                document.getElementById('location-note').focus();
                return null;
            }
            return `ğŸš— ${note}`;
        }

        async function clockIn() {
            const loc = getLocationData(); if (!loc) return;
            const now = dayjs();
            try { 
                await addDoc(collection(db, "attendance"), { 
                    empId: currentUser.id, name: currentUser.name, date: now.format('YYYY-MM-DD'), 
                    inTime: now.format('HH:mm'), outTime: null, location: loc, timestamp: new Date().toISOString() 
                }); 
                alert(`âœ… ä¸Šç­æ‰“å¡æˆåŠŸï¼\nåœ°é»ï¼š${loc}`); 
                document.getElementById('location-note').value = ""; 
            } catch(e) { alert("æ‰“å¡å¤±æ•—"); }
        }

        async function clockOut() { 
            const loc = getLocationData(); if (!loc) return;
            if(!todayAttendance) return alert("âŒ ç„¡ä¸Šç­ç´€éŒ„ï¼Œè«‹ç”³è«‹è£œç™»ã€‚");
            try {
                await updateDoc(doc(db, "attendance", todayAttendance.id), {
                    outTime: dayjs().format('HH:mm'), locationOut: loc, updatedAt: new Date().toISOString()
                });
                alert(`âœ… ä¸‹ç­æ‰“å¡æˆåŠŸï¼\nåœ°é»ï¼š${loc}`);
                document.getElementById('location-note').value = "";
            } catch(e) { alert("ç°½é€€å¤±æ•—"); }
        }

        async function sendCorrectionRequest(type, date, time) {
            if (type === 'ä¸‹ç­') {
                if(confirm("æ‚¨ç¾åœ¨æ˜¯ã€Œæ—©é€€ã€å—ï¼Ÿ\n\næŒ‰ã€Œç¢ºå®šã€å¡«å¯«è«‹å‡å–® (ç³»çµ±å»ºè­°)ã€‚\næŒ‰ã€Œå–æ¶ˆã€ç™¼é€è£œç™»ç”³è«‹ (å¿˜è¨˜æ‰“å¡)ã€‚")) {
                    openModal('modal-leave');
                    document.getElementById('leave-period').value = 'end';
                    return;
                }
            }
            
            if(!confirm(`âš ï¸ ç¢ºå®šç™¼é€ã€Œ${type}è£œç™»ã€çµ¦ç®¡ç†å“¡ï¼Ÿ`)) return;
            try {
                await addDoc(collection(db, "requests"), {
                    empId: currentUser.id, name: currentUser.name, category: "correction",
                    type, date, time, hours: 0, note: `é€¾æ™‚è«‹æ±‚è£œç™»`, status: "pending", createdAt: new Date().toISOString(), createdBy: currentUser.id
                });
                alert("å·²é€å‡ºç”³è«‹");
            } catch(e) { alert("å¤±æ•—"); }
        }

        async function submitLeave() {
            const date = document.getElementById('leave-date').value; 
            const type = document.getElementById('leave-type').value; 
            const period = document.getElementById('leave-period').value; 
            let hours = parseFloat(document.getElementById('leave-hours').value); 
            const note = document.getElementById('leave-note').value;

            if(!date || !hours || !period) return alert("è«‹å¡«å¯«å®Œæ•´");
            if (hours % 0.5 !== 0) return alert("âŒ è«‹å‡æ™‚æ•¸å¿…é ˆæ˜¯ 0.5 çš„å€æ•¸");

            try { 
                await addDoc(collection(db, "requests"), { 
                    empId: currentUser.id, name: currentUser.name, category: "leave", 
                    type, date, hours, period, note, 
                    status: "pending", createdBy: currentUser.id, createdAt: new Date().toISOString() 
                }); 
                closeModal('modal-leave'); alert("å·²é€å‡ºï¼Œè«‹ç­‰å¾…ç³»çµ±æ›´æ–°ç‹€æ…‹å¾Œå³å¯æ‰“å¡ã€‚"); loadRequests(); 
            } catch(e) { alert("å¤±æ•—"); }
        }

        async function submitOvertime() {
            const date = document.getElementById('ot-date').value; 
            const hours = parseFloat(document.getElementById('ot-hours').value); 
            const note = document.getElementById('ot-note').value;
            if(!date || !hours) return alert("è«‹å¡«å¯«å®Œæ•´");
            if (hours % 0.5 !== 0) return alert("âŒ åŠ ç­æ™‚æ•¸å¿…é ˆæ˜¯ 0.5 çš„å€æ•¸");

            try { await addDoc(collection(db, "requests"), { empId: currentUser.id, name: currentUser.name, category: "overtime", date, hours, note, status: "pending", createdBy: currentUser.id, createdAt: new Date().toISOString() }); closeModal('modal-ot'); alert("å·²é€å‡º"); loadRequests(); } catch(e) { alert("å¤±æ•—"); }
        }

        function switchRequestTab(tab) {
            currentTab = tab;
            document.getElementById('tab-my').className = tab === 'my' ? 'flex-1 text-center py-2 font-bold cursor-pointer tab-active' : 'flex-1 text-center py-2 font-bold cursor-pointer tab-inactive hover:bg-slate-100';
            document.getElementById('tab-proxy').className = tab === 'proxy' ? 'flex-1 text-center py-2 font-bold cursor-pointer tab-active' : 'flex-1 text-center py-2 font-bold cursor-pointer tab-inactive hover:bg-slate-100';
            loadRequests();
        }
        function loadRequests() {
            let q = currentTab === 'my' ? query(collection(db, "requests"), where("empId", "==", currentUser.id)) : query(collection(db, "requests"), where("createdBy", "==", currentUser.id));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('request-list'); list.innerHTML = "";
                let records = []; snap.forEach(d => records.push({id: d.id, ...d.data()}));
                records.sort((a,b)=>dayjs(b.createdAt).unix()-dayjs(a.createdAt).unix());
                if(records.length===0) { list.innerHTML = `<div class="text-center text-gray-400 py-10 bg-white rounded-xl border border-dashed border-gray-300">å°šç„¡ç´€éŒ„</div>`; return; }
                records.forEach(r => {
                    let badge = r.status === 'pending' ? 'â³' : (r.status === 'approved' ? 'âœ…' : 'ğŸš«');
                    let periodText = r.period === 'start' ? '(ä¸Šç­æ®µ)' : (r.period === 'end' ? '(ä¸‹ç­æ®µ)' : (r.period === 'full' ? '(æ•´æ—¥)' : ''));
                    let title = r.category === 'correction' ? `è£œç™»: ${r.type}` : (r.category === 'leave' ? `è«‹å‡: ${r.type} ${periodText}` : 'åŠ ç­');
                    
                    list.innerHTML += `<div class="p-4 rounded-xl shadow-sm border mb-3 bg-white"><div class="flex justify-between font-bold text-slate-800"><div>${title}</div><div>${badge}</div></div><div class="text-xs text-slate-500 mt-1">${r.date} ${r.time||''} / ${r.hours||0}H</div><div class="text-xs text-slate-400">${r.note||''}</div>${r.status==='rejected'?`<div class="text-xs text-red-500 mt-1 border-t pt-1">é§å›: ${r.rejectReason}</div>`:''}<button onclick="deleteRequest('${r.id}')" class="text-red-300 text-xs mt-2 w-full text-right">åˆªé™¤</button></div>`;
                });
            });
        }
        async function deleteRequest(id) { if(confirm("åˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db,"requests",id)); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        setInterval(() => { document.getElementById('clock-display').innerText = dayjs().format('HH:mm:ss'); document.getElementById('date-display').innerText = dayjs().format('YYYYå¹´MMæœˆDDæ—¥ dddd'); }, 1000);
    </script>
</head>
<body class="flex flex-col h-screen">
    <div id="login-panel" class="absolute inset-0 bg-slate-800 z-50 flex flex-col items-center justify-center p-6">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl text-center">
            <h1 class="text-xl font-bold text-slate-800 mb-4">è¡Œæ”¿äººå“¡å…¥å£</h1>
            <input type="text" id="login-code" class="w-full p-3 border rounded-lg mb-3" placeholder="å“¡å·¥ç·¨è™Ÿ">
            <input type="password" id="login-password" class="w-full p-3 border rounded-lg mb-3" placeholder="å¯†ç¢¼">
            <label class="flex items-center gap-2 mb-6 cursor-pointer justify-center"><input type="checkbox" id="remember-me" class="w-4 h-4"><span class="text-sm text-slate-600">ä¿æŒç™»å…¥</span></label>
            <button onclick="loginAs()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg">ç™»å…¥</button>
        </div>
    </div>

    <div id="main-panel" class="flex-1 flex flex-col hidden overflow-hidden">
        <div class="bg-white p-4 pb-4 border-b shadow-sm relative z-10">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2"><div class="bg-blue-100 p-2 rounded-full text-blue-600 font-bold">ğŸ‘¤</div><div class="text-lg font-bold text-slate-800" id="welcome-name">---</div></div>
                <button onclick="logout()" class="text-slate-400 text-xs border px-2 py-1 rounded">ç™»å‡º</button>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-2">
                <div class="bg-blue-50 p-2 rounded-lg text-center border border-blue-100"><div class="text-xs text-blue-400 font-bold">ç‰¹ä¼‘é¤˜é¡</div><div id="bal-annual" class="text-xl font-black text-blue-600">0 H</div></div>
                <div class="bg-purple-50 p-2 rounded-lg text-center border border-purple-100"><div class="text-xs text-purple-400 font-bold">è£œä¼‘é¤˜é¡</div><div id="bal-comp" class="text-xl font-black text-purple-600">0 H</div></div>
            </div>
            <div class="text-center"><div id="clock-display" class="text-3xl font-mono font-black text-slate-700">00:00:00</div><div id="date-display" class="text-xs text-slate-400">----/--/--</div></div>
        </div>

        <div class="p-4 bg-slate-100 shrink-0">
            <div class="bg-white p-1 rounded-xl flex mb-3 shadow-sm">
                <button id="btn-loc-office" onclick="switchLocation('office')" class="flex-1 py-1 text-center bg-blue-600 text-white rounded-lg text-sm font-bold transition shadow">ğŸ¢ å…¬å¸å…§</button>
                <button id="btn-loc-field" onclick="switchLocation('field')" class="flex-1 py-1 text-center text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold transition">ğŸš— å¤–å‹¤/å¤–è¨ª</button>
            </div>
            <input type="text" id="location-note" class="hidden w-full p-2 mb-3 border-2 border-purple-200 bg-white rounded-lg text-sm focus:outline-none focus:border-purple-500" placeholder="è«‹è¼¸å…¥å¤–è¨ªåœ°é»æˆ–æ¡ˆä¸» (å¿…å¡«)">

            <div class="grid grid-cols-2 gap-3">
                <div id="btn-clock-in" class="bg-white p-4 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-1 h-28 border-b-4 border-blue-100"></div>
                <div id="btn-clock-out" class="bg-white p-4 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-1 h-28 border-b-4 border-slate-100"></div>
            </div>
        </div>

        <div class="px-4 mt-2 grid grid-cols-2 gap-3 shrink-0">
            <button onclick="openModal('modal-ot')" class="bg-orange-50 p-3 rounded-xl border border-orange-100 text-orange-700 font-bold text-sm">âš¡ ç”³è«‹åŠ ç­</button>
            <button onclick="openModal('modal-leave')" class="bg-green-50 p-3 rounded-xl border border-green-100 text-green-700 font-bold text-sm">ğŸŒ´ ç”³è«‹è«‹å‡</button>
        </div>

        <div class="flex-1 overflow-y-auto px-4 mt-4 pb-6 flex flex-col">
            <div class="flex border-b border-slate-200 mb-3 text-sm">
                <div id="tab-my" onclick="switchRequestTab('my')" class="flex-1 text-center py-2 font-bold cursor-pointer tab-active">æˆ‘çš„ç”³è«‹</div>
                <div id="tab-proxy" onclick="switchRequestTab('proxy')" class="hidden flex-1 text-center py-2 font-bold cursor-pointer tab-inactive">ä»£è¾¦è¿½è¹¤</div>
            </div>
            <div id="request-list" class="space-y-3 pb-safe flex-1"></div>
        </div>
    </div>

    <div id="modal-leave" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold mb-4 flex items-center gap-2 text-lg text-slate-800">ğŸŒ´ è«‹å‡ç”³è«‹</h3>
            
            <label class="block text-xs font-bold text-slate-500 mb-1">å‡åˆ¥èˆ‡æ—¥æœŸ</label>
            <div class="flex gap-2 mb-2">
                <input type="date" id="leave-date" class="w-2/3 border rounded p-2 text-sm bg-slate-50">
                <select id="leave-type" class="w-1/3 border rounded p-2 text-sm bg-slate-50">
                    <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option><option value="è£œä¼‘">è£œä¼‘</option><option value="ç—…å‡">ç—…å‡</option><option value="äº‹å‡">äº‹å‡</option>
                    <option value="å©šå‡">å©šå‡</option><option value="å–ªå‡">å–ªå‡</option><option value="å…¬å‡">å…¬å‡</option><option value="ç”¢å‡">ç”¢å‡</option>
                </select>
            </div>

            <label class="block text-xs font-bold text-slate-500 mb-1">å½±éŸ¿æ™‚æ®µ (é‡è¦)</label>
            <select id="leave-period" class="w-full border rounded p-2 mb-2 text-sm bg-blue-50 font-bold text-blue-800" onchange="checkPeriodAutoFill()">
                <option value="start">ğŸŒ ä¸Šç­æ®µ (æ™šåˆ°)</option>
                <option value="end">ğŸŒ™ ä¸‹ç­æ®µ (æ—©é€€)</option>
                <option value="full">ğŸ“… æ•´æ—¥ (8H)</option>
                <option value="middle">âš¡ ä¸­é€”å¤–å‡º (ä¸å½±éŸ¿æ‰“å¡)</option>
            </select>

            <label class="block text-xs font-bold text-slate-500 mb-1">è«‹å‡æ™‚æ•¸ (æœ€å° 0.5)</label>
            <input type="number" id="leave-hours" class="w-full border rounded p-2 mb-2 text-sm" placeholder="ä¾‹å¦‚: 2.0" step="0.5" min="0.5">
            
            <label class="block text-xs font-bold text-slate-500 mb-1">äº‹ç”±</label>
            <input type="text" id="leave-note" class="w-full border rounded p-2 mb-4 text-sm" placeholder="è«‹å¡«å¯«äº‹ç”±">
            
            <div class="flex gap-2">
                <button onclick="closeModal('modal-leave')" class="flex-1 border p-2 rounded text-slate-500 font-bold">å–æ¶ˆ</button>
                <button onclick="submitLeave()" class="flex-1 bg-green-600 text-white p-2 rounded font-bold shadow">é€å‡º</button>
            </div>
        </div>
    </div>

    <div id="modal-ot" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold mb-4 flex items-center gap-2 text-lg text-slate-800">âš¡ åŠ ç­ç”³è«‹</h3>
            <input type="date" id="ot-date" class="w-full border rounded p-2 mb-2 text-sm">
            <input type="number" id="ot-hours" class="w-full border rounded p-2 mb-2 text-sm" placeholder="æ™‚æ•¸ (0.5å€æ•¸)" step="0.5" min="0.5">
            <input type="text" id="ot-note" class="w-full border rounded p-2 mb-4 text-sm" placeholder="äº‹ç”±">
            <div class="flex gap-2">
                <button onclick="closeModal('modal-ot')" class="flex-1 border p-2 rounded text-slate-500 font-bold">å–æ¶ˆ</button>
                <button onclick="submitOvertime()" class="flex-1 bg-orange-500 text-white p-2 rounded font-bold shadow">é€å‡º</button>
            </div>
        </div>
    </div>
</body>
</html>