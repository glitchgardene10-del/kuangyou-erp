<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰ç¥å±…æœå“¡è€ƒæ ¸ç³»çµ± (v7.0 ERPæ•´åˆç‰ˆ)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .saving-indicator { position: fixed; bottom: 10px; right: 10px; font-size: 12px; color: #64748b; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // â˜… ç¢ºä¿å¼•å…¥ Auth
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 
        const DOC_REF = doc(db, "caregiver_system", "main_data");

        // å°‡ Auth æš´éœ²çµ¦ React ä½¿ç”¨
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;

        window.FirebaseAPI = {
            // â˜… ä¿®æ”¹ï¼šè¨‚é–±è³‡æ–™åº«è®Šæ›´ (éœ€ç­‰å¾… Auth)
            subscribe: (onUpdate) => {
                // å›å‚³ unsubscribe å‡½å¼ä¾› React æ¸…ç†
                let unsubscribeSnapshot = null;
                
                const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // åªæœ‰ç™»å…¥å¾Œæ‰ç›£è½è³‡æ–™
                        unsubscribeSnapshot = onSnapshot(DOC_REF, (docSnap) => {
                            if (docSnap.exists()) {
                                onUpdate(docSnap.data());
                            } else {
                                const initialData = { staffList: [], allData: {} };
                                setDoc(DOC_REF, initialData);
                                onUpdate(initialData);
                            }
                        }, (error) => {
                            console.warn("è®€å–è³‡æ–™å—é™ (å¯èƒ½æ˜¯æ¬Šé™å•é¡Œ)", error);
                        });
                    }
                });

                // çµ„åˆéŠ·æ¯€å‡½å¼
                return () => {
                    unsubscribeAuth();
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                };
            },
            
            saveAll: async (staffList, allData, userEmail) => {
                try {
                    await setDoc(DOC_REF, { 
                        staffList, 
                        allData,
                        lastModifiedBy: userEmail,
                        lastModifiedAt: new Date().toISOString()
                    }, { merge: true });
                    return true;
                } catch (e) {
                    console.error("å„²å­˜å¤±æ•—:", e);
                    return false;
                }
            }
        };
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (ä¿æŒä¸è®Š) ---
        const Icons = {
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Trophy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            BarChart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>,
            Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-2.3-2.1-4-4.4-4-2.6 0-4.6 2.1-4.6 4.6 0 .3.1.6.2.9C2.7 17.8 1.5 19.5 1.5 21.5c0 2.5 2 4.5 4.5 4.5h11.5c2.5 0 4.5-2 4.5-4.5s-2-4.5-4.5-4.5z"/></svg>,
            History: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        };

        // --- UI Components (ä¿æŒä¸è®Š) ---
        const Card = ({ className, children }) => <div className={`rounded-lg border bg-white text-slate-950 shadow-sm ${className}`}>{children}</div>;
        const CardHeader = ({ className, children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className}`}>{children}</div>;
        const CardTitle = ({ className, children }) => <h3 className={`text-xl font-semibold leading-none tracking-tight ${className}`}>{children}</h3>;
        const CardContent = ({ className, children }) => <div className={`p-6 pt-0 ${className}`}>{children}</div>;
        const Button = ({ className, variant = "default", size = "default", onClick, children, disabled, title, type = "button" }) => {
            const baseStyles = "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50";
            const variants = {
                default: "bg-blue-600 text-white hover:bg-blue-700",
                outline: "border border-input bg-background hover:bg-slate-100 hover:text-slate-900",
                secondary: "bg-slate-600 text-white hover:bg-slate-700",
                destructive: "bg-red-500 text-white hover:bg-red-600",
                google: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50"
            };
            const sizes = { default: "h-10 px-4 py-2", sm: "h-8 rounded-md px-3 text-xs", icon: "h-10 w-10" };
            return <button type={type} disabled={disabled} className={`${baseStyles} ${variants[variant] || variants.default} ${sizes[size] || sizes.default} ${className}`} onClick={onClick} title={title}>{children}</button>;
        };
        const Input = ({ className, ...props }) => (
            <input className={`flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-1 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`} {...props} />
        );
        const Badge = ({ variant = "default", className, children }) => {
            const variants = {
                default: "bg-blue-600 text-white",
                warning: "bg-amber-500 text-white",
                destructive: "bg-red-500 text-white"
            };
            return <div className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold ${variants[variant]} ${className}`}>{children}</div>;
        };
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                    <div className="bg-white rounded-lg shadow-lg w-full max-w-md overflow-hidden">
                        <div className="px-4 py-3 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold">{title}</h3>
                            <button onClick={onClose} className="text-slate-500 hover:text-slate-700">&times;</button>
                        </div>
                        <div className="p-4">{children}</div>
                    </div>
                </div>
            );
        };

        const QUARTERLY_STRUCTURE = [
            { id: 'section1', title: 'ä¸€ã€ä¸»å‹•æ€§ (30%)', weight: 30, maxRawScore: 35, items: [{ id: '1.1', text: '1.1 æœŸé™å…§ç¹³äº¤æœå‹™å¡ã€æœå‹™ç´€éŒ„å–®' }, { id: '1.2', text: '1.2 æ¯æœˆåƒåŠ åœ˜ç£æœƒè­°' }, { id: '1.3', text: '1.3 æ¯æœˆåƒåŠ åœ¨è·æ•™è‚²è¨“ç·´' }, { id: '1.4', text: '1.4 ç©æ¥µæå‡è‡ªæˆ‘å°ˆæ¥­èƒ½åŠ›' }, { id: '1.5', text: '1.5 ä¸»å‹•ä¸”åŠæ™‚å‘ç£å°åæ˜ å€‹æ¡ˆå•é¡Œ' }, { id: '1.6', text: '1.6 å›å ±ç‰¹æ®Šäº‹ä»¶çš„ç©æ¥µæ€§' }, { id: '1.7', text: '1.7 ä¸»å‹•ç¹³äº¤æœå‹™ç›¸é—œè²»ç”¨' }] },
            { id: 'section2', title: 'äºŒã€å·¥ä½œèƒ½åŠ› (40%)', weight: 40, maxRawScore: 25, items: [{ id: '2.1', text: '2.1 æœå‹™æ™‚é–“æº–ç¢ºï¼Œç„¡é²åˆ°æ—©é€€' }, { id: '2.2', text: '2.2 APPå®šä½ç‹€æ³è‰¯å¥½' }, { id: '2.3', text: '2.3 å·¥ä½œå…§å®¹åŸ·è¡Œæ­£ç¢º' }, { id: '2.4', text: '2.4 ç…§é¡§æŠ€å·§ç†Ÿç·´åº¦èˆ‡æ­£ç¢ºæ€§' }, { id: '2.5', text: '2.5 æ„å¤–äº‹ä»¶æ‡‰è®Šèƒ½åŠ›' }] },
            { id: 'section3', title: 'ä¸‰ã€ç´€éŒ„èƒ½åŠ› (15%)', weight: 15, maxRawScore: 15, items: [{ id: '3.1', text: '3.1 æœå‹™å¡æ›¸å¯«æ¸…æ™°å®Œæ•´' }, { id: '3.2', text: '3.2 ç´€éŒ„å–®æ›¸å¯«å…·é«”è©³å¯¦' }, { id: '3.3', text: '3.3 ä¿®æ­£éŒ¯èª¤è¡¨å–®æ™‚æ•ˆæ€§' }] },
            { id: 'section4', title: 'å››ã€å·¥ä½œæ…‹åº¦ (15%)', weight: 15, maxRawScore: 40, items: [{ id: '4.1', text: '4.1 æœå‹™æ…‹åº¦ä½³ï¼Œäº’å‹•è‰¯å¥½' }, { id: '4.2', text: '4.2 è¬¹å®ˆå·¥ä½œå€«ç†èˆ‡éš±ç§' }, { id: '4.3', text: '4.3 èˆ‡æ©Ÿæ§‹åŒäº‹ä¿æŒåˆä½œ' }, { id: '4.4', text: '4.4 æœå¾ç£å°åŠæ©Ÿæ§‹æŒ‡å°' }, { id: '4.5', text: '4.5 ç¶­è­·æ©Ÿæ§‹å½¢è±¡ï¼Œè¨€è¡Œå¾—é«”' }, { id: '4.6', text: '4.6 æƒ…ç·’ç®¡ç†é©ç•¶' }, { id: '4.7', text: '4.7 æœè£å„€å®¹ç«¯æ­£' }, { id: '4.8', text: '4.8 é…åˆå…¬å¸æ’ç­è¦å®š' }] }
        ];

        const ANNUAL_STRUCTURE = [
            { id: 'annual_prof', title: 'å°ˆæ¥­èˆ‡å·¥ä½œæ…‹åº¦è€ƒæ ¸ (48%)', items: [{ id: 'a.1', text: '1. å…·å‚™å°ˆæ¥­çŸ¥è­˜èˆ‡ç…§è­·æŠ€å·§ï¼ŒéŒ¯èª¤ç‡ä½', max: 8 }, { id: 'a.2', text: '2. å·¥ä½œæ•ˆç‡é«˜ï¼Œæ™‚æ•ˆå…§å®Œæˆæ¥­å‹™', max: 8 }, { id: 'a.3', text: '3. é…åˆåº¦é«˜ï¼Œæ”¯æ´äº¤è¾¦äº‹é …', max: 8 }, { id: 'a.4', text: '4. ç›¡å¿ƒæœå‹™ï¼Œä¸æŠ±æ€¨ï¼Œéµå®ˆä¿å¯†éš±ç§', max: 8 }, { id: 'a.5', text: '5. æå‡ºå»ºè¨­æ€§å»ºè­°ï¼Œéç„¡æ•…æŠ±æ€¨', max: 8 }, { id: 'a.6', text: '6. å·¥ä½œè² è²¬å‹¤æ‡‡ï¼Œç¢ºå¯¦éµå®ˆå…¬å¸è¦å®š', max: 8 }] },
            { id: 'annual_loyalty', title: 'å‘å¿ƒåŠ›èˆ‡å€‹äººç´ é¤Šè€ƒæ ¸ (37%)', items: [{ id: 'b.1', text: '1. è¬™éœæœ‰ç¦®ï¼Œè½å¯¦è·å ´å€«ç†', max: 7 }, { id: 'b.2', text: '2. å°æ©Ÿæ§‹å‘å¿ƒåŠ›ä½³ï¼Œç¶­è­·ä¿¡è­½', max: 7 }, { id: 'b.3', text: '3. æ¨‚æ–¼åˆ†äº«å·¥ä½œæŠ€å·§ï¼Œä¸è—ç§', max: 8 }, { id: 'b.4', text: '4. å‹‡æ–¼æ‰¿æ“”éŒ¯èª¤ä¸¦ä¿®æ­£ï¼Œä¸èªªè¬Š', max: 8 }, { id: 'b.5', text: '5. ä»¥æ©Ÿæ§‹æœ€å¤§åˆ©ç›Šç‚ºè€ƒé‡ï¼Œç„¡é•æ³•é¢¨éšª', max: 7 }] }
        ];

        const getRecordKey = (sId, year, q) => `${sId}_${year}_${q}`;

        // Modified Calculation Logic
        const calculateQuarterly = (record) => {
            if (!record) return { total: 0, details: [], bonus: 0, penalty: 0 };
            if (record.manualScore !== undefined && record.manualScore !== '' && record.manualScore !== null) {
                return { total: parseFloat(record.manualScore).toFixed(2), details: [{ title: 'æ­·å²æˆç¸¾ç›´æ¥è£œç™»', raw: '-', weighted: parseFloat(record.manualScore).toFixed(2) }], bonusData: {}, isNewHire: record.isNewHire, isManual: true };
            }
            const scores = record.scores || {};
            const bonusData = record.bonus || {};
            let totalWeighted = 0, details = [];
            QUARTERLY_STRUCTURE.forEach(section => {
                let rawSum = 0;
                section.items.forEach(item => {
                    const s = scores[item.id] || {};
                    rawSum += ((s.self||0)*0.05) + ((s.sup||0)*0.60) + ((s.dir||0)*0.35);
                });
                const weighted = (rawSum / section.maxRawScore) * section.weight;
                totalWeighted += weighted;
                details.push({ title: section.title, raw: rawSum.toFixed(2), weighted: weighted.toFixed(2) });
            });
            const bNewStaff = Math.min((bonusData.newStaff||0)*1, 2);
            const bNewCase = Math.min((bonusData.newCase||0)*0.5, 2);
            const bInnovation = Math.min((bonusData.innovation||0), 2);
            const pAudit = (bonusData.auditError||0)*3;
            const pComplaint = (bonusData.complaint||0)*2;
            const final = totalWeighted + bNewStaff + bNewCase + bInnovation - pAudit - pComplaint;
            return { total: final.toFixed(2), details, bonusData, isNewHire: record.isNewHire, isManual: false };
        };

        const calculateAnnual = (sId, year, allData) => {
            let qSum = 0, qCount = 0, qDetails = [];
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                const key = getRecordKey(sId, year, q);
                const record = allData[key];
                if (record && !record.isNewHire) {
                    const res = calculateQuarterly(record);
                    const val = parseFloat(res.total);
                    if (!isNaN(val) && val > 0) { qSum += val; qCount++; qDetails.push({ q, val }); }
                } else if (record && record.isNewHire) { qDetails.push({ q, val: 'æ–°é€²(ä¸è¨ˆ)' }); } else { qDetails.push({ q, val: '-' }); }
            });
            const qAvg = qCount > 0 ? (qSum / qCount) : 0;
            const annualFromQuarter = qAvg * 0.15;
            
            const annualKey = getRecordKey(sId, year, 'ANNUAL');
            const record = allData[annualKey] || {};
            const scores = record.scores || {};
            const bonus = record.bonus || {};
            let totalMax = 0, sumSelf = 0, sumSup = 0, sumDir = 0;
            ANNUAL_STRUCTURE.forEach(sec => {
                sec.items.forEach(item => {
                    totalMax += item.max;
                    const s = scores[item.id] || {};
                    sumSelf += parseFloat(s.self || 0);
                    sumSup += parseFloat(s.sup || 0);
                    sumDir += parseFloat(s.dir || 0);
                });
            });
            const scoreSelf = totalMax > 0 ? (sumSelf / totalMax) * 10 : 0;
            const scoreSup = totalMax > 0 ? (sumSup / totalMax) * 50 : 0;
            const scoreDir = totalMax > 0 ? (sumDir / totalMax) * 25 : 0;
            const annualAssessmentScore = scoreSelf + scoreSup + scoreDir;
            
            const lateCount = (bonus.late || 0);
            const forgotCount = (bonus.forgot || 0);
            const gpsCount = (bonus.gps || 0);
            
            const attDeduct = 
                (Math.floor(lateCount / 3) * 0.5) +       
                ((bonus.absent || 0) * 1) +               
                ((bonus.leave || 0) * 0.2) +              
                (Math.floor(forgotCount / 2) * 0.5) +     
                (Math.floor(gpsCount / 5) * 0.5);         
            
            const rewardsScore = 
                ((bonus.commendation1 || 0) * 0.3) +      
                ((bonus.commendation2 || 0) * 1) +        
                ((bonus.commendation3 || 0) * 3) -        
                ((bonus.warning || 0) * 0.3) -            
                ((bonus.minor || 0) * 1) -                
                ((bonus.major || 0) * 3);                 

            const final = annualFromQuarter + annualAssessmentScore + rewardsScore - attDeduct;
            return { qDetails, qAvg: qAvg.toFixed(2), annualFromQuarter: annualFromQuarter.toFixed(2), scoreSelf: scoreSelf.toFixed(2), scoreSup: scoreSup.toFixed(2), scoreDir: scoreDir.toFixed(2), annualAssessmentScore: annualAssessmentScore.toFixed(2), attDeduct: attDeduct.toFixed(2), rewardsScore: rewardsScore.toFixed(2), final: final.toFixed(2), bonus };
        };

        const RankingView = ({ staffList, allData, currentYear, currentQuarter }) => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (currentQuarter === 'ANNUAL') return;
                const calculated = staffList.map(staff => {
                    const key = getRecordKey(staff.id, currentYear, currentQuarter);
                    const record = allData[key];
                    if (!record) return { ...staff, score: 0, isNewHire: false };
                    const res = calculateQuarterly(record);
                    return { ...staff, score: parseFloat(res.total), isNewHire: record.isNewHire };
                }).filter(s => s.score > 0);
                calculated.sort((a, b) => b.score - a.score);
                const totalActiveStaff = calculated.length;
                const top20Count = Math.ceil(totalActiveStaff * 0.2);
                const finalData = calculated.map((item, index) => {
                    const rank = index + 1;
                    const score = item.score;
                    let baseBonus = 0, extraBonus = 0, rankBonus = 0;
                    if (score >= 85) baseBonus = 1500; else if (score >= 75) baseBonus = 1000; else if (score >= 70) baseBonus = 500;
                    if (score > 90) extraBonus += 500; if (score > 95) extraBonus += 500;
                    if (rank <= top20Count) rankBonus = 500;
                    return { ...item, rank, baseBonus, extraBonus, rankBonus, totalBonus: baseBonus + extraBonus + rankBonus };
                });
                setData(finalData);
            }, [staffList, allData, currentYear, currentQuarter]);

            if (currentQuarter === 'ANNUAL') return <div className="p-8 text-center text-slate-500">å¹´åº¦ç¸½è©•è«‹ä½¿ç”¨å€‹åˆ¥è€ƒæ ¸é é¢æŸ¥çœ‹è©³ç´°å ±è¡¨ï¼Œæ­¤åŠŸèƒ½åƒ…æ”¯æ´å­£åº¦çé‡‘è¨ˆç®—ã€‚</div>;
            return (
                <div className="space-y-6 animate-in fade-in">
                    <Card><CardHeader className="flex flex-row items-center justify-between pb-2 bg-slate-50 border-b">
                        <div><CardTitle className="text-xl font-bold flex items-center gap-2"><Icons.BarChart className="text-blue-600"/> {currentYear}å¹´ {currentQuarter} å­£åº¦çé‡‘æ’åè¡¨</CardTitle><p className="text-sm text-slate-500 mt-1">ç¸½è¨ˆ {data.length} ä½å—è©•äººå“¡ï¼Œå‰ 20% (åæ¬¡ &le; {Math.ceil(data.length * 0.2)}) äº«æœ‰æ’åçé‡‘</p></div>
                        <div className="text-right"><div className="text-xs text-slate-500">é ä¼°ç™¼æ”¾ç¸½çé‡‘</div><div className="text-2xl font-bold font-mono text-green-600">${data.reduce((acc, curr) => acc + curr.totalBonus, 0).toLocaleString()}</div></div>
                    </CardHeader><CardContent className="p-0"><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-100 text-slate-600 uppercase font-bold text-xs"><tr><th className="px-4 py-3 w-16 text-center">æ’å</th><th className="px-4 py-3">å§“å</th><th className="px-4 py-3 text-right">ç¸½åˆ†</th><th className="px-4 py-3 text-right">ç´šè·çé‡‘</th><th className="px-4 py-3 text-right">é«˜åˆ†åŠ çµ¦</th><th className="px-4 py-3 text-right">æ’ååŠ çµ¦</th><th className="px-4 py-3 text-right text-green-700 bg-green-50">ç¸½çé‡‘</th></tr></thead><tbody className="divide-y divide-slate-100">{data.map(row => (<tr key={row.id} className="hover:bg-slate-50"><td className="px-4 py-3 text-center font-bold text-slate-500">{row.rank === 1 ? 'ğŸ¥‡' : row.rank === 2 ? 'ğŸ¥ˆ' : row.rank === 3 ? 'ğŸ¥‰' : row.rank}</td><td className="px-4 py-3 font-medium">{row.name}{row.isNewHire && <Badge variant="warning" className="ml-2">æ–°é€²</Badge>}</td><td className="px-4 py-3 text-right font-mono font-bold">{row.score.toFixed(2)}</td><td className="px-4 py-3 text-right text-slate-500">${row.baseBonus}</td><td className="px-4 py-3 text-right text-slate-500">{row.extraBonus > 0 ? `+$${row.extraBonus}` : '-'}</td><td className="px-4 py-3 text-right text-slate-500">{row.rankBonus > 0 ? <span className="text-blue-600 font-bold">+$500</span> : '-'}</td><td className="px-4 py-3 text-right font-bold text-green-700 bg-green-50">${row.totalBonus.toLocaleString()}</td></tr>))}</tbody></table></div></CardContent></Card>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [viewMode, setViewMode] = useState('individual');
            const [currentYear, setCurrentYear] = useState(114);
            const [currentQuarter, setCurrentQuarter] = useState('Q1');
            const [staffList, setStaffList] = useState([]);
            const [selectedStaffId, setSelectedStaffId] = useState(null);
            const [allData, setAllData] = useState({});
            const [isStaffModalOpen, setIsStaffModalOpen] = useState(false);
            const [editingStaff, setEditingStaff] = useState(null);
            const fileInputRef = useRef(null);
            const [dataLoading, setDataLoading] = useState(false);
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                const session = sessionStorage.getItem('kuangyou_user');
                if (!session) {
                    alert("â›” è«‹ç”±ç®¡ç†ç³»çµ±ç™»å…¥");
                    window.top.location.href = 'index.html';
                    return;
                }
                const currentUser = JSON.parse(session);
                setUser(currentUser);
                setAuthLoading(false);

                setDataLoading(true);
                // â˜… é€™è£¡ç¾åœ¨æœƒæ­£ç¢ºç­‰å¾… Auth Ready
                const unsubscribe = window.FirebaseAPI.subscribe((data) => {
                    if (data) { setStaffList(data.staffList || []); setAllData(data.allData || {}); }
                    setDataLoading(false);
                });
                return () => { if(unsubscribe) unsubscribe(); };
            }, []);

            useEffect(() => {
                if (user && !selectedStaffId && staffList.length > 0 && !dataLoading) setSelectedStaffId(staffList[0].id);
            }, [staffList, dataLoading, selectedStaffId, user]);

            const handleLogout = () => {
                if(confirm("ç¢ºå®šè¦é›¢é–‹è€ƒæ ¸ç³»çµ±å—ï¼Ÿ")) {
                    window.top.location.href = 'index.html'; 
                }
            };

            const saveToFirebase = async (newList, newData) => {
                if (!user) return;
                setSaving(true);
                await window.FirebaseAPI.saveAll(newList, newData, user.email || user.name);
                setSaving(false);
            };

            const getStaffStatus = (staff, year, quarter) => {
                if (!staff.resignDate) return 'active';
                const [rY, rM] = staff.resignDate.split('-').map(Number);
                let qStartMonth = 1;
                if (quarter === 'Q2') qStartMonth = 4;
                if (quarter === 'Q3') qStartMonth = 7;
                if (quarter === 'Q4' || quarter === 'ANNUAL') qStartMonth = 10;
                if (rY < year) return 'resigned';
                if (rY === year && rM < qStartMonth) return 'resigned';
                return 'active';
            };

            const handleSaveStaff = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newStaff = { id: editingStaff?.id || Date.now(), name: formData.get('name'), onboardDate: formData.get('onboardDate'), resignDate: formData.get('resignDate') };
                let newList = editingStaff ? staffList.map(s => s.id === editingStaff.id ? newStaff : s) : [...staffList, newStaff];
                if (!editingStaff) setSelectedStaffId(newStaff.id);
                setStaffList(newList);
                saveToFirebase(newList, allData);
                setIsStaffModalOpen(false);
                setEditingStaff(null);
            };

            const handleDeleteStaff = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤å“¡å·¥è³‡æ–™ï¼Ÿ')) {
                    const newList = staffList.filter(s => s.id !== id);
                    setStaffList(newList);
                    if (selectedStaffId === id) setSelectedStaffId(null);
                    saveToFirebase(newList, allData);
                }
            };

            const updateAndSave = (newData) => { setAllData(newData); saveToFirebase(staffList, newData); };
            const updateRecord = (key, field, value) => updateAndSave({ ...allData, [key]: { ...allData[key], [field]: value } });
            const updateBonus = (key, field, val) => updateAndSave({ ...allData, [key]: { ...allData[key], bonus: { ...allData[key]?.bonus, [field]: val === '' ? '' : parseFloat(val) } } });
            const updateScore = (key, itemId, role, val) => {
                let num = val === '' ? '' : parseFloat(val);
                if (num !== '' && num > 100) num = 100;
                updateAndSave({ ...allData, [key]: { ...allData[key], scores: { ...allData[key]?.scores, [itemId]: { ...allData[key]?.scores?.[itemId], [role]: num } } } });
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const parsed = JSON.parse(evt.target.result);
                        if (parsed.staffList && parsed.allData && confirm("åŒ¯å…¥å°‡è¦†è“‹é›²ç«¯è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) {
                            setStaffList(parsed.staffList);
                            setAllData(parsed.allData);
                            saveToFirebase(parsed.staffList, parsed.allData);
                        }
                    } catch (err) { alert("è®€å–å¤±æ•—"); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const downloadData = () => {
                const blob = new Blob([JSON.stringify({ staffList, allData, version: "v5_auth" }, null, 2)], { type: "application/json" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `è€ƒæ ¸ç³»çµ±å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const currentStaff = staffList.find(s => s.id === selectedStaffId);
            const recordKey = selectedStaffId ? getRecordKey(selectedStaffId, currentYear, currentQuarter) : null;
            const currentRecord = allData[recordKey] || {};

            if (authLoading) return <div className="h-screen w-full flex items-center justify-center bg-slate-900 text-white font-bold animate-pulse">ç³»çµ±æ¬Šé™é©—è­‰ä¸­...</div>;
            if (dataLoading) return <div className="h-screen w-full flex items-center justify-center bg-slate-50 text-slate-500 font-bold animate-pulse">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans">
                    <header className="bg-white border-b px-6 py-4 flex items-center justify-between sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg"><Icons.Cloud className="h-5 w-5 text-white" /></div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800 hidden md:block">å…‰ç¥å±…æœå“¡è€ƒæ ¸ç³»çµ± <span className="text-xs font-normal text-slate-500 ml-2 bg-slate-100 px-2 py-0.5 rounded-full">v7.0 ERPç‰ˆ</span></h1>
                                <p className="text-xs text-slate-400 md:hidden">v7.0 ERP</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="hidden md:flex items-center text-xs text-slate-500 border-r pr-4 mr-2">
                                <span className="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                {user.name} ({user.role === 'super_admin' ? 'ç¸½ç®¡ç†å“¡' : 'è¡Œæ”¿äººå“¡'})
                            </div>
                            <div className="flex bg-slate-100 rounded p-1 mr-2">
                                <button onClick={() => setViewMode('individual')} className={`px-3 py-1 text-sm rounded transition-all flex items-center gap-1 ${viewMode==='individual' ? 'bg-white shadow text-blue-700 font-bold' : 'text-slate-500'}`}><Icons.Users className="w-4 h-4"/> å€‹åˆ¥</button>
                                <button onClick={() => setViewMode('ranking')} className={`px-3 py-1 text-sm rounded transition-all flex items-center gap-1 ${viewMode==='ranking' ? 'bg-white shadow text-blue-700 font-bold' : 'text-slate-500'}`}><Icons.BarChart className="w-4 h-4"/> æ’å</button>
                            </div>
                            <div className="flex gap-2">
                                <select value={currentYear} onChange={(e) => setCurrentYear(Number(e.target.value))} className="h-9 rounded border border-slate-300 px-2 text-sm font-bold bg-slate-50"><option value={113}>113å¹´</option><option value={114}>114å¹´</option><option value={115}>115å¹´</option></select>
                                <select value={currentQuarter} onChange={(e) => setCurrentQuarter(e.target.value)} className="h-9 rounded border border-slate-300 px-2 text-sm font-bold bg-slate-50"><option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option><option value="ANNUAL">å¹´åº¦</option></select>
                            </div>
                            <Button variant="secondary" size="icon" onClick={handleLogout} title="é›¢é–‹ç³»çµ±"><Icons.LogOut className="w-4 h-4"/></Button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden h-[calc(100vh-73px)]">
                        {viewMode === 'individual' && (
                            <aside className="w-72 bg-white border-r flex flex-col h-full overflow-hidden shrink-0">
                                <div className="p-4 border-b flex-shrink-0"><Button onClick={() => { setEditingStaff(null); setIsStaffModalOpen(true); }} className="w-full"><Icons.Plus className="mr-2 h-4 w-4" /> æ–°å¢å±…æœå“¡</Button></div>
                                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                    {staffList.map(staff => {
                                        const st = getStaffStatus(staff, currentYear, currentQuarter);
                                        return (
                                            <div key={staff.id} onClick={() => st!=='resigned' && setSelectedStaffId(staff.id)} className={`group flex items-center justify-between p-3 rounded-md cursor-pointer transition-all border border-transparent ${selectedStaffId === staff.id ? 'bg-blue-50 border-blue-200 shadow-sm' : 'hover:bg-slate-50'} ${st==='resigned' ? 'opacity-50 grayscale cursor-not-allowed bg-slate-50' : ''}`}>
                                                <div className="flex items-center gap-3 overflow-hidden">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0 ${selectedStaffId === staff.id ? 'bg-blue-200 text-blue-700' : 'bg-slate-200 text-slate-500'}`}>{staff.name.charAt(0)}</div>
                                                    <div className="min-w-0"><div className="font-medium truncate text-slate-900">{staff.name}</div>{st==='resigned' && <Badge variant="destructive" className="mt-0.5">å·²é›¢è·</Badge>}</div>
                                                </div>
                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e) => { e.stopPropagation(); setEditingStaff(staff); setIsStaffModalOpen(true); }} className="p-1 hover:bg-slate-200 rounded text-slate-500"><Icons.Edit className="h-4 w-4"/></button><button onClick={(e) => { e.stopPropagation(); handleDeleteStaff(staff.id); }} className="p-1 hover:bg-red-100 rounded text-red-500"><Icons.Trash2 className="h-4 w-4"/></button></div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="p-4 border-t bg-slate-50 flex gap-2">
                                    <Button onClick={downloadData} variant="secondary" className="flex-1 text-xs" title="ä¸‹è¼‰å‚™ä»½"><Icons.Download className="w-4 h-4 mr-1"/> å‚™ä»½</Button>
                                    <Button onClick={() => fileInputRef.current.click()} variant="outline" className="flex-1 text-xs" title="åŒ¯å…¥èˆŠæª”"><Icons.Upload className="w-4 h-4 mr-1"/> åŒ¯å…¥</Button>
                                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".json"/>
                                </div>
                            </aside>
                        )}
                        <main className="flex-1 overflow-y-auto p-6 bg-slate-50">
                            {viewMode === 'individual' ? (
                                selectedStaffId ? (
                                    <div className="max-w-5xl mx-auto">
                                        <div className="mb-6 flex items-center justify-between">
                                            <div><h2 className="text-2xl font-bold text-slate-800">{staffList.find(s=>s.id===selectedStaffId)?.name}</h2><p className="text-slate-500 text-sm flex items-center gap-2"><Icons.Calendar className="h-4 w-4"/> {currentYear}å¹´ {currentQuarter==='ANNUAL'?'å¹´åº¦è€ƒæ ¸':currentQuarter+' å­£è€ƒæ ¸'}</p></div>
                                        </div>
                                        {currentQuarter === 'ANNUAL' ? 
                                            (() => {
                                                const res = calculateAnnual(selectedStaffId, currentYear, allData);
                                                const scores = currentRecord.scores || {};
                                                const bonus = currentRecord.bonus || {};
                                                return <div className="space-y-6 animate-in fade-in duration-300">
                                                    <Card><CardHeader className="py-3 bg-blue-50"><CardTitle className="text-base text-blue-800">1. å­£è€ƒæ ¸æˆç¸¾åŒ¯ç¸½ (ä½”15%)</CardTitle></CardHeader><CardContent className="pt-4"><div className="flex justify-between items-center text-sm mb-2">{res.qDetails.map(q => (<div key={q.q} className="text-center p-2 bg-slate-100 rounded min-w-[60px]"><div className="text-slate-500 font-bold">{q.q}</div><div className="font-mono">{typeof q.val === 'number' ? q.val.toFixed(1) : q.val}</div></div>))}<div className="text-xl font-bold text-blue-600 px-4">Avg: {res.qAvg} <span className="text-sm text-slate-400">x 15% = </span> {res.annualFromQuarter}</div></div></CardContent></Card>
                                                    <div className="grid md:grid-cols-3 gap-6">
                                                        <div className="md:col-span-2 space-y-6">
                                                            <Card><CardHeader className="py-3 bg-slate-50"><CardTitle className="text-base">2. å‡ºå‹¤èˆ‡çæ‡²</CardTitle></CardHeader><CardContent className="pt-4 grid grid-cols-1 gap-4"><div className="bg-red-50 p-3 rounded"><h4 className="font-bold text-red-800 text-sm mb-2">å‡ºå‹¤æ‰£åˆ† (æ¬¡/å¤©)</h4>
                                                            <div className="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                                                                <div><label className="text-xs text-slate-500 block">é²åˆ°æ—©é€€ (3æ¬¡-0.5)</label><Input type="number" value={bonus.late||''} onChange={e=>updateBonus(recordKey, 'late', e.target.value)} /></div>
                                                                <div><label className="text-xs text-slate-500 block">æ› ç­ (1æ¬¡-1)</label><Input type="number" value={bonus.absent||''} onChange={e=>updateBonus(recordKey, 'absent', e.target.value)} /></div>
                                                                <div><label className="text-xs text-slate-500 block">æœªä¾è¦å®šè«‹å‡ (1æ¬¡-0.2)</label><Input type="number" value={bonus.leave||''} onChange={e=>updateBonus(recordKey, 'leave', e.target.value)} /></div>
                                                                <div><label className="text-xs text-slate-500 block">å¿˜è¨˜ç°½é€€ (2æ¬¡-0.5)</label><Input type="number" value={bonus.forgot||''} onChange={e=>updateBonus(recordKey, 'forgot', e.target.value)} /></div>
                                                                <div><label className="text-xs text-slate-500 block">å®šä½ç•°å¸¸ (5æ¬¡-0.5)</label><Input type="number" value={bonus.gps||''} onChange={e=>updateBonus(recordKey, 'gps', e.target.value)} /></div>
                                                            </div>
                                                            <div className="mt-2 text-right text-red-600 font-bold text-sm">å‡ºå‹¤å°è¨ˆæ‰£åˆ†: -{res.attDeduct}</div>
                                                            </div><div className="bg-green-50 p-3 rounded"><h4 className="font-bold text-green-800 text-sm mb-2">çæ‡²ç‹€æ³ (æ”¯)</h4>
                                                            <div className="grid grid-cols-3 md:grid-cols-6 gap-2 text-sm">
                                                                <div><label className="text-xs text-green-700 block">å˜‰ç (+0.3)</label><Input type="number" value={bonus.commendation1||''} onChange={e=>updateBonus(recordKey, 'commendation1', e.target.value)} /></div>
                                                                <div><label className="text-xs text-green-700 block">å°åŠŸ (+1)</label><Input type="number" value={bonus.commendation2||''} onChange={e=>updateBonus(recordKey, 'commendation2', e.target.value)} /></div>
                                                                <div><label className="text-xs text-green-700 block">å¤§åŠŸ (+3)</label><Input type="number" value={bonus.commendation3||''} onChange={e=>updateBonus(recordKey, 'commendation3', e.target.value)} /></div>
                                                                <div><label className="text-xs text-red-700 block">ç”³èª¡ (-0.3)</label><Input type="number" value={bonus.warning||''} onChange={e=>updateBonus(recordKey, 'warning', e.target.value)} /></div>
                                                                <div><label className="text-xs text-red-700 block">å°é (-1)</label><Input type="number" value={bonus.minor||''} onChange={e=>updateBonus(recordKey, 'minor', e.target.value)} /></div>
                                                                <div><label className="text-xs text-red-700 block">å¤§é (-3)</label><Input type="number" value={bonus.major||''} onChange={e=>updateBonus(recordKey, 'major', e.target.value)} /></div>
                                                            </div>
                                                            <div className="mt-2 text-right text-green-700 font-bold text-sm">çæ‡²å°è¨ˆ: {parseFloat(res.rewardsScore) > 0 ? '+' : ''}{res.rewardsScore}</div>
                                                            </div></CardContent></Card>
                                                            {ANNUAL_STRUCTURE.map(sec => (<Card key={sec.id}><CardHeader className="py-3 bg-slate-50"><CardTitle className="text-base">{sec.title}</CardTitle></CardHeader><CardContent className="p-0"><table className="w-full text-sm"><thead className="bg-slate-100 text-xs text-slate-500"><tr><th className="p-2 text-left">é …ç›® (æ»¿åˆ†å¦‚é¡Œç¤º)</th><th className="w-16 text-center">è‡ªè©•</th><th className="w-16 text-center">ç£å°</th><th className="w-16 text-center">ä¸»ä»»</th></tr></thead><tbody className="divide-y">{sec.items.map(item => {const s = scores[item.id] || {}; return <tr key={item.id}><td className="p-2"><div className="font-medium">{item.text}</div><div className="text-xs text-slate-400">æ»¿åˆ†: {item.max}</div></td><td className="p-1"><Input className="text-center" placeholder={`/${item.max}`} value={s.self||''} onChange={e=>updateScore(recordKey, item.id, 'self', e.target.value)} /></td><td className="p-1"><Input className="text-center bg-blue-50" placeholder={`/${item.max}`} value={s.sup||''} onChange={e=>updateScore(recordKey, item.id, 'sup', e.target.value)} /></td><td className="p-1"><Input className="text-center" placeholder={`/${item.max}`} value={s.dir||''} onChange={e=>updateScore(recordKey, item.id, 'dir', e.target.value)} /></td></tr>;})}</tbody></table></CardContent></Card>))}
                                                        </div>
                                                        <div className="md:col-span-1"><Card className="bg-slate-900 text-white sticky top-4 border-none shadow-xl"><CardHeader><CardTitle className="flex items-center gap-2"><Icons.Trophy className="text-yellow-400"/> å¹´åº¦ç¸½æˆç¸¾</CardTitle></CardHeader><CardContent className="space-y-4"><div className="text-center py-4 border-b border-slate-700"><div className="text-6xl font-bold font-mono text-yellow-400">{res.final}</div></div><div className="space-y-2 text-sm"><div className="flex justify-between"><span>å­£è€ƒæ ¸ (15%)</span><span className="font-mono">{res.annualFromQuarter}</span></div><div className="flex justify-between"><span>è‡ªè©• (10%)</span><span className="font-mono">{res.scoreSelf}</span></div><div className="flex justify-between"><span>ç£å° (50%)</span><span className="font-mono">{res.scoreSup}</span></div><div className="flex justify-between"><span>ä¸»ä»» (25%)</span><span className="font-mono">{res.scoreDir}</span></div><div className="border-t border-slate-700 my-2 pt-2"></div><div className="flex justify-between text-red-400"><span>å‡ºå‹¤æ‰£åˆ†</span><span className="font-mono">-{res.attDeduct}</span></div><div className="flex justify-between text-green-400"><span>çæ‡²åŠ æ¸›</span><span className="font-mono">{parseFloat(res.rewardsScore) > 0 ? '+' : ''}{res.rewardsScore}</span></div></div></CardContent></Card></div>
                                                    </div>
                                                </div>;
                                            })()
                                            : 
                                            (() => {
                                                const result = calculateQuarterly(currentRecord);
                                                return <div className="space-y-6 animate-in fade-in duration-300">
                                                    <Card className="border-purple-200 bg-purple-50">
                                                        <CardContent className="pt-6 flex flex-col md:flex-row items-center justify-between gap-4">
                                                            <div className="flex items-center gap-2">
                                                                <div className="bg-purple-200 p-2 rounded-full"><Icons.History className="w-5 h-5 text-purple-700"/></div>
                                                                <div>
                                                                    <label className="font-bold text-purple-800 text-lg">æ­·å²æˆç¸¾å¿«é€Ÿè£œç™» (ç¸½åˆ†)</label>
                                                                    <p className="text-xs text-purple-600">è‹¥æœ‰å¡«å¯«æ­¤æ¬„ï¼Œå°‡ç›´æ¥ä½¿ç”¨æ­¤åˆ†æ•¸ï¼Œå¿½ç•¥ä¸‹æ–¹è©•æ ¸è¡¨ã€‚</p>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                <span className="font-bold text-slate-600">æœ¬å­£ç¸½åˆ†ï¼š</span>
                                                                <Input type="number" className="w-32 bg-white font-bold text-lg h-12 text-center border-purple-300 focus:ring-purple-500" placeholder="0.00" value={currentRecord.manualScore || ''} onChange={(e) => updateRecord(recordKey, 'manualScore', e.target.value)} />
                                                            </div>
                                                        </CardContent>
                                                    </Card>
                                                    {!result.isManual && (
                                                        <>
                                                            <div className="flex items-center space-x-2 bg-yellow-50 p-3 rounded border border-yellow-200"><input type="checkbox" id="isNewHire" checked={currentRecord.isNewHire || false} onChange={(e) => updateRecord(recordKey, 'isNewHire', e.target.checked)} className="w-4 h-4 text-blue-600 rounded" /><label htmlFor="isNewHire" className="text-sm font-medium text-slate-800">æ­¤è€ƒæ ¸ç‚ºã€Œæ–°é€²äººå“¡/è©¦ç”¨æœŸã€è€ƒæ ¸ (å‹¾é¸å¾Œï¼Œæ­¤åˆ†æ•¸å°‡<span className="text-red-600 font-bold">ä¸åˆ—å…¥</span>å¹´åº¦å¹³å‡è¨ˆç®—)</label></div>
                                                            <div className="grid md:grid-cols-2 gap-4"><div className="space-y-4"><Card><CardContent className="pt-6"><h3 className="font-bold mb-4 flex items-center gap-2"><Icons.Trophy className="h-4 w-4 text-amber-500"/> åŠ æ‰£åˆ†</h3><div className="grid grid-cols-2 gap-4 text-sm"><label>ä»‹ç´¹æ–°äºº (äºº)</label><Input type="number" value={currentRecord.bonus?.newStaff||''} onChange={e=>updateBonus(recordKey, 'newStaff', e.target.value)} /><label>ä»‹ç´¹å€‹æ¡ˆ (æ¡ˆ)</label><Input type="number" value={currentRecord.bonus?.newCase||''} onChange={e=>updateBonus(recordKey, 'newCase', e.target.value)} /><label>å‰µæ–°ç¶“é©— (åˆ†)</label><Input type="number" value={currentRecord.bonus?.innovation||''} onChange={e=>updateBonus(recordKey, 'innovation', e.target.value)} /><label className="text-red-600">ç¨½æ ¸ç•°å¸¸ (é …)</label><Input type="number" value={currentRecord.bonus?.auditError||''} onChange={e=>updateBonus(recordKey, 'auditError', e.target.value)} /><label className="text-red-600">ç”³è¨´å±¬å¯¦ (æ¡ˆ)</label><Input type="number" value={currentRecord.bonus?.complaint||''} onChange={e=>updateBonus(recordKey, 'complaint', e.target.value)} /></div></CardContent></Card>{QUARTERLY_STRUCTURE.map(sec => (<Card key={sec.id}><CardHeader className="py-3 bg-slate-50"><CardTitle className="text-base">{sec.title}</CardTitle></CardHeader><CardContent className="p-0"><table className="w-full text-sm"><thead className="bg-slate-100 text-xs text-slate-500"><tr><th className="p-2 text-left">é …ç›®</th><th className="w-12 text-center">è‡ªè©•</th><th className="w-12 text-center">ç£å°</th><th className="w-12 text-center">ä¸»ä»»</th></tr></thead><tbody className="divide-y">{sec.items.map(item => {const s = currentRecord.scores?.[item.id] || {}; return <tr key={item.id}><td className="p-2">{item.text}</td><td className="p-1"><Input className="text-center px-0" value={s.self||''} onChange={e=>updateScore(recordKey, item.id, 'self', e.target.value)} /></td><td className="p-1"><Input className="text-center px-0 bg-blue-50" value={s.sup||''} onChange={e=>updateScore(recordKey, item.id, 'sup', e.target.value)} /></td><td className="p-1"><Input className="text-center px-0" value={s.dir||''} onChange={e=>updateScore(recordKey, item.id, 'dir', e.target.value)} /></td></tr>;})}</tbody></table></CardContent></Card>))}</div><div className="space-y-4"><Card className="bg-slate-800 text-white border-none sticky top-4"><CardHeader><CardTitle>æœ¬å­£æˆç¸¾å–®</CardTitle></CardHeader><CardContent><div className="text-5xl font-bold font-mono text-center mb-4">{result.total}</div><div className="space-y-2 text-sm text-slate-300">{result.details.map((d,i) => (<div key={i} className="flex justify-between border-b border-slate-700 pb-1"><span>{d.title}</span><span>{d.weighted}</span></div>))}</div>{currentRecord.isNewHire && <div className="mt-4 text-center bg-yellow-500/20 text-yellow-300 py-1 rounded">è©¦ç”¨æœŸ / ä¸è¨ˆå…¥å¹´åº¦</div>}</CardContent></Card></div></div>
                                                        </>
                                                    )}
                                                </div>;
                                            })()
                                    }
                                    </div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-400"><Icons.Users className="h-16 w-16 mb-4 opacity-20" /><p>è«‹é¸æ“‡å·¦å´å±…æœå“¡é€²è¡Œè€ƒæ ¸</p></div>
                                )
                            ) : (
                                <div className="max-w-5xl mx-auto"><RankingView staffList={staffList} allData={allData} currentYear={currentYear} currentQuarter={currentQuarter} /></div>
                            )}
                        </main>
                    </div>

                    <Modal isOpen={isStaffModalOpen} onClose={() => setIsStaffModalOpen(false)} title={editingStaff ? "ç·¨è¼¯å±…æœå“¡è³‡æ–™" : "æ–°å¢å±…æœå“¡"}>
                        <form onSubmit={handleSaveStaff} className="space-y-4">
                            <div><label className="block text-sm font-medium mb-1">å§“å</label><Input name="name" defaultValue={editingStaff?.name} required /></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium mb-1">åˆ°è·æ—¥ (å¦‚ 113-01-01)</label><Input name="onboardDate" defaultValue={editingStaff?.onboardDate} placeholder="YYY-MM-DD" /></div><div><label className="block text-sm font-medium mb-1">é›¢è·æ—¥ (é¸å¡«)</label><Input name="resignDate" defaultValue={editingStaff?.resignDate} placeholder="YYY-MM-DD" /><p className="text-xs text-slate-500 mt-1">è¨­å®šå¾Œè©²æ—¥æœŸå¾Œçš„å­£åº¦å°‡ç„¡æ³•è€ƒæ ¸</p></div></div>
                            <div className="flex justify-end pt-4"><Button type="submit"><Icons.Save className="w-4 h-4 mr-2"/> å„²å­˜ä¸¦åŒæ­¥</Button></div>
                        </form>
                    </Modal>
                    {saving && <div className="saving-indicator flex items-center gap-1"><Icons.Cloud className="w-3 h-3 animate-bounce"/> å„²å­˜ä¸­...</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>