<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹ä¼‘ç®¡ç†ç³»çµ± (å‹åŸºæ³•å›æº¯ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/isBetween.min.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_isBetween);</script>
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; display: none; } 
        .tab-active { background-color: #2563eb; color: white; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allEmployees = [];
        let currentRole = 'caregiver'; 
        let currentStatusFilter = 'active'; 
        let currentEmpId = null;
        let currentEmpData = null;
        let ledgerData = []; 
        let unsubscribeLedger = null;
        let unsubscribeUsage = null;
        let currentGrantType = ""; 

        window.switchRole = switchRole;
        window.filterStatus = filterStatus;
        window.selectEmployee = selectEmployee;
        window.runAutoGrant = runAutoGrant; // â˜… æ ¸å¿ƒä¿®æ­£
        window.openGrantModal = openGrantModal; 
        window.closeManualModal = closeManualModal;
        window.submitManualGrant = submitManualGrant;
        window.openCashOutModal = openCashOutModal;
        window.closeCashOutModal = closeCashOutModal;
        window.submitCashOut = submitCashOut;
        window.addUsageRecord = addUsageRecord;
        window.deleteUsageRecord = deleteUsageRecord;
        window.deleteLedgerItem = deleteLedgerItem;
        window.logout = logout;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "employees", user.uid));
                    if (userDoc.exists() && (userDoc.data().role === 'admin' || userDoc.data().role === 'super_admin')) {
                        document.body.style.display = 'flex';
                        initSystem();
                    } else {
                        alert("â›” æ¬Šé™ä¸è¶³"); await signOut(auth); window.location.href = 'index.html';
                    }
                } catch (e) { alert("é©—è­‰éŒ¯èª¤"); window.location.href = 'index.html'; }
            } else { window.location.href = 'index.html'; }
        });

        async function logout() { if(confirm("ç™»å‡ºï¼Ÿ")) { await signOut(auth); window.location.href = 'index.html'; } }

        function initSystem() {
            onSnapshot(query(collection(db, "employees"), orderBy("code")), (snapshot) => {
                allEmployees = [];
                snapshot.forEach(doc => allEmployees.push({ id: doc.id, ...doc.data() }));
                renderEmployeeList();
            });
        }

        function switchRole(role) {
            currentRole = role;
            document.getElementById('btn-caregiver').className = role === 'caregiver' ? "w-32 py-2 font-bold rounded-l-lg bg-blue-600 text-white transition" : "w-32 py-2 font-bold rounded-l-lg bg-white text-slate-600 transition hover:bg-slate-50";
            document.getElementById('btn-admin').className = role === 'admin' ? "w-32 py-2 font-bold rounded-r-lg bg-purple-600 text-white transition" : "w-32 py-2 font-bold rounded-r-lg bg-white text-slate-600 transition hover:bg-slate-50";
            currentEmpId = null;
            document.getElementById('right-panel').classList.add('hidden');
            document.getElementById('empty-panel').classList.remove('hidden');
            renderEmployeeList();
        }

        function filterStatus(status) { currentStatusFilter = status; renderEmployeeList(); }

        function renderEmployeeList() {
            const list = document.getElementById('emp-list'); list.innerHTML = "";
            const filtered = allEmployees.filter(e => {
                if (currentRole === 'admin') {
                    if (e.role !== 'admin' && e.role !== 'super_admin') return false;
                } else {
                    if (e.role !== currentRole) return false;
                }
                if (currentStatusFilter === 'active') return !e.resignDate;
                if (currentStatusFilter === 'resigned') return !!e.resignDate;
                return true;
            });

            if(filtered.length === 0) { list.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">ç„¡ç¬¦åˆè³‡æ–™</div>`; return; }
            
            filtered.forEach(e => {
                const isResigned = !!e.resignDate;
                const statusBadge = isResigned ? '<span class="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold ml-2">é›¢è·</span>' : '';
                const activeClass = e.id === currentEmpId ? (currentRole === 'caregiver' ? 'bg-blue-50 border-l-4 border-blue-600' : 'bg-purple-50 border-l-4 border-purple-600') : 'hover:bg-slate-50 border-l-4 border-transparent';
                list.innerHTML += `<div onclick="selectEmployee('${e.id}')" class="p-3 cursor-pointer border-b transition ${activeClass}"><div class="flex justify-between items-center"><div class="font-bold text-slate-700 text-sm">${e.name} ${statusBadge}</div><div class="text-xs text-slate-400 font-mono">${e.code}</div></div><div class="text-xs text-slate-400 mt-1">åˆ°è·: ${e.joinDate}</div></div>`;
            });
        }

        function selectEmployee(id) {
            if (unsubscribeLedger) unsubscribeLedger();
            if (unsubscribeUsage) unsubscribeUsage();
            currentEmpId = id;
            currentEmpData = allEmployees.find(e => e.id === id);
            renderEmployeeList();

            document.getElementById('right-panel').classList.remove('hidden');
            document.getElementById('empty-panel').classList.add('hidden');
            document.getElementById('header-name').innerText = currentEmpData.name;
            document.getElementById('header-join').innerText = currentEmpData.joinDate;
            document.getElementById('header-seniority').innerText = calculateSeniority(currentEmpData.joinDate).text;
            if (currentEmpData.resignDate) {
                document.getElementById('resign-alert').classList.remove('hidden');
                document.getElementById('resign-date').innerText = currentEmpData.resignDate;
            } else {
                document.getElementById('resign-alert').classList.add('hidden');
            }

            unsubscribeLedger = onSnapshot(query(collection(db, "leave_ledger"), where("empId", "==", id)), (snap) => {
                ledgerData = [];
                snap.forEach(doc => ledgerData.push({ id: doc.id, ...doc.data() }));
                // æ’åºï¼šè®“æœ€æ™šéæœŸçš„åœ¨ä¸Šé¢
                ledgerData.sort((a, b) => dayjs(b.expiryDate).unix() - dayjs(a.expiryDate).unix());
                renderLedger();
            });

            unsubscribeUsage = onSnapshot(query(collection(db, "leave_records"), where("empId", "==", id)), (snap) => {
                let records = [];
                snap.forEach(doc => records.push({id: doc.id, ...doc.data()}));
                records.sort((a, b) => dayjs(b.date).unix() - dayjs(a.date).unix());
                renderUsageHistory(records);
            });
        }

        // ============================================================
        // â˜…â˜…â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šå…¨è‡ªå‹•å›æº¯è©¦ç®— (Ver 3.0 æ­£ç¢ºé‚è¼¯ç‰ˆ) â˜…â˜…â˜…
        // ============================================================
        async function runAutoGrant() {
            if (!currentEmpId || !currentEmpData) return alert("è«‹å…ˆé¸æ“‡å“¡å·¥");
            
            const joinDate = dayjs(currentEmpData.joinDate);
            const now = dayjs();
            const totalYears = now.diff(joinDate, 'year', true);

            // 1. é å…ˆæ’ˆå–å±…æœå“¡æœˆå ± (å¦‚æœæ˜¯å±…æœå“¡)
            let caregiverRecords = [];
            if (currentRole === 'caregiver') {
                const q = query(collection(db, "monthly_records"), where("empId", "==", currentEmpId));
                const snap = await getDocs(q);
                snap.forEach(d => caregiverRecords.push(d.data()));
            }

            // 2. å®šç¾©æ‰€æœ‰å¯èƒ½çš„é‡Œç¨‹ç¢‘ (å¾åˆ°è·æ—¥é–‹å§‹æ¨ç®—ï¼Œç›´åˆ°ä»Šå¤©)
            // é‚è¼¯ï¼š0.5, 1.0, 2.0, 3.0 ... N.0
            let milestones = [];
            
            // æª¢æŸ¥ 0.5 å¹´
            if (totalYears >= 0.5) milestones.push(0.5);
            
            // æª¢æŸ¥ 1.0, 2.0 ... N.0 å¹´
            for (let y = 1; y <= Math.floor(totalYears); y++) {
                milestones.push(y);
            }

            let pendingGrants = [];

            // 3. è¿´åœˆæª¢æŸ¥æ¯å€‹é‡Œç¨‹ç¢‘æ˜¯å¦å·²é ˜é
            for (let marker of milestones) {
                // 3.1 ç”¢ç”Ÿè©²é‡Œç¨‹ç¢‘çš„ã€Œç†è«–è³‡è¨Šã€(åç¨±ã€å€é–“ã€å¤©æ•¸)
                const info = getMilestoneInfo(marker, joinDate);
                
                // 3.2 é˜²å‘†æª¢æŸ¥ï¼šè³‡æ–™åº«æ˜¯å¦å·²å­˜åœ¨æ­¤é‡Œç¨‹ç¢‘ï¼Ÿ
                // æª¢æŸ¥é‚è¼¯ï¼šsourceType æ˜¯å¦åŒ…å«è©²åç¨± (ä¾‹å¦‚ "æ»¿ 1 å¹´ç‰¹ä¼‘")
                // ä¸” validFrom æ˜¯å¦ä¸€è‡´ (é¿å…åŒåä½†ä¸åŒå¹´åº¦çš„èª¤åˆ¤ï¼Œé›–ç„¶é€™è£¡æ˜¯ç”¨å¹´è³‡ç®—æ‡‰è©²ä¸æœƒ)
                const isDuplicate = ledgerData.some(l => 
                    l.sourceType.includes(info.title) && 
                    l.validFrom === info.validFrom // é›™é‡ç¢ºèªç”Ÿæ•ˆæ—¥
                );

                if (!isDuplicate) {
                    // 3.3 æ²’é ˜é -> é€²è¡Œè¨ˆç®—
                    let grantHours = 0;
                    if (currentRole === 'admin') {
                        grantHours = info.statutoryDays * 8; // è¡Œæ”¿å›ºå®š
                    } else {
                        // å±…æœå“¡ Pro-rata è¨ˆç®—
                        grantHours = calculateCaregiverHours(caregiverRecords, info.calcStart, info.calcEnd, info.benchmark, info.statutoryDays);
                    }

                    if (grantHours > 0) {
                        pendingGrants.push({ ...info, hours: grantHours });
                    }
                }
            }

            if (pendingGrants.length === 0) {
                return alert("âœ… ç›®å‰æ²’æœ‰éœ€è¦è£œç™¼çš„ç‰¹ä¼‘ã€‚\n(çš†å·²ç™¼æ”¾æˆ–å¹´è³‡æœªæ»¿)");
            }

            // 4. ç”¢ç”Ÿç¸½è¡¨è®“ç®¡ç†å“¡ç¢ºèª
            let msg = `ğŸ§™â€â™‚ï¸ è‡ªå‹•å›æº¯è©¦ç®—å ±å‘Š\nå“¡å·¥ï¼š${currentEmpData.name}\nç›®å‰å¹´è³‡ï¼š${totalYears.toFixed(2)} å¹´\n\nç™¼ç¾ä»¥ä¸‹æ¼ç™¼ (æˆ–éœ€è£œç™¼) çš„ç‰¹ä¼‘ï¼š\n--------------------------------\n`;
            
            pendingGrants.forEach(g => {
                msg += `ğŸ“Œ [${g.title}]\n`;
                msg += `   è¨ˆç®—å€é–“ï¼š${g.calcStart.format('YYYY-MM')} ~ ${g.calcEnd.format('YYYY-MM')}\n`;
                msg += `   ç”Ÿæ•ˆæ—¥æœŸï¼š${g.validFrom} (æ­·å²æ—¥æœŸ)\n`;
                msg += `   ä½¿ç”¨æœŸé™ï¼š${g.expiryDate} (ç”Ÿæ•ˆæ—¥+2å¹´)\n`;
                msg += `   æ ¸çµ¦æ™‚æ•¸ï¼š${g.hours} H\n\n`;
            });
            msg += `--------------------------------\nç¢ºå®šè¦ä¸€æ¬¡åŒ¯å…¥é€™ ${pendingGrants.length} ç­†è³‡æ–™å—ï¼Ÿ`;

            if (confirm(msg)) {
                const batch = writeBatch(db);
                pendingGrants.forEach(g => {
                    const ref = doc(collection(db, "leave_ledger"));
                    batch.set(ref, {
                        empId: currentEmpId,
                        sourceType: `${g.title} (è‡ªå‹•è©¦ç®—)`,
                        originalHours: g.hours,
                        remaining: g.hours,
                        validFrom: g.validFrom,
                        expiryDate: g.expiryDate,
                        createdAt: new Date().toISOString()
                    });
                });
                try {
                    await batch.commit();
                    alert("âœ… åŒ¯å…¥æˆåŠŸï¼");
                } catch(e) {
                    console.error(e);
                    alert("åŒ¯å…¥å¤±æ•—");
                }
            }
        }

        // è¼”åŠ©ï¼šå–å¾—é‡Œç¨‹ç¢‘çš„æ¨™æº–è³‡è¨Š (ä¸å«æ™‚æ•¸è¨ˆç®—)
        function getMilestoneInfo(yearMarker, joinDate) {
            let title, calcStart, calcEnd, validFrom, expiryDate, benchmark;
            const statutoryDays = getStatutoryDays(yearMarker);

            if (yearMarker === 0.5) {
                title = "æ»¿åŠå¹´ç‰¹ä¼‘";
                benchmark = 1044;
                // è¨ˆç®—å€é–“ï¼šåˆ°è·æ—¥ ~ +6å€‹æœˆ
                calcStart = joinDate.startOf('month');
                calcEnd = joinDate.add(6, 'month').endOf('month');
                // ç”Ÿæ•ˆæ—¥ï¼šåˆ°è·æ»¿6å€‹æœˆé‚£å¤©
                validFrom = joinDate.add(6, 'month').format('YYYY-MM-DD');
                // åˆ°æœŸæ—¥ï¼šç”Ÿæ•ˆæ—¥ + 2å¹´ (å‹åŸºæ³•éå»¶æ¦‚å¿µ)
                expiryDate = joinDate.add(6, 'month').add(2, 'year').format('YYYY-MM-DD');

            } else if (yearMarker === 1.0) {
                title = "æ»¿ 1 å¹´ç‰¹ä¼‘";
                benchmark = 2088;
                // è¨ˆç®—å€é–“ï¼šåˆ°è·æ—¥ ~ +12å€‹æœˆ
                calcStart = joinDate.startOf('month');
                calcEnd = joinDate.add(12, 'month').endOf('month');
                // ç”Ÿæ•ˆæ—¥ï¼šåˆ°è·æ»¿1å¹´é‚£å¤©
                validFrom = joinDate.add(1, 'year').format('YYYY-MM-DD');
                // åˆ°æœŸæ—¥ï¼šç”Ÿæ•ˆæ—¥ + 2å¹´
                expiryDate = joinDate.add(1, 'year').add(2, 'year').format('YYYY-MM-DD');

            } else {
                title = `æ»¿ ${yearMarker} å¹´ç‰¹ä¼‘`;
                benchmark = 2088;
                // è¨ˆç®—å€é–“ï¼šä¸Šä¸€å€‹é€±å¹´æ—¥ ~ é€™å€‹é€±å¹´æ—¥å‰ä¸€å€‹æœˆ (æ¨™æº–12å€‹æœˆ)
                calcStart = joinDate.add(yearMarker - 1, 'year').startOf('month');
                calcEnd = joinDate.add(yearMarker, 'year').subtract(1, 'month').endOf('month');
                // ç”Ÿæ•ˆæ—¥ï¼šåˆ°è·æ»¿ N å¹´é‚£å¤©
                validFrom = joinDate.add(yearMarker, 'year').format('YYYY-MM-DD');
                // åˆ°æœŸæ—¥ï¼šç”Ÿæ•ˆæ—¥ + 2å¹´
                expiryDate = joinDate.add(yearMarker, 'year').add(2, 'year').format('YYYY-MM-DD');
            }

            return { title, statutoryDays, benchmark, calcStart, calcEnd, validFrom, expiryDate };
        }

        // è¼”åŠ©ï¼šå±…æœå“¡æ™‚æ•¸è¨ˆç®—
        function calculateCaregiverHours(records, start, end, benchmark, days) {
            let totalBase = 0;
            records.forEach(r => {
                if (r.yearMonth) {
                    const rDate = dayjs(r.yearMonth + "-01");
                    // åŒ…å«é ­å°¾æœˆä»½
                    if (rDate.isBetween(start, end, 'month', '[]')) {
                        totalBase += Number(r.totalBaseHours) || 0;
                    }
                }
            });
            // å…¬å¼ï¼š(ç´¯ç© / åŸºæº–) * å¤©æ•¸ * 8
            const result = (totalBase / benchmark) * days * 8;
            return Math.round(result * 100) / 100;
        }

        function getStatutoryDays(years) {
            if (years < 0.5) return 0;
            if (years < 1) return 3;
            if (years < 2) return 7;
            if (years < 3) return 10;
            if (years < 5) return 14;
            if (years < 10) return 15;
            return Math.min(30, 15 + Math.floor(years - 10));
        }

        function renderLedger() {
            const container = document.getElementById('ledger-container'); container.innerHTML = "";
            let totalRemaining = 0, totalExpired = 0;
            const today = dayjs();
            if (ledgerData.length === 0) container.innerHTML = `<div class="p-4 text-center text-slate-400 text-sm">å°šç„¡å­˜æ‘ºè³‡æ–™</div>`;

            ledgerData.forEach(item => {
                const expiry = dayjs(item.expiryDate);
                // å¯¬é™æœŸåˆ¤æ–·ï¼šå¦‚æœéäº† expiryDate å°±ç®—éæœŸ
                const isExpired = expiry.isBefore(today);
                const isExhausted = item.remaining <= 0;
                
                if (!isExhausted) { 
                    if (isExpired) totalExpired += item.remaining; 
                    else totalRemaining += item.remaining; 
                }

                let statusHtml = "", rowClass = "hover:bg-slate-50";
                if (isExhausted) { statusHtml = `<span class="bg-gray-100 text-gray-400 text-xs px-2 py-1 rounded">å·²ç”¨å®Œ</span>`; rowClass = "bg-gray-50 opacity-60"; }
                else if (isExpired) { statusHtml = `<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded">å·²éæœŸ</span>`; }
                else { statusHtml = `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">ä½¿ç”¨ä¸­</span>`; }
                
                let sourceBadge = item.sourceType.includes("è£œä¼‘") ? 'âš¡ ' : (item.sourceType.includes("ç‰¹ä¼‘") ? 'ğŸ ' : 'ğŸ“¥ ');

                container.innerHTML += `<div class="grid grid-cols-12 gap-2 p-3 text-sm border-b items-center ${rowClass} group"><div class="col-span-3"><div class="font-bold text-slate-700 truncate" title="${item.sourceType}">${sourceBadge}${item.sourceType}</div><div class="text-[10px] text-slate-400">${item.validFrom} ç”Ÿæ•ˆ</div></div><div class="col-span-3 text-xs text-slate-500 flex flex-col justify-center"><span>æ•ˆæœŸè‡³</span><span class="font-mono text-slate-700 font-bold ${item.sourceType.includes('è£œä¼‘')?'text-orange-600':''}">${item.expiryDate}</span></div><div class="col-span-2 text-right text-slate-400 font-mono">${item.originalHours.toFixed(2)}</div><div class="col-span-2 text-right font-bold text-blue-600 font-mono text-lg">${item.remaining.toFixed(2)}</div><div class="col-span-2 text-right flex flex-col items-end gap-1">${statusHtml}<button onclick="deleteLedgerItem('${item.id}')" class="text-[10px] text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">åˆªé™¤</button></div></div>`;
            });
            document.getElementById('big-balance').innerText = totalRemaining.toFixed(2);
            document.getElementById('expired-section').classList.toggle('hidden', totalExpired <= 0);
            document.getElementById('expired-balance').innerText = totalExpired.toFixed(2);
        }

        function renderUsageHistory(records) {
            const tbody = document.getElementById('history-list'); tbody.innerHTML = "";
            if(records.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400 text-sm">å°šç„¡è«‹å‡ç´€éŒ„</td></tr>`; return; }
            records.forEach(r => {
                const logStr = r.deductionLog ? JSON.stringify(r.deductionLog) : "";
                let typeClass = "bg-gray-100 text-gray-600";
                if(r.type.includes('ç‰¹ä¼‘')||r.type.includes('è£œä¼‘')||r.type.includes('æœ‰è–ª')) typeClass = "bg-green-100 text-green-700";
                else if(r.type === 'cash_out') typeClass = "bg-yellow-100 text-yellow-800 border border-yellow-300"; 
                else if(r.type.includes('ç—…')||r.type.includes('å–ª')) typeClass = "bg-purple-100 text-purple-700";
                
                let detailHint = "";
                if(r.deductionLog && r.deductionLog.length > 0) detailHint = `<div class="text-[10px] text-slate-400 mt-1">â”” æ‰£: ${r.deductionLog[0].source}</div>`;

                tbody.innerHTML += `<tr class="border-b hover:bg-slate-50 text-sm"><td class="p-3 font-mono">${r.date}</td><td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${typeClass}">${r.type==='cash_out'?'ğŸ’° æŠ˜ç¾':r.type}</span>${detailHint}</td><td class="p-3 font-bold text-center">${r.hours}</td><td class="p-3 text-slate-500 text-xs">${r.note||''}</td><td class="p-3 text-center"><button onclick="deleteUsageRecord('${r.id}', '${r.type}', '${logStr.replace(/"/g, '&quot;')}')" class="text-red-400 hover:text-red-600 font-bold">Ã—</button></td></tr>`;
            });
        }

        function openGrantModal(type) {
            if (!currentEmpId) return;
            currentGrantType = type;
            document.getElementById('manual-grant-modal').classList.remove('hidden');
            const title = document.getElementById('modal-title');
            const dateInput = document.getElementById('mg-date'); 
            const expiryInput = document.getElementById('mg-expiry'); 
            document.getElementById('mg-hours').value = '';
            dateInput.value = dayjs().format('YYYY-MM-DD');
            if (type === 'old_balance') { title.innerHTML = '<span class="text-2xl">ğŸ“¥</span> è£œå…¥æœŸåˆ/èˆŠåˆ¶é¤˜é¡'; expiryInput.value = dayjs().add(1, 'year').format('YYYY-MM-DD'); } 
            else if (type === 'comp_time') { title.innerHTML = '<span class="text-2xl">âš¡</span> æ–°å¢åŠ ç­è£œä¼‘'; expiryInput.value = dayjs().add(1, 'year').format('YYYY-MM-DD'); }
        }
        function closeManualModal() { document.getElementById('manual-grant-modal').classList.add('hidden'); }
        
        async function submitManualGrant() {
            const hours = parseFloat(document.getElementById('mg-hours').value);
            const dateStr = document.getElementById('mg-date').value;
            const expiryStr = document.getElementById('mg-expiry').value;
            if (isNaN(hours) || hours <= 0 || !dateStr || !expiryStr) return alert("è«‹å¡«å¯«æ­£ç¢º");
            let sourceType = currentGrantType === 'old_balance' ? "æœŸåˆç§»è½‰é¤˜é¡" : `åŠ ç­è£œä¼‘ (${dateStr})`;
            try { await addDoc(collection(db, "leave_ledger"), { empId: currentEmpId, sourceType, originalHours: hours, remaining: hours, validFrom: dateStr, expiryDate: expiryStr, createdAt: new Date().toISOString() }); closeManualModal(); } catch(e) { alert("å¤±æ•—"); }
        }

        function openCashOutModal() {
            if (!currentEmpId) return;
            const val = parseFloat(document.getElementById('big-balance').innerText) || 0;
            if(val === 0) return alert("ç„¡é¤˜é¡");
            document.getElementById('cash-out-modal').classList.remove('hidden');
            document.getElementById('co-date').value = dayjs().format('YYYY-MM-DD');
            document.getElementById('co-hours').value = val;
        }
        function closeCashOutModal() { document.getElementById('cash-out-modal').classList.add('hidden'); }
        
        async function submitCashOut() {
            const date = document.getElementById('co-date').value;
            const hours = parseFloat(document.getElementById('co-hours').value);
            if (!date || isNaN(hours) || hours <= 0) return alert("éŒ¯èª¤");
            const activeLedgers = ledgerData.filter(l => l.remaining > 0).sort((a,b)=>dayjs(a.expiryDate).unix()-dayjs(b.expiryDate).unix());
            if(activeLedgers.reduce((s,l)=>s+l.remaining,0) < hours) return alert("é¤˜é¡ä¸è¶³");
            const batch = writeBatch(db);
            let rem = hours; let logs = [];
            for(let l of activeLedgers) {
                if(rem<=0) break;
                const deduct = Math.min(l.remaining, rem);
                batch.update(doc(db,"leave_ledger",l.id), {remaining: l.remaining-deduct});
                logs.push({ledgerId:l.id, source:l.sourceType, amount:deduct});
                rem -= deduct;
            }
            batch.set(doc(collection(db,"leave_records")), { empId:currentEmpId, date, type:'cash_out', hours, note:'æŠ˜ç¾', deductionLog:logs, createdAt:new Date().toISOString() });
            await batch.commit(); closeCashOutModal(); alert("å®Œæˆ");
        }

        async function addUsageRecord() {
            if (!currentEmpId) return;
            const date = document.getElementById('rec-date').value;
            const type = document.getElementById('rec-type').value;
            const hours = parseFloat(document.getElementById('rec-hours').value);
            const note = document.getElementById('rec-note').value;
            if (!date || !hours || hours <= 0) return alert("è«‹å¡«å¯«æ­£ç¢º");
            if (type !== 'paid_leave') {
                const typeMap = { 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'funeral': 'å–ªå‡', 'marriage': 'å©šå‡', 'official': 'å…¬å‡' };
                await addDoc(collection(db, "leave_records"), { empId: currentEmpId, date, type: typeMap[type]||type, hours, note, deductionLog: [], createdAt: new Date().toISOString() });
                document.getElementById('rec-hours').value = ""; return;
            }
            const active = ledgerData.filter(l=>l.remaining>0 && dayjs(l.expiryDate).isAfter(dayjs())).sort((a,b)=>dayjs(a.expiryDate).unix()-dayjs(b.expiryDate).unix());
            if(active.reduce((s,l)=>s+l.remaining,0) < hours) return alert("é¤˜é¡ä¸è¶³");
            const batch = writeBatch(db);
            let rem = hours; let logs = [];
            for(let l of active) {
                if(rem<=0) break;
                const deduct = Math.min(l.remaining, rem);
                batch.update(doc(db,"leave_ledger",l.id), {remaining: l.remaining-deduct});
                logs.push({ledgerId:l.id, source:l.sourceType, amount:deduct});
                rem -= deduct;
            }
            batch.set(doc(collection(db,"leave_records")), { empId:currentEmpId, date, type:'æœ‰è–ªå‡ (ç‰¹ä¼‘/è£œä¼‘)', hours, note, deductionLog:logs, createdAt:new Date().toISOString() });
            await batch.commit(); document.getElementById('rec-hours').value="";
        }

        async function deleteLedgerItem(id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) await deleteDoc(doc(db, "leave_ledger", id)); }
        async function deleteUsageRecord(id, type, deductionLogJson) {
            if (!confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ\n(è‹¥ç‚ºç‰¹ä¼‘ï¼Œå°‡è‡ªå‹•é€€é‚„é¡åº¦)")) return;
            const batch = writeBatch(db);
            if ((type.includes('ç‰¹ä¼‘') || type.includes('æœ‰è–ª') || type==='cash_out') && deductionLogJson) {
                const logs = JSON.parse(deductionLogJson);
                for(let log of logs) {
                    const currentLedger = ledgerData.find(l => l.id === log.ledgerId);
                    if(currentLedger) batch.update(doc(db, "leave_ledger", log.ledgerId), { remaining: currentLedger.remaining + log.amount });
                }
            }
            batch.delete(doc(db, "leave_records", id));
            await batch.commit();
        }

        function calculateSeniority(joinDateStr) {
            if(!joinDateStr) return { text: "-", years: 0 };
            const diff = dayjs().diff(dayjs(joinDateStr), 'year', true);
            return { text: `${Math.floor(diff)}å¹´ ${Math.floor((diff%1)*365)}å¤©`, years: diff };
        }
    </script>
</head>
<body class="h-screen flex flex-col p-6 overflow-hidden">
    <div class="flex justify-between items-center mb-6 shrink-0">
        <div><h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">ğŸ“… ç‰¹ä¼‘èˆ‡è£œä¼‘ç®¡ç†ç³»çµ±</h1></div>
        <div class="flex gap-3">
             <div class="bg-white border rounded-lg flex shadow-sm">
                <button id="btn-caregiver" onclick="switchRole('caregiver')" class="w-32 py-2 font-bold rounded-l-lg bg-blue-600 text-white transition">ğŸ  å±…æœå“¡</button>
                <button id="btn-admin" onclick="switchRole('admin')" class="w-32 py-2 font-bold rounded-r-lg bg-white text-slate-600 transition hover:bg-slate-50">ğŸ’¼ è¡Œæ”¿</button>
            </div>
            <button onclick="logout()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-300">ç™»å‡º</button>
        </div>
    </div>

    <div class="flex-1 grid grid-cols-12 gap-6 min-h-0">
        <div class="col-span-3 bg-white rounded-2xl shadow-lg border border-slate-200 flex flex-col overflow-hidden">
            <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
                <span class="font-bold text-slate-500 text-xs">å“¡å·¥åˆ—è¡¨</span>
                <select onchange="filterStatus(this.value)" class="text-xs border rounded p-1 bg-white outline-none cursor-pointer hover:bg-slate-100"><option value="active">é¡¯ç¤ºåœ¨è·</option><option value="resigned">é¡¯ç¤ºé›¢è·</option><option value="all">é¡¯ç¤ºå…¨éƒ¨</option></select>
            </div>
            <div id="emp-list" class="flex-1 overflow-y-auto"></div>
        </div>

        <div class="col-span-9 h-full relative">
            <div id="empty-panel" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white/60 border-2 border-dashed border-slate-300 rounded-2xl">
                <div class="text-4xl mb-2">ğŸ‘ˆ</div><div>è«‹é¸æ“‡å“¡å·¥ä»¥æª¢è¦–è³‡æ–™</div>
            </div>

            <div id="right-panel" class="hidden h-full flex flex-col gap-6">
                <div class="bg-white p-5 rounded-2xl shadow-md border border-slate-200 flex justify-between items-start shrink-0">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                            <span id="header-name">---</span>
                            <span id="resign-alert" class="hidden bg-red-100 text-red-600 text-sm px-2 py-1 rounded">âš ï¸ å·²é›¢è· (<span id="resign-date"></span>)</span>
                        </h2>
                        <div class="flex gap-4 mt-2 text-sm text-slate-500">
                            <span>åˆ°è·: <b id="header-join" class="text-slate-700">-</b></span>
                            <span>å¹´è³‡: <b id="header-seniority" class="text-slate-700">-</b></span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Available</div>
                        <div class="text-5xl font-black text-blue-600 tracking-tight" id="big-balance">0.00</div>
                        <div class="text-xs text-slate-400 font-bold mt-1">å¯ç”¨ç¸½æ™‚æ•¸ (å«éå»¶)</div>
                        <div id="expired-section" class="mt-3 pt-2 border-t border-slate-100 hidden">
                            <div class="text-2xl font-bold text-red-500" id="expired-balance">0.00</div>
                            <div class="text-xs text-red-400 font-bold">å¾…çµç®—æ™‚æ•¸ (å·²éæœŸ)</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 min-h-0 flex-1">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ“š ç‰¹ä¼‘/è£œä¼‘å­˜æ‘º (FIFO)</h3>
                            <div class="flex gap-1">
                                <button onclick="runAutoGrant()" class="bg-purple-100 hover:bg-purple-200 text-purple-800 border border-purple-300 px-2 py-1 rounded text-xs font-bold shadow-sm transition">ğŸ§™â€â™‚ï¸ è‡ªå‹•è©¦ç®—</button>
                                <button onclick="openCashOutModal()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 border border-yellow-300 px-2 py-1 rounded text-xs font-bold shadow-sm transition">ğŸ’° æŠ˜ç¾</button>
                                <button onclick="openGrantModal('comp_time')" class="bg-orange-50 border border-orange-200 hover:bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold shadow-sm transition">+ è£œä¼‘</button>
                                <button onclick="openGrantModal('old_balance')" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-2 py-1 rounded text-xs font-bold shadow-sm transition">+ èˆŠé¤˜é¡</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-12 gap-2 p-2 bg-slate-100 text-xs text-slate-500 font-bold border-b">
                            <div class="col-span-3">ä¾†æº / ç”Ÿæ•ˆ</div><div class="col-span-3">æ•ˆæœŸè‡³</div><div class="col-span-2 text-right">åŸå§‹</div><div class="col-span-2 text-right">å‰©é¤˜</div><div class="col-span-2 text-right">ç‹€æ…‹</div>
                        </div>
                        <div id="ledger-container" class="flex-1 overflow-y-auto bg-white"></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b" id="usage-form">
                            <div class="flex gap-2 mb-2">
                                <div class="flex-1"><label class="text-[10px] font-bold text-slate-400 block mb-1">æ—¥æœŸ</label><input type="date" id="rec-date" class="w-full border rounded px-2 py-1 text-sm font-bold text-slate-700"></div>
                                <div class="w-32"><label class="text-[10px] font-bold text-slate-400 block mb-1">å‡åˆ¥</label><select id="rec-type" class="w-full border rounded px-1 py-1 text-sm bg-white font-bold text-slate-700"><option value="paid_leave">æœ‰è–ªå‡ (ç‰¹ä¼‘/è£œä¼‘)</option><option value="sick">ç—…å‡</option><option value="personal">äº‹å‡</option><option value="funeral">å–ªå‡</option><option value="marriage">å©šå‡</option><option value="official">å…¬å‡</option></select></div>
                                <div class="w-20"><label class="text-[10px] font-bold text-slate-400 block mb-1">æ™‚æ•¸</label><input type="number" id="rec-hours" class="w-full border rounded px-2 py-1 text-sm text-center font-bold" placeholder="4"></div>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="rec-note" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="äº‹ç”± (é¸å¡«)">
                                <button onclick="addUsageRecord()" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded text-sm font-bold shadow">æ‰£é™¤</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto bg-white">
                            <table class="w-full text-sm text-left"><thead class="bg-slate-100 text-xs text-slate-500 font-bold sticky top-0"><tr><th class="p-3 w-28">æ—¥æœŸ</th><th class="p-3 w-28">å‡åˆ¥</th><th class="p-3 w-16 text-center">æ™‚æ•¸</th><th class="p-3">å‚™è¨»</th><th class="p-3 w-10"></th></tr></thead><tbody id="history-list" class="divide-y divide-slate-100"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="manual-grant-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm"><div class="bg-white p-6 rounded-2xl w-96"><h3 id="modal-title" class="font-bold text-lg mb-4"></h3><input type="date" id="mg-date" class="w-full border rounded mb-2"><input type="number" id="mg-hours" class="w-full border rounded mb-2" placeholder="æ™‚æ•¸"><input type="date" id="mg-expiry" class="w-full border rounded mb-2"><div class="flex justify-end gap-2"><button onclick="closeManualModal()" class="px-3 py-1 border rounded">å–æ¶ˆ</button><button onclick="submitManualGrant()" class="px-3 py-1 bg-blue-600 text-white rounded">ç¢ºèª</button></div></div></div>
    <div id="cash-out-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm"><div class="bg-white p-6 rounded-2xl w-96"><h3 class="font-bold text-lg mb-4">ğŸ’° æŠ˜ç¾</h3><input type="date" id="co-date" class="w-full border rounded mb-2"><input type="number" id="co-hours" class="w-full border rounded mb-2" placeholder="æ™‚æ•¸"><div class="flex justify-end gap-2"><button onclick="closeCashOutModal()" class="px-3 py-1 border rounded">å–æ¶ˆ</button><button onclick="submitCashOut()" class="px-3 py-1 bg-yellow-500 text-white rounded">ç¢ºèª</button></div></div></div>
</body>
</html>