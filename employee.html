<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±…æœå“¡è³‡æ–™åº« (å«å¯†ç¢¼è¨­å®š)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” éæ³•å­˜å–ï¼\n\nè«‹ç”±ã€Œç®¡ç†å¾Œå°ã€ç™»å…¥å¾Œæ“ä½œã€‚");
                window.top.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; } 
        .modal { transition: opacity 0.25s ease; }
        .tab-active-caregiver { background-color: #2563eb; color: white; }
        .tab-active-admin { background-color: #7c3aed; color: white; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // â˜… æ–°å¢ï¼šå¼•å…¥ Auth æ¨¡çµ„ï¼Œé€™æ¨£è³‡æ–™åº«æ‰çŸ¥é“ä½ æ˜¯èª°
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // â˜… åˆå§‹åŒ– Auth

        let employeeList = [];
        let isEditing = false;
        let currentEditId = null;
        let currentFilter = 'active'; 
        let currentRoleTab = 'caregiver'; 
        let currentEmpIdForMonth = null; 

        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveEmployee = saveEmployee;
        window.editEmployee = editEmployee;
        window.deleteEmployee = deleteEmployee;
        window.setFilter = setFilter;
        window.switchRoleTab = switchRoleTab;
        window.openMonthlyModal = openMonthlyModal;
        window.closeMonthlyModal = closeMonthlyModal;
        window.saveMonthlyRecord = saveMonthlyRecord;
        window.deleteMonthlyRecord = deleteMonthlyRecord;
        window.calcTotal = calcTotal;

        // â˜… ä¿®æ”¹ï¼šç­‰å¾… Auth ç¢ºèªèº«åˆ†å¾Œï¼Œæ‰å»æŠ“è³‡æ–™
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // èº«åˆ†ç¢ºèªæˆåŠŸï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«
                const q = query(collection(db, "employees"), orderBy("code"));
                onSnapshot(q, (snapshot) => {
                    employeeList = [];
                    snapshot.forEach(doc => employeeList.push({ id: doc.id, ...doc.data() }));
                    renderTable();
                }, (error) => {
                    console.error("è³‡æ–™è®€å–å¤±æ•—:", error);
                    // å¦‚æœé‚„æ˜¯å¤±æ•—ï¼Œé€šå¸¸æ˜¯å› ç‚ºè¦å‰‡æ²’è¨­å¥½æˆ–ç™»å…¥éæœŸ
                });
            } else {
                // å¦‚æœ Auth èªªæ²’ç™»å…¥ï¼Œé€™é é¢ä¹ŸæŠ“ä¸åˆ°è³‡æ–™
                console.log("æœªåµæ¸¬åˆ° Firebase Auth ç™»å…¥ç‹€æ…‹");
            }
        });

        function switchRoleTab(role) {
            currentRoleTab = role;
            const btnCare = document.getElementById('tab-caregiver');
            const btnAdmin = document.getElementById('tab-admin');
            
            if (role === 'caregiver') {
                btnCare.className = "flex-1 py-2 text-center font-bold rounded-l-lg border transition tab-active-caregiver shadow-inner";
                btnAdmin.className = "flex-1 py-2 text-center font-bold rounded-r-lg border transition bg-white text-slate-500 hover:bg-slate-50";
                document.getElementById('list-header').className = "bg-blue-50 text-blue-800 font-bold text-sm border-b border-blue-100";
            } else {
                btnCare.className = "flex-1 py-2 text-center font-bold rounded-l-lg border transition bg-white text-slate-500 hover:bg-slate-50";
                btnAdmin.className = "flex-1 py-2 text-center font-bold rounded-r-lg border transition tab-active-admin shadow-inner";
                document.getElementById('list-header').className = "bg-purple-50 text-purple-800 font-bold text-sm border-b border-purple-100";
            }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('emp-table-body');
            tbody.innerHTML = "";
            
            let displayList = employeeList.filter(e => {
                if (e.role !== currentRoleTab) return false;
                if (currentFilter === 'active') return !e.resignDate;
                if (currentFilter === 'resigned') return !!e.resignDate;
                return true;
            });

            const totalCaregivers = employeeList.filter(e => e.role === 'caregiver' && !e.resignDate).length;
            const totalAdmins = employeeList.filter(e => e.role === 'admin' && !e.resignDate).length;
            
            document.getElementById('count-caregiver').innerText = totalCaregivers;
            document.getElementById('count-admin').innerText = totalAdmins;

            if (displayList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400">æ­¤åˆ†é¡ç„¡è³‡æ–™ (æˆ–è®€å–ä¸­...)</td></tr>`;
                return;
            }

            displayList.forEach(emp => {
                const statusBadge = emp.resignDate 
                    ? `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">é›¢è· (${emp.resignDate})</span>` 
                    : `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">åœ¨è·</span>`;

                let salaryInfo = "";
                if (emp.role === 'admin') {
                    salaryInfo = `<div class="text-xs text-slate-500">æœ¬è–ª: ${Number(emp.baseSalary||0).toLocaleString()} ${emp.password ? '<span class="text-purple-500 ml-1">ğŸ”’å·²è¨­å¯†ç¢¼</span>' : '<span class="text-red-300 ml-1">âš ï¸æœªè¨­å¯†ç¢¼</span>'}</div>`;
                } else {
                    salaryInfo = `<div class="text-xs text-slate-500">æ™‚è–ª: ${emp.hourlyWage||230} / è½‰å ´: ${emp.transitWage||196}</div>`;
                }

                const monthlyBtn = emp.role === 'caregiver' 
                    ? `<button onclick="openMonthlyModal('${emp.id}', '${emp.name}')" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded text-xs font-bold transition shadow-sm mr-2 flex items-center gap-1"><span class="text-xs">ğŸ“…</span> æœˆå ±</button>`
                    : ``;

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition ${emp.resignDate ? 'bg-slate-50 opacity-60' : ''}">
                        <td class="p-4 font-mono text-slate-500 font-bold">${emp.code || '-'}</td>
                        <td class="p-4">
                            <div class="font-bold text-slate-800 text-lg">${emp.name}</div>
                            <div class="text-xs text-slate-400">${emp.idCard || ''}</div>
                        </td>
                        <td class="p-4">
                            <div class="font-mono text-sm">${emp.joinDate}</div>
                            ${statusBadge}
                        </td>
                        <td class="p-4">${salaryInfo}</td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end items-center">
                                ${monthlyBtn}
                                <button onclick="editEmployee('${emp.id}')" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-3 py-1 rounded text-xs font-bold transition shadow-sm mr-2">ç·¨è¼¯</button>
                                <button onclick="deleteEmployee('${emp.id}', '${emp.name}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition" title="åˆªé™¤">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // --- æœˆå ±åŠŸèƒ½ (ç¶­æŒä¸è®Š) ---
        function openMonthlyModal(empId, empName) {
            currentEmpIdForMonth = empId;
            document.getElementById('monthly-emp-name').innerText = empName;
            document.getElementById('monthly-modal').classList.remove('hidden');
            const date = new Date();
            date.setMonth(date.getMonth() - 1);
            document.getElementById('m-month').value = date.toISOString().slice(0, 7); 
            loadMonthlyRecords(empId);
        }

        function closeMonthlyModal() {
            document.getElementById('monthly-modal').classList.add('hidden');
            document.getElementById('monthly-form').reset();
            currentEmpIdForMonth = null;
        }

        function loadMonthlyRecords(empId) {
            const tbody = document.getElementById('monthly-list');
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500">è®€å–ä¸­...</td></tr>';
            const q = query(collection(db, "monthly_records"), where("empId", "==", empId));
            onSnapshot(q, (snapshot) => {
                tbody.innerHTML = "";
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">å°šç„¡ç´€éŒ„</td></tr>';
                    return;
                }
                let records = [];
                snapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                records.sort((a, b) => b.yearMonth.localeCompare(a.yearMonth));
                records.forEach(d => {
                    const salary = d.salary ? Number(d.salary).toLocaleString() : 0;
                    const baseTotal = d.totalBaseHours || 0;
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50 transition">
                            <td class="p-3 text-center font-bold text-slate-700 bg-slate-50">${d.yearMonth}</td>
                            <td class="p-3 text-right font-mono font-bold text-slate-600">$${salary}</td>
                            <td class="p-3 text-right text-blue-600 font-black bg-blue-50/50">${baseTotal} H</td>
                            <td class="p-3 text-right text-xs text-slate-500 leading-tight">
                                <div class="mb-1"><span class="bg-gray-100 px-1 rounded">ä¸€èˆ¬</span> ${d.workHours||0} / è½‰ ${d.transitHours||0}</div>
                                <div><span class="bg-orange-50 text-orange-600 px-1 rounded">åŠ ç­</span> ${d.otWorkHours||0} / è½‰ ${d.otTransitHours||0}</div>
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="deleteMonthlyRecord('${d.id}')" class="text-red-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button>
                            </td>
                        </tr>`;
                });
            });
        }

        async function saveMonthlyRecord() {
            if (!currentEmpIdForMonth) return;
            const yearMonth = document.getElementById('m-month').value;
            const salary = Number(document.getElementById('m-salary').value) || 0;
            const workHours = Number(document.getElementById('m-work').value) || 0;
            const transitHours = Number(document.getElementById('m-transit').value) || 0;
            const otWorkHours = Number(document.getElementById('m-ot-work').value) || 0;
            const otTransitHours = Number(document.getElementById('m-ot-transit').value) || 0;
            const totalBaseHours = parseFloat((workHours + transitHours).toFixed(3));

            if (!yearMonth) return alert("è«‹é¸æ“‡æœˆä»½");

            try {
                const q = query(collection(db, "monthly_records"), where("empId", "==", currentEmpIdForMonth), where("yearMonth", "==", yearMonth));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    if(!confirm(`${yearMonth} çš„è³‡æ–™å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
                    const oldDocId = snapshot.docs[0].id;
                    await updateDoc(doc(db, "monthly_records", oldDocId), {
                        salary, workHours, transitHours, otWorkHours, otTransitHours, totalBaseHours, updatedAt: new Date().toISOString()
                    });
                } else {
                    await addDoc(collection(db, "monthly_records"), {
                        empId: currentEmpIdForMonth, yearMonth, salary, workHours, transitHours, otWorkHours, otTransitHours, totalBaseHours, createdAt: new Date().toISOString()
                    });
                }
                document.getElementById('m-salary').value = '';
                document.getElementById('m-work').value = '';
                document.getElementById('m-transit').value = '';
                document.getElementById('m-ot-work').value = '';
                document.getElementById('m-ot-transit').value = '';
                document.getElementById('calc-result').innerText = '0';
            } catch (e) { console.error(e); alert("å„²å­˜å¤±æ•—"); }
        }

        async function deleteMonthlyRecord(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "monthly_records", id)); }
        function calcTotal() {
            const w = Number(document.getElementById('m-work').value) || 0;
            const t = Number(document.getElementById('m-transit').value) || 0;
            document.getElementById('calc-result').innerText = (w + t).toFixed(3);
        }

        // --- å“¡å·¥ç®¡ç† ---
        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.type === type) { btn.classList.add('bg-slate-800', 'text-white'); btn.classList.remove('bg-white', 'text-slate-600'); } 
                else { btn.classList.remove('bg-slate-800', 'text-white'); btn.classList.add('bg-white', 'text-slate-600'); }
            });
            renderTable();
        }

        function openModal(mode) {
            const modal = document.getElementById('emp-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('emp-form');
            modal.classList.remove('hidden');
            if (mode === 'add') {
                isEditing = false;
                currentEditId = null;
                title.innerText = "â• æ–°å¢å“¡å·¥";
                form.reset();
                document.getElementById('e-role').value = currentRoleTab;
                if (currentRoleTab === 'caregiver') {
                    document.getElementById('e-hourlyWage').value = 230;
                    document.getElementById('e-transitWage').value = 196;
                    document.getElementById('e-hourlyBonus').value = 0;
                }
                toggleAdminFields();
                const relevantList = employeeList.filter(e => e.role === currentRoleTab);
                if (relevantList.length > 0) {
                    const codes = relevantList.map(e => parseInt(e.code.replace(/\D/g,'')) || 0);
                    const maxCode = Math.max(...codes);
                    document.getElementById('e-code').value = String(maxCode + 1).padStart(3, '0');
                }
            }
        }

        function closeModal() { document.getElementById('emp-modal').classList.add('hidden'); }

        window.toggleAdminFields = function() {
            const role = document.getElementById('e-role').value;
            const adminSection = document.getElementById('admin-fields');
            const caregiverSection = document.getElementById('caregiver-fields');
            if (role === 'admin') { adminSection.classList.remove('hidden'); caregiverSection.classList.add('hidden'); } 
            else { adminSection.classList.add('hidden'); caregiverSection.classList.remove('hidden'); }
        }

        function editEmployee(id) {
            const emp = employeeList.find(e => e.id === id);
            if (!emp) return;
            isEditing = true;
            currentEditId = id;
            document.getElementById('modal-title').innerText = "âœï¸ ç·¨è¼¯å“¡å·¥è³‡æ–™";
            document.getElementById('e-code').value = emp.code;
            document.getElementById('e-name').value = emp.name;
            document.getElementById('e-idCard').value = emp.idCard || '';
            document.getElementById('e-role').value = emp.role;
            document.getElementById('e-join').value = emp.joinDate;
            document.getElementById('e-resign').value = emp.resignDate || "";
            toggleAdminFields();
            
            // è¡Œæ”¿æ¬„ä½
            document.getElementById('e-baseSalary').value = emp.baseSalary || 0;
            document.getElementById('e-positionBonus').value = emp.positionBonus || 0;
            document.getElementById('e-fuelSubsidy').value = emp.fuelSubsidy || 0;
            document.getElementById('e-insuranceLevel').value = emp.insuranceLevel || 0;
            document.getElementById('e-laborIns').value = emp.laborIns || 0;
            document.getElementById('e-healthIns').value = emp.healthIns || 0;
            document.getElementById('e-healthInsFamily').value = emp.healthInsFamily || 0;
            // å¯†ç¢¼æ¬„ä½
            document.getElementById('e-password').value = emp.password || "";

            // å±…æœæ¬„ä½
            document.getElementById('e-pensionRate').value = emp.pensionRate || 0;
            document.getElementById('e-hasLicense').checked = emp.hasLicense || false;
            document.getElementById('e-hourlyWage').value = emp.hourlyWage || 230; 
            document.getElementById('e-hourlyBonus').value = emp.hourlyBonus || 0;
            document.getElementById('e-transitWage').value = emp.transitWage || 196; 
            document.getElementById('emp-modal').classList.remove('hidden');
        }

        async function saveEmployee() {
            const code = document.getElementById('e-code').value.trim();
            const name = document.getElementById('e-name').value.trim();
            const role = document.getElementById('e-role').value;
            if (!name || !code) return alert("è«‹å¡«å¯«ç·¨è™Ÿèˆ‡å§“å");
            
            const empData = {
                code, name, role,
                idCard: document.getElementById('e-idCard').value.trim(),
                joinDate: document.getElementById('e-join').value,
                resignDate: document.getElementById('e-resign').value || null,
                
                // è¡Œæ”¿
                baseSalary: Number(document.getElementById('e-baseSalary').value) || 0,
                positionBonus: Number(document.getElementById('e-positionBonus').value) || 0,
                fuelSubsidy: Number(document.getElementById('e-fuelSubsidy').value) || 0,
                insuranceLevel: Number(document.getElementById('e-insuranceLevel').value) || 0,
                laborIns: Number(document.getElementById('e-laborIns').value) || 0,
                healthIns: Number(document.getElementById('e-healthIns').value) || 0,
                healthInsFamily: Number(document.getElementById('e-healthInsFamily').value) || 0,
                password: document.getElementById('e-password').value.trim(),

                // å±…æœ
                pensionRate: Number(document.getElementById('e-pensionRate').value) || 0,
                hasLicense: document.getElementById('e-hasLicense').checked,
                hourlyWage: Number(document.getElementById('e-hourlyWage').value) || 230,
                hourlyBonus: Number(document.getElementById('e-hourlyBonus').value) || 0,
                transitWage: Number(document.getElementById('e-transitWage').value) || 196,

                updatedAt: new Date().toISOString()
            };
            try {
                if (isEditing && currentEditId) { await updateDoc(doc(db, "employees", currentEditId), empData); } 
                else {
                    const qCheck = query(collection(db, "employees"), where("code", "==", code));
                    const snapCheck = await getDocs(qCheck);
                    if(!snapCheck.empty) return alert("ç·¨è™Ÿå·²å­˜åœ¨ï¼");
                    await addDoc(collection(db, "employees"), { ...empData, createdAt: new Date().toISOString() });
                }
                closeModal();
                alert("å„²å­˜æˆåŠŸ");
            } catch(e) { console.error(e); alert("å„²å­˜å¤±æ•—"); }
        }

        async function deleteEmployee(id) { if(confirm("âš ï¸ è­¦å‘Šï¼šå»ºè­°ä½¿ç”¨ã€Œé›¢è·æ—¥æœŸã€è€Œéåˆªé™¤ã€‚\n\nç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤è³‡æ–™å—ï¼Ÿ")) { await deleteDoc(doc(db, "employees", id)); } }
    </script>
</head>
<body class="bg-slate-100 min-h-screen p-8">

    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight mb-2">ğŸ‘¥ å“¡å·¥è³‡æ–™åº« (äººäº‹ä¸­å¿ƒ)</h1>
                <div class="flex gap-4 text-sm text-slate-500 font-bold bg-white px-4 py-2 rounded-lg shadow-sm border">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> å±…æœå“¡: <span id="count-caregiver" class="text-slate-800">0</span></span>
                    <span class="w-[1px] h-4 bg-slate-300"></span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-500"></span> è¡Œæ”¿: <span id="count-admin" class="text-slate-800">0</span></span>
                </div>
            </div>
            <div class="flex gap-2">
                <div class="bg-white p-1 rounded-lg shadow-sm border flex">
                    <button onclick="setFilter('active')" data-type="active" class="filter-btn bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold transition">åœ¨è·</button>
                    <button onclick="setFilter('resigned')" data-type="resigned" class="filter-btn bg-white text-slate-600 px-3 py-1 rounded text-sm font-bold transition hover:bg-slate-50">é›¢è·</button>
                    <button onclick="setFilter('all')" data-type="all" class="filter-btn bg-white text-slate-600 px-3 py-1 rounded text-sm font-bold transition hover:bg-slate-50">å…¨éƒ¨</button>
                </div>
                <button onclick="openModal('add')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    <span>â•</span> æ–°å¢
                </button>
            </div>
        </div>

        <div class="flex bg-white rounded-t-2xl border-b border-slate-200 mt-4 overflow-hidden shadow-sm">
            <button id="tab-caregiver" onclick="switchRoleTab('caregiver')" class="flex-1 py-3 text-center font-bold text-lg tab-active-caregiver transition flex items-center justify-center gap-2">
                <span>ğŸ </span> å±…æœå“¡è³‡æ–™
            </button>
            <button id="tab-admin" onclick="switchRoleTab('admin')" class="flex-1 py-3 text-center font-bold text-lg bg-white text-slate-500 hover:bg-slate-50 transition flex items-center justify-center gap-2">
                <span>ğŸ’¼</span> è¡Œæ”¿äººå“¡è³‡æ–™
            </button>
        </div>

        <div class="bg-white rounded-b-2xl shadow-sm border-x border-b border-slate-200 overflow-hidden min-h-[400px]">
            <table class="w-full text-left">
                <thead id="list-header" class="bg-blue-50 text-blue-800 font-bold text-sm border-b border-blue-100">
                    <tr>
                        <th class="p-4 w-24">ç·¨è™Ÿ</th>
                        <th class="p-4">å§“å / èº«åˆ†è­‰</th>
                        <th class="p-4">åˆ°è·ç‹€æ…‹</th>
                        <th class="p-4">è–ªè³‡åƒæ•¸æ‘˜è¦</th>
                        <th class="p-4 text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="emp-table-body" class="divide-y divide-slate-100 text-sm"></tbody>
            </table>
        </div>
    </div>

    <div id="emp-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800" id="modal-title">æ–°å¢å“¡å·¥</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <form id="emp-form" onsubmit="event.preventDefault(); saveEmployee();" class="space-y-6">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">å“¡å·¥ç·¨è™Ÿ</label><input type="text" id="e-code" class="w-full border rounded p-2 font-mono font-bold bg-slate-50" required></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">çœŸå¯¦å§“å</label><input type="text" id="e-name" class="w-full border rounded p-2 font-bold" required></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="e-idCard" class="w-full border rounded p-2 uppercase"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è·å‹™èº«åˆ†</label>
                        <select id="e-role" onchange="toggleAdminFields()" class="w-full border rounded p-2 font-bold text-slate-800 bg-white">
                            <option value="caregiver">ğŸ  å±…æœå“¡</option>
                            <option value="admin">ğŸ’¼ è¡Œæ”¿äººå“¡</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-blue-600 mb-1">åˆ°è·æ—¥æœŸ</label><input type="date" id="e-join" class="w-full border border-blue-200 bg-blue-50 rounded p-2 font-bold" required></div>
                    <div><label class="block text-xs font-bold text-red-500 mb-1">é›¢è·æ—¥æœŸ (é¸å¡«)</label><input type="date" id="e-resign" class="w-full border border-red-200 bg-red-50 rounded p-2 text-red-600"></div>
                </div>
                <hr class="border-slate-100">
                
                <div id="admin-fields" class="hidden space-y-4 bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <h4 class="text-sm font-bold text-purple-800 flex items-center gap-2">ğŸ’¼ è¡Œæ”¿äººå“¡è¨­å®š</h4>
                    
                    <div class="bg-white p-3 rounded border border-purple-200">
                        <label class="block text-xs font-bold text-purple-600 mb-1">ğŸ”‘ ç³»çµ±ç™»å…¥å¯†ç¢¼</label>
                        <input type="text" id="e-password" class="w-full border border-purple-300 rounded p-2 font-mono text-slate-700" placeholder="è«‹è¨­å®šç™»å…¥å¯†ç¢¼">
                        <p class="text-[10px] text-slate-400 mt-1">* æ­¤å¯†ç¢¼ç”¨æ–¼ç™»å…¥å¾Œå°ç®¡ç†ç³»çµ±ï¼Œè«‹å¦¥å–„ä¿ç®¡ã€‚</p>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">æœ¬è–ª</label><input type="number" id="e-baseSalary" class="w-full border rounded p-2 text-right"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">è·å‹™åŠ çµ¦</label><input type="number" id="e-positionBonus" class="w-full border rounded p-2 text-right"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">æ²¹è³‡è£œåŠ©</label><input type="number" id="e-fuelSubsidy" class="w-full border rounded p-2 text-right"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">æŠ•ä¿ç´šè·</label><input type="number" id="e-insuranceLevel" class="w-full border rounded p-2 text-right text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">å‹ä¿è‡ªä»˜</label><input type="number" id="e-laborIns" class="w-full border rounded p-2 text-right text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">å¥ä¿è‡ªä»˜</label><input type="number" id="e-healthIns" class="w-full border rounded p-2 text-right text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">çœ·å±¬å¥ä¿</label><input type="number" id="e-healthInsFamily" class="w-full border rounded p-2 text-right text-sm"></div>
                    </div>
                </div>

                <div id="caregiver-fields" class="space-y-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 flex items-center gap-2">ğŸ  å±…æœå“¡è¨­å®š</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold text-blue-800 mb-1">å±…æœæ™‚è–ª</label><input type="number" id="e-hourlyWage" class="w-full border rounded p-2 text-right font-bold text-blue-600" value="230"></div>
                        <div><label class="block text-xs font-bold text-blue-800 mb-1">æ™‚è–ªåŠ æˆ</label><input type="number" id="e-hourlyBonus" class="w-full border rounded p-2 text-right" value="0"></div>
                        <div><label class="block text-xs font-bold text-blue-800 mb-1">è½‰å ´è²»ç‡</label><input type="number" id="e-transitWage" class="w-full border rounded p-2 text-right font-bold text-blue-600" value="196"></div>
                    </div>
                    <div class="flex gap-6 items-center border-t border-blue-100 pt-3">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">å‹é€€è‡ªæ (%)</label><input type="number" id="e-pensionRate" class="w-24 border rounded p-2 text-center" placeholder="0"></div>
                        <label class="flex items-center gap-2 cursor-pointer mt-4">
                            <input type="checkbox" id="e-hasLicense" class="w-5 h-5 text-blue-600 rounded"><span class="text-sm font-bold text-slate-700">æŒæœ‰å–®ä¸€ç´šè­‰ç…§ (ä¸™è­‰)</span>
                        </label>
                    </div>
                </div>
                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl hover:bg-slate-200 transition">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 py-3 font-bold text-white bg-blue-600 rounded-xl shadow-lg hover:bg-blue-700 transition">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <div id="monthly-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-xl">
                <h3 class="text-lg font-bold">ğŸ“… æœˆå ±ç´€éŒ„ï¼š<span id="monthly-emp-name" class="text-yellow-300"></span></h3>
                <button onclick="closeMonthlyModal()" class="text-white hover:text-slate-200 font-bold text-xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-white p-4 rounded-xl shadow border border-slate-200 h-fit">
                        <h4 class="font-bold text-slate-700 mb-4 border-b pb-2">æ–°å¢/ç·¨è¼¯ç´€éŒ„</h4>
                        <form id="monthly-form" onsubmit="event.preventDefault(); saveMonthlyRecord();">
                            <div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1">æ‰€å±¬æœˆä»½</label><input type="month" id="m-month" class="w-full p-2 border border-slate-300 rounded font-bold text-slate-700" required></div>
                            <div class="mb-4"><label class="block text-xs font-bold text-green-600 mb-1">æœ¬æœˆç”³å ±è–ªè³‡ (è¨˜å¸³ç”¨)</label><input type="number" id="m-salary" class="w-full p-2 border border-green-300 bg-green-50 rounded text-right font-bold" placeholder="0"></div>
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 mb-4 space-y-3">
                                <div class="text-xs font-bold text-blue-800 border-b border-blue-200 pb-1 mb-2">å·¥æ™‚ç´€éŒ„ (å°æ™‚)</div>
                                <div class="flex gap-2">
                                    <div class="w-1/2"><label class="text-xs text-slate-500">ä¸€èˆ¬å·¥æ™‚</label><input type="number" id="m-work" step="0.001" class="w-full p-1 border rounded text-center" oninput="calcTotal()"></div>
                                    <div class="w-1/2"><label class="text-xs text-slate-500">ä¸€èˆ¬è½‰å ´</label><input type="number" id="m-transit" step="0.001" class="w-full p-1 border rounded text-center" oninput="calcTotal()"></div>
                                </div>
                                <div class="text-xs text-right text-blue-600 font-bold">ç‰¹ä¼‘åŸºæ•¸å°è¨ˆï¼š<span id="calc-result">0</span> H</div>
                                <div class="flex gap-2 opacity-75">
                                    <div class="w-1/2"><label class="text-xs text-slate-400">åŠ ç­å·¥æ™‚</label><input type="number" id="m-ot-work" step="0.001" class="w-full p-1 border rounded text-center bg-slate-50"></div>
                                    <div class="w-1/2"><label class="text-xs text-slate-400">åŠ ç­è½‰å ´</label><input type="number" id="m-ot-transit" step="0.001" class="w-full p-1 border rounded text-center bg-slate-50"></div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
                        </form>
                    </div>
                    <div class="md:col-span-2 bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex flex-col">
                        <div class="bg-slate-100 p-3 font-bold text-slate-600 text-sm border-b">æ­·å²ç´€éŒ„ (ç”±æ–°åˆ°èˆŠ)</div>
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500"><tr><th class="p-2 text-center">æœˆä»½</th><th class="p-2 text-right">è–ªè³‡</th><th class="p-2 text-right text-blue-600">ç‰¹ä¼‘åŸºæ•¸</th><th class="p-2 text-right">å·¥æ™‚æ˜ç´°</th><th class="p-2 text-center">æ“ä½œ</th></tr></thead><tbody id="monthly-list"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
