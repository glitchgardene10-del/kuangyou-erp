<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæ”¿äººå“¡è–ªè³‡ç®¡ç†ç³»çµ± (æœƒè¨ˆæ­¸æª”ç‰ˆ)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” éæ³•å­˜å–ï¼\n\nè«‹ç”±ã€Œç®¡ç†å¾Œå°ã€ç™»å…¥å¾Œæ“ä½œã€‚");
                window.top.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>

    <style>
        body { opacity: 0; animation: fadeIn 0.5s forwards; font-family: "Microsoft JhengHei", sans-serif; }
        @keyframes fadeIn { to { opacity: 1; } }
        .salary-slip { border: 2px solid #000; background: white; color: black; width: 210mm; min-height: 297mm; padding: 40px; box-sizing: border-box; position: relative; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #batch-container { position: absolute; top: -9999px; left: -9999px; }
    </style>

 <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
    </script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">
    <div id="root"></div>
    <div id="batch-container"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Calculator = (p) => <Icon {...p} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />;
        const Package = (p) => <Icon {...p} path={<><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></>} />;
        const Refresh = (p) => <Icon {...p} path={<><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"/></>} />;
        const SaveDisk = (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const ImageDown = (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></>} />;

        const DEFAULT_MONTHLY_DATA = {
            performanceBonus: 0, festivalBonus: 0, birthdayBonus: 0, otherPlus: 0,
            otherDeduct: 0, pensionSelfRate: 0,
            
            // æ‰£æ¬¾é¡ (åŠè–ª/ç„¡è–ª)
            sickLeaveHours: 0, menstrualLeaveHours: 0,
            personalLeaveHours: 0, familyCareLeaveHours: 0,

            // ä¸æ‰£æ¬¾é¡ (å…¨è–ª)
            specialLeaveHours: 0, compLeaveHours: 0, funeralLeaveHours: 0,
            weddingLeaveHours: 0, prenatalLeaveHours: 0, paternityLeaveHours: 0,
            maternityLeaveHours: 0, ritualLeaveHours: 0, officialLeaveHours: 0,

            note: '',
            snapshot: null,
            finalResult: null // â˜… æ–°å¢ï¼šç”¨æ–¼å„²å­˜è¨ˆç®—çµæœ
        };

        const PayrollSystem = () => {
            const [employees, setEmployees] = useState([]);
            const [monthlyDataMap, setMonthlyDataMap] = useState({});
            const [currentMonth, setCurrentMonth] = useState(dayjs().format('YYYY-MM'));
            const [selectedEmpId, setSelectedEmpId] = useState('');
            const [loading, setLoading] = useState(false);
            const [filterStatus, setFilterStatus] = useState('active'); 
            const previewRef = useRef(null);

            useEffect(() => {
                const q = window.query(window.collection(window.db, "employees"), window.where("role", "==", "admin"));
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    let empList = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        empList.push({
                            id: doc.id,
                            empNo: data.code || '',
                            name: data.name,
                            position: 'è¡Œæ”¿äººå“¡',
                            baseSalary: Number(data.baseSalary) || 0,
                            positionBonus: Number(data.positionBonus) || 0,
                            fuelSubsidy: Number(data.fuelSubsidy) || 0,
                            insuranceLevel: Number(data.insuranceLevel) || 0,
                            laborIns: Number(data.laborIns) || 0,
                            healthIns: Number(data.healthIns) || 0,
                            healthInsFamily: Number(data.healthInsFamily) || 0,
                            hireDate: data.joinDate,
                            resignationDate: data.resignDate || ''
                        });
                    });
                    empList.sort((a,b) => a.empNo.localeCompare(b.empNo));
                    setEmployees(empList);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const docRef = window.doc(window.db, "salary_records_admin", currentMonth);
                const unsubscribe = window.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) setMonthlyDataMap(docSnap.data());
                    else setMonthlyDataMap({});
                });
                return () => unsubscribe();
            }, [currentMonth]);

            const getCurrentData = (empId) => monthlyDataMap[empId] || DEFAULT_MONTHLY_DATA;

            const updateCurrentData = (field, value) => {
                if (!selectedEmpId) return;
                const current = monthlyDataMap[selectedEmpId] || DEFAULT_MONTHLY_DATA;
                setMonthlyDataMap({ ...monthlyDataMap, [selectedEmpId]: { ...current, [field]: value } });
            };

            // â˜… ä¿®æ”¹ï¼šå„²å­˜æ™‚é€£åŒè¨ˆç®—çµæœä¸€èµ·å­˜å…¥ (Accounting Ready)
// â˜…â˜…â˜… ä¿®æ­£ç‰ˆ handleSaveï¼šå¼·åˆ¶è¨ˆç®—æ‰€æœ‰åœ¨è·è¡Œæ”¿äººå“¡ â˜…â˜…â˜…
            const handleSave = async () => {
                setLoading(true);
                try {
                    // 1. æº–å‚™ä¸€å€‹æ–°çš„å®¹å™¨ï¼Œä¸ä¾è³´ monthlyDataMap (å› ç‚ºæ–°æœˆä»½å®ƒæ˜¯ç©ºçš„)
                    const dataToSave = {}; 
                    
                    // 2. éæ­·ã€Œæ‰€æœ‰æŠ“åˆ°çš„è¡Œæ”¿äººå“¡ã€ï¼Œç¢ºä¿æ¯å€‹äººéƒ½è¢«ç®—åˆ°
                    employees.forEach(emp => {
                        // å–å¾—è©²å“¡å·¥ç›®å‰çš„è³‡æ–™ï¼Œå¦‚æœæ²’æ”¹éå°±ç”¨é è¨­å€¼ (DEFAULT)
                        const currentData = monthlyDataMap[emp.id] || DEFAULT_MONTHLY_DATA;
                        
                        // åŸ·è¡Œè–ªè³‡è¨ˆç®— (é€™ä¸€æ­¥æœ€é‡è¦ï¼Œæœƒç”¢ç”Ÿ grossSalary ç­‰æ•¸æ“š)
                        const result = calculatePayroll(emp, currentData);
                        
                        if (result) {
                            dataToSave[emp.id] = {
                                ...currentData,
                                // å»ºç«‹å¿«ç…§ (Snapshot) - é–å®šç•¶ä¸‹è²»ç‡
                                snapshot: {
                                    baseSalary: emp.baseSalary,
                                    positionBonus: emp.positionBonus,
                                    fuelSubsidy: emp.fuelSubsidy,
                                    laborIns: emp.laborIns,
                                    healthIns: emp.healthIns,
                                    insuranceLevel: emp.insuranceLevel
                                },
                                // â˜…â˜…â˜… å»ºç«‹æœƒè¨ˆæ­¸æª”çµæœ (Final Result) â˜…â˜…â˜…
                                // æœƒè¨ˆç³»çµ±å°±æ˜¯è®€å–é€™è£¡ï¼
                                finalResult: {
                                    grossSalary: result.grossSalary, // æ‡‰ç™¼
                                    netSalary: result.netSalary,     // å¯¦é ˜
                                    employerPension: result.pensionCompany, // å…¬å¸ææ’¥
                                    totalDeduction: result.deductRightTotal + result.deductLeftTotal, // ç¸½æ‰£æ¬¾
                                    payDays: result.payDays,
                                    isProrated: result.isProrated,
                                    calculatedAt: new Date().toISOString()
                                }
                            };
                        }
                    });

                    // 3. æª¢æŸ¥æ˜¯å¦æœ‰ç®—å‡ºè³‡æ–™
                    if (Object.keys(dataToSave).length === 0) {
                        alert("âš ï¸ æ²’æœ‰æœ‰æ•ˆçš„è¡Œæ”¿äººå“¡è³‡æ–™å¯å„²å­˜ï¼(è«‹ç¢ºèªå“¡å·¥åå–®æ˜¯å¦å·²è¼‰å…¥)");
                        setLoading(false);
                        return;
                    }

                    // 4. å¯«å…¥è³‡æ–™åº«
                    await window.setDoc(window.doc(window.db, "salary_records_admin", currentMonth), dataToSave, { merge: true });
                    alert(`âœ… æˆåŠŸæ­¸æª” ${Object.keys(dataToSave).length} ç­†è³‡æ–™ï¼\n\nè³‡æ–™åº«å·²æ›´æ–°ï¼Œç¾åœ¨å¯ä»¥å»æœƒè¨ˆç³»çµ±æ‹‹è½‰äº†ã€‚`);
                    
                } catch (e) { 
                    console.error(e); 
                    alert("å„²å­˜å¤±æ•—ï¼š" + e.message); 
                }
                setLoading(false);
            };

            const handleAutoFill = async () => {
                if (!selectedEmpId) return;
                setLoading(true);
                try {
                    const startStr = `${currentMonth}-01`;
                    const endStr = dayjs(currentMonth).endOf('month').format('YYYY-MM-DD');
                    
                    const qLeave = window.query(
                        window.collection(window.db, "leave_records"), 
                        window.where("empId", "==", selectedEmpId)
                    );
                    
                    const snapshot = await window.getDocs(qLeave);
                    
                    let newData = { ...getCurrentData(selectedEmpId) };
                    
                    // é‡ç½®
                    Object.keys(DEFAULT_MONTHLY_DATA).forEach(k => {
                        if(k.endsWith('Hours')) newData[k] = 0;
                    });
                    newData.otherPlus = 0;
                    
                    let cashOutTotal = 0; 
                    let cashOutNotes = [];
                    let matchCount = 0;

                    snapshot.forEach(doc => {
                        const r = doc.data();
                        if (r.date >= startStr && r.date <= endStr) {
                            matchCount++;
                            const hours = Number(r.hours) || 0;
                            const type = r.type || "";
                            
                            if (type.includes('ç”Ÿç†')) newData.menstrualLeaveHours += hours;
                            else if (type.includes('ç—…')) newData.sickLeaveHours += hours;
                            else if (type.includes('å®¶åº­')) newData.familyCareLeaveHours += hours;
                            else if (type.includes('äº‹')) newData.personalLeaveHours += hours;
                            else if (type.includes('ç‰¹ä¼‘')) newData.specialLeaveHours += hours;
                            else if (type.includes('è£œä¼‘')) newData.compLeaveHours += hours;
                            else if (type.includes('å©š')) newData.weddingLeaveHours += hours;
                            else if (type.includes('å–ª')) newData.funeralLeaveHours += hours;
                            else if (type.includes('ç”¢æª¢')) newData.prenatalLeaveHours += hours;
                            else if (type.includes('é™ªç”¢')) newData.paternityLeaveHours += hours;
                            else if (type.includes('ç”¢')) newData.maternityLeaveHours += hours;
                            else if (type.includes('ç¥­å„€')) newData.ritualLeaveHours += hours;
                            else if (type.includes('å…¬')) newData.officialLeaveHours += hours;
                            
                            else if (type === 'cash_out') {
                                const emp = employees.find(e => e.id == selectedEmpId);
                                if(emp) {
                                    const hourlyRate = (emp.baseSalary + emp.positionBonus) / 240; 
                                    const amount = Math.round(hourlyRate * hours);
                                    cashOutTotal += amount;
                                    cashOutNotes.push(`${r.date}æŠ˜ç¾${hours}H`);
                                }
                            }
                        }
                    });

                    if(cashOutTotal > 0) {
                        newData.otherPlus = cashOutTotal;
                        newData.note = (newData.note ? newData.note + '\n' : '') + `â˜… ç‰¹ä¼‘æŠ˜ç¾: $${cashOutTotal} (${cashOutNotes.join(', ')})`;
                    }

                    setMonthlyDataMap({ ...monthlyDataMap, [selectedEmpId]: newData });
                    alert(`âœ… è‡ªå‹•å¸¶å…¥æˆåŠŸï¼\næ‰¾åˆ° ${matchCount} ç­†è³‡æ–™ã€‚`);

                } catch(e) { console.error(e); alert(`âŒ å¤±æ•—ï¼š${e.message}`); }
                setLoading(false);
            };

            const calculateProrata = (emp, year, month) => {
                let payDays = 30; let isProrated = false; let reason = "";
                let hD = 0, isHireMonth = false; let rD = 0, isResignMonth = false;
                if (emp.hireDate) {
                    const [hY, hM, d] = emp.hireDate.replace(/\//g,'-').split('-').map(Number);
                    if (hY === year && hM === month) { isHireMonth = true; hD = d; }
                }
                if (emp.resignationDate) {
                    const [rY, rM, d] = emp.resignationDate.replace(/\//g,'-').split('-').map(Number);
                    if (rY === year && rM === month) { isResignMonth = true; rD = d; }
                }
                if (isHireMonth && isResignMonth) { payDays = rD - hD + 1; isProrated = true; reason = `çŸ­æœŸ (${month}/${hD}~${month}/${rD})`; } 
                else if (isHireMonth) { payDays = 30 - hD + 1; isProrated = true; reason = `æ–°é€² (${month}/${hD})`; } 
                else if (isResignMonth) { payDays = rD; isProrated = true; reason = `é›¢è· (${month}/${rD})`; }
                if (payDays < 0) payDays = 0;
                return { payDays, isProrated, reason };
            };

            const calculatePayroll = (emp, data) => {
                if (!emp) return null;
                const useSnapshot = data.snapshot && Object.keys(data.snapshot).length > 0;
                const baseFull = useSnapshot ? data.snapshot.baseSalary : (Number(emp.baseSalary) || 0);
                const posFull = useSnapshot ? data.snapshot.positionBonus : (Number(emp.positionBonus) || 0);
                const fuelFull = useSnapshot ? data.snapshot.fuelSubsidy : (Number(emp.fuelSubsidy) || 0);
                const laborInsFull = useSnapshot ? data.snapshot.laborIns : (Number(emp.laborIns) || 0);
                const insuranceLevel = useSnapshot ? data.snapshot.insuranceLevel : (Number(emp.insuranceLevel) || 0);
                const healthInsFull = useSnapshot ? data.snapshot.healthIns : (Number(emp.healthIns) || 0);

                const [year, month] = currentMonth.split('-').map(Number);
                const { payDays, isProrated, reason } = calculateProrata(emp, year, month);
                const ratio = payDays / 30;

                const base = Math.round(baseFull * ratio);
                const pos = Math.round(posFull * ratio);
                const fuel = Math.round(fuelFull * ratio);
                const hourlyRate = (baseFull + posFull) / 240;

                const perf = Number(data.performanceBonus) || 0;
                const fest = Number(data.festivalBonus) || 0;
                const birth = Number(data.birthdayBonus) || 0;
                const otherP = Number(data.otherPlus) || 0;

                // å‹åŸºæ³•æ‰£æ¬¾è¨ˆç®—
                const halfPayHours = (Number(data.sickLeaveHours) || 0) + (Number(data.menstrualLeaveHours) || 0);
                const sickDeduct = Math.round(hourlyRate * halfPayHours * 0.5);

                const noPayHours = (Number(data.personalLeaveHours) || 0) + (Number(data.familyCareLeaveHours) || 0);
                const personalDeduct = Math.round(hourlyRate * noPayHours);

                const otherD = Number(data.otherDeduct) || 0;

                const laborIns = Math.round(laborInsFull * ratio);
                const pensionCompany = Math.round((insuranceLevel * 0.06) * ratio);
                const pensionSelf = Math.round((insuranceLevel * (Number(data.pensionSelfRate) || 0) / 100) * ratio);

                let healthIns = healthInsFull;
                let healthInsFamily = Number(emp.healthInsFamily || 0); 

                const grossSalary = base + pos + fuel + perf + fest + birth + otherP;
                const salaryDeductions = sickDeduct + personalDeduct + otherD;
                const totalDeductionBlock = laborIns + healthIns + healthInsFamily + pensionSelf;
                const netSalary = grossSalary - salaryDeductions - totalDeductionBlock;

                return {
                    emp, month: currentMonth, base, pos, fuel, perf, fest, birth, otherP,
                    sickDeduct, personalDeduct, otherD, laborIns, healthIns, healthInsFamily, pensionSelf,
                    grossSalary, incomeTotal: grossSalary, deductLeftTotal: sickDeduct + personalDeduct + otherD,
                    deductRightTotal: totalDeductionBlock, netSalary, pensionCompany, data,
                    isProrated, payDays, reason, baseFull, useSnapshot
                };
            };

            const getSalarySlipHTML = (r) => `
                <div class="salary-slip" style="width: 210mm; min-height: 297mm; padding: 40px; background: white; color: black; font-family: Microsoft JhengHei, sans-serif; border: 2px solid black; position: relative;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">å…‰ç¥æœ‰é™å…¬å¸é™„è¨­èŠ±è“®ç¸£å…‰ç¥ç§ç«‹å±…å®¶å¼æœå‹™</h1>
                        <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 16px;">é¡é•·ç…§ç…§é¡§æœå‹™æ©Ÿæ§‹</h2>
                        <div style="font-size: 24px; font-weight: bold; border-bottom: 2px solid black; padding-bottom: 8px; margin-bottom: 16px;">${r.month} è–ªè³‡æ˜ç´° ${r.useSnapshot ? '<span style="font-size:12px; font-weight:normal; color:#666;">(å·²é–å®š)</span>' : ''}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 24px;">
                        <div style="font-size: 16px;">
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 8px;"><span style="color: #666;">å“¡å·¥å§“åï¼š</span><span style="font-weight: bold; font-size: 18px;">${r.emp.name}</span></div>
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 8px;"><span style="color: #666;">å“¡å·¥ç·¨è™Ÿï¼š</span><span style="font-family: monospace;">${r.emp.empNo}</span></div>
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 8px;"><span style="color: #666;">å‹ä¿ç´šè·ï¼š</span><span style="font-family: monospace;">${new Intl.NumberFormat('zh-TW').format(r.emp.insuranceLevel)}</span></div>
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 8px;"><span style="color: #666;">å‹é€€ææ’¥(6%)ï¼š</span><span style="font-family: monospace;">${new Intl.NumberFormat('zh-TW').format(r.pensionCompany)}</span></div>
                        </div>
                        <div style="text-align: right;">
                            <div style="margin-bottom: 16px;"><div style="color: #666; font-size: 14px;">æœ¬æœˆè–ªè³‡ (æ‡‰ç™¼)</div><div style="font-size: 24px; font-weight: bold;">${new Intl.NumberFormat('zh-TW', {style:'currency',currency:'TWD',minimumFractionDigits:0}).format(r.incomeTotal)}</div></div>
                            <div><div style="color: #666; font-size: 14px;">å¯¦é ˜è–ªè³‡ (å¯¦ç™¼)</div><div style="font-size: 32px; font-weight: bold; border-bottom: 4px double black; display: inline-block;">${new Intl.NumberFormat('zh-TW', {style:'currency',currency:'TWD',minimumFractionDigits:0}).format(r.netSalary)}</div></div>
                        </div>
                    </div>
                    ${r.isProrated ? `<div style="background: #fff7ed; color: #c2410c; padding: 8px; border: 1px dashed #f97316; margin-bottom: 16px; font-size: 14px; text-align: center;"><b>æ³¨æ„ï¼š</b>æ­¤ç‚ºæœªæ»¿æœˆè–ªè³‡ (${r.reason})ï¼Œä»¥ <b>${r.payDays}/30</b> å¤©è¨ˆç®—ã€‚</div>` : ''}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start;">
                        <div>
                            <div style="background: #f0f0f0; border-top: 1px solid black; border-bottom: 1px solid black; font-weight: bold; padding: 4px 8px; margin-bottom: 8px;">è–ªè³‡æ˜ç´° (åŠ é …/æ¸›é …)</div>
                            <table style="width: 100%; border-collapse: collapse;">
                                ${[
                                    ['æœ¬è–ª', r.base, r.isProrated ? `(åŸ:${r.baseFull})` : '', ''], 
                                    ['è·å‹™åŠ çµ¦', r.pos, '', ''], ['ç¸¾æ•ˆçé‡‘', r.perf, '', ''], ['ä¸‰ç¯€ç¦®é‡‘', r.fest, '', ''], ['ç”Ÿæ—¥ç¦®é‡‘', r.birth, '', ''], ['æ²¹è³‡è£œåŠ©', r.fuel, '', ''], ['å…¶ä»–(åŠ )', r.otherP, '', ''],
                                    ['åŠè–ªå‡æ‰£æ¬¾', r.sickDeduct ? -r.sickDeduct : 0, '(ç—…å‡/ç”Ÿç†å‡)', 'color:red;'], 
                                    ['å…¨è–ªå‡æ‰£æ¬¾', r.personalDeduct ? -r.personalDeduct : 0, '(äº‹å‡/å®¶åº­ç…§é¡§)', 'color:red;'], 
                                    ['å…¶ä»–(æ‰£)', r.otherD ? -r.otherD : 0, '', 'color:red;']
                                ].map(i => `<tr style="border-bottom: 1px dotted #ccc;"><td style="padding: 4px 0;">${i[0]} <span style="font-size:10px;color:#888">${i[2]||''}</span></td><td style="text-align: right; font-family: monospace; ${i[3]||''}">${i[1]!==0?new Intl.NumberFormat('zh-TW').format(i[1]):'-'}</td></tr>`).join('')}
                                <tr style="font-weight: bold; border-top: 2px solid black;"><td style="padding: 8px 0;">è–ªè³‡å°è¨ˆ</td><td style="text-align: right;">${new Intl.NumberFormat('zh-TW', {style:'currency',currency:'TWD',minimumFractionDigits:0}).format(r.incomeTotal - r.deductLeftTotal)}</td></tr>
                            </table>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <div>
                                <div style="background: #f0f0f0; border-top: 1px solid black; border-bottom: 1px solid black; font-weight: bold; padding: 4px 8px; margin-bottom: 8px;">ä»£æ‰£æ˜ç´° (ä¿éšª)</div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    ${[['å‹ä¿è²»', r.laborIns], ['å¥ä¿è²»(æœ¬äºº)', r.healthIns], ['å¥ä¿è²»(çœ·å±¬)', r.healthInsFamily], ['å‹é€€è‡ªæ', r.pensionSelf]].map(i => `<tr style="border-bottom: 1px dotted #ccc;"><td style="padding: 4px 0;">${i[0]}</td><td style="text-align: right; font-family: monospace;">${i[1]!==0?new Intl.NumberFormat('zh-TW').format(i[1]):'-'}</td></tr>`).join('')}
                                    <tr style="font-weight: bold; border-top: 2px solid black; color: #b91c1c;"><td style="padding: 8px 0;">ä»£æ‰£å°è¨ˆ</td><td style="text-align: right;">-${new Intl.NumberFormat('zh-TW', {style:'currency',currency:'TWD',minimumFractionDigits:0}).format(r.deductRightTotal)}</td></tr>
                                </table>
                            </div>
                            <div>
                                <div style="background: #f0f0f0; border-top: 1px solid black; border-bottom: 1px solid black; font-weight: bold; padding: 4px 8px; margin-bottom: 8px;">å·¥æ™‚èˆ‡å‡åˆ¥ (å°æ™‚)</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                    ${r.data.specialLeaveHours ? `<div>ç‰¹ä¼‘: ${r.data.specialLeaveHours}</div>` : ''}
                                    ${r.data.compLeaveHours ? `<div>è£œä¼‘: ${r.data.compLeaveHours}</div>` : ''}
                                    ${r.data.sickLeaveHours ? `<div>ç—…å‡: ${r.data.sickLeaveHours}</div>` : ''}
                                    ${r.data.personalLeaveHours ? `<div>äº‹å‡: ${r.data.personalLeaveHours}</div>` : ''}
                                    ${r.data.menstrualLeaveHours ? `<div>ç”Ÿç†å‡: ${r.data.menstrualLeaveHours}</div>` : ''}
                                    ${r.data.familyCareLeaveHours ? `<div>å®¶åº­ç…§é¡§: ${r.data.familyCareLeaveHours}</div>` : ''}
                                    ${r.data.weddingLeaveHours ? `<div>å©šå‡: ${r.data.weddingLeaveHours}</div>` : ''}
                                    ${r.data.funeralLeaveHours ? `<div>å–ªå‡: ${r.data.funeralLeaveHours}</div>` : ''}
                                    ${r.data.prenatalLeaveHours ? `<div>ç”¢æª¢å‡: ${r.data.prenatalLeaveHours}</div>` : ''}
                                    ${r.data.paternityLeaveHours ? `<div>é™ªç”¢å‡: ${r.data.paternityLeaveHours}</div>` : ''}
                                    ${r.data.maternityLeaveHours ? `<div>ç”¢å‡: ${r.data.maternityLeaveHours}</div>` : ''}
                                    ${r.data.ritualLeaveHours ? `<div>æ­²æ™‚ç¥­å„€: ${r.data.ritualLeaveHours}</div>` : ''}
                                    ${r.data.officialLeaveHours ? `<div>å…¬å‡: ${r.data.officialLeaveHours}</div>` : ''}
                                </div>
                            </div>
                            <div style="border: 1px solid black; padding: 8px; margin-top: auto; min-height: 80px;">
                                <div style="font-weight: bold; font-size: 12px; border-bottom: 1px solid black; display: inline-block; margin-bottom: 4px;">å‚™è¨»èªªæ˜/å…¬å‘Šäº‹é …</div>
                                <div style="white-space: pre-wrap;">${r.data.note}</div>
                            </div>
                        </div>
                    </div>
                </div>`;

            const getFilteredEmployees = () => {
                return employees.filter(e => {
                    if (filterStatus === 'active') return !e.resignationDate;
                    if (filterStatus === 'resigned') return !!e.resignationDate;
                    return true;
                });
            };

            const filteredEmployees = getFilteredEmployees();
            const currentData = getCurrentData(selectedEmpId);
            const currentEmp = employees.find(e => e.id == selectedEmpId);
            const result = calculatePayroll(currentEmp, currentData);

            const handleDownloadJPG = async () => {
                if (!previewRef.current) return;
                try {
                    const canvas = await html2canvas(previewRef.current, { scale: 2, useCORS: true });
                    canvas.toBlob((blob) => {
                        saveAs(blob, `${currentEmp?.name}_${currentMonth}_è–ªè³‡å–®.jpg`);
                    });
                } catch (err) { alert("ä¸‹è¼‰å¤±æ•—"); }
            };

            const handleBatchDownload = async () => {
                const zip = new JSZip();
                const container = document.getElementById('batch-container');
                container.innerHTML = ''; 
                if (filteredEmployees.length === 0) { alert("ç„¡è³‡æ–™å¯åŒ¯å‡º"); return; }
                alert(`è™•ç†ä¸­...`);

                for (let emp of filteredEmployees) {
                    const empData = monthlyDataMap[emp.id] || DEFAULT_MONTHLY_DATA;
                    const res = calculatePayroll(emp, empData);
                    const div = document.createElement('div');
                    div.innerHTML = getSalarySlipHTML(res);
                    container.appendChild(div);
                    const el = div.querySelector('.salary-slip');
                    try {
                        const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff' });
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
                        zip.file(`${emp.name}_${currentMonth}.jpg`, blob);
                    } catch (e) { }
                }
                container.innerHTML = ''; 
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `å…‰ç¥è¡Œæ”¿è–ªè³‡å½™æ•´_${currentMonth}.zip`);
            };

            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2"><Calculator className="w-6 h-6"/> è¡Œæ”¿äººå“¡è–ªè³‡ç³»çµ± (ERPç‰ˆ)</h1>
                            <div className="flex items-center gap-4">
                                {loading && <span className="animate-pulse text-yellow-300">è³‡æ–™åŒæ­¥ä¸­...</span>}
                                <button onClick={handleSave} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold transition-colors">
                                    <SaveDisk className="w-4 h-4"/> å„²å­˜æœ¬æœˆè³‡æ–™
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-[1600px] mx-auto p-6">
                        <div className="grid lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
                            <div className="col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-y-auto custom-scrollbar flex flex-col">
                                <div className="p-3 border-b sticky top-0 bg-white z-10 space-y-2">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1 block">è¨ˆè–ªæœˆä»½</label>
                                        <input type="month" className="w-full p-2 border rounded bg-slate-50 font-bold" value={currentMonth} onChange={e=>setCurrentMonth(e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1 block">é¡¯ç¤ºç¯©é¸</label>
                                        <select className="w-full p-2 border rounded text-sm bg-white" value={filterStatus} onChange={e=>setFilterStatus(e.target.value)}>
                                            <option value="active">ğŸŸ¢ åœ¨è·äººå“¡</option>
                                            <option value="resigned">ğŸ”´ å·²é›¢è·</option>
                                            <option value="all">âšª é¡¯ç¤ºå…¨éƒ¨</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto">
                                    {filteredEmployees.length === 0 ? (
                                        <div className="p-4 text-center text-gray-400 text-sm">ç„¡ç¬¦åˆè³‡æ–™</div>
                                    ) : (
                                        filteredEmployees.map(e => (
                                            <div key={e.id} onClick={()=>setSelectedEmpId(e.id)} 
                                                className={`p-3 border-b cursor-pointer transition-colors hover:bg-blue-50 ${selectedEmpId===e.id?'bg-blue-100 border-l-4 border-l-blue-600':'border-l-4 border-l-transparent'}`}>
                                                <div className="font-bold text-slate-800 flex justify-between items-center">
                                                    {e.name}
                                                    {e.resignationDate && <span className="text-[10px] text-red-500 bg-red-100 px-1 rounded">(é›¢)</span>}
                                                </div>
                                                <div className="text-xs text-slate-500">{e.empNo}</div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <div className="p-3 border-t bg-slate-50">
                                    <button onClick={handleBatchDownload} className="w-full bg-slate-800 text-white py-2 rounded text-sm flex justify-center gap-2 hover:bg-black items-center">
                                        <Package className="w-4 h-4"/> åŒ¯å‡ºåˆ—è¡¨ (ZIP)
                                    </button>
                                </div>
                            </div>

                            <div className="col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 overflow-y-auto custom-scrollbar p-5">
                                {!selectedEmpId ? (
                                    <div className="h-full flex items-center justify-center text-slate-400">è«‹é¸æ“‡å“¡å·¥</div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between">
                                            <h3 className="font-bold text-lg text-slate-800">{currentEmp?.name} - è®Šå‹•è³‡æ–™</h3>
                                            <button onClick={handleAutoFill} className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold hover:bg-emerald-200 transition flex items-center gap-1">
                                                <Refresh className="w-3 h-3"/> è‡ªå‹•å¸¶å…¥è«‹å‡/æŠ˜ç¾
                                            </button>
                                        </div>
                                        
                                        {currentData.snapshot && (
                                            <div className="bg-orange-50 border border-orange-200 text-orange-800 text-xs p-2 rounded mb-2">
                                                ğŸ”’ æ­¤æœˆä»½å·²é–å®šè–ªè³‡çµæ§‹ (ä½¿ç”¨å¿«ç…§è³‡æ–™è¨ˆç®—)
                                            </div>
                                        )}

                                        <div className="space-y-3">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">é¡å¤–çé‡‘ / åŠ é …</div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="text-xs text-slate-500">ç¸¾æ•ˆçé‡‘</label><input type="number" className="w-full p-2 border rounded" value={currentData.performanceBonus} onChange={e=>updateCurrentData('performanceBonus',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                <div><label className="text-xs text-slate-500">ä¸‰ç¯€ç¦®é‡‘</label><input type="number" className="w-full p-2 border rounded" value={currentData.festivalBonus} onChange={e=>updateCurrentData('festivalBonus',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                <div><label className="text-xs text-slate-500">ç”Ÿæ—¥ç¦®é‡‘</label><input type="number" className="w-full p-2 border rounded" value={currentData.birthdayBonus} onChange={e=>updateCurrentData('birthdayBonus',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                <div><label className="text-xs text-slate-500">å…¶ä»–(åŠ )</label><input type="number" className="w-full p-2 border rounded" value={currentData.otherPlus} onChange={e=>updateCurrentData('otherPlus',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">æ‡‰æ‰£æ¬¾å‡åˆ¥ (ç³»çµ±è‡ªå‹•æ‰£è–ª)</div>
                                            <div className="bg-red-50 p-3 rounded-lg border border-red-100 space-y-3">
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-xs text-red-800 font-bold">ç—…å‡ (æ‰£åŠè–ª)</label><input type="number" className="w-full p-2 border border-red-200 rounded" value={currentData.sickLeaveHours} onChange={e=>updateCurrentData('sickLeaveHours',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                    <div><label className="text-xs text-red-800 font-bold">ç”Ÿç†å‡ (æ‰£åŠè–ª)</label><input type="number" className="w-full p-2 border border-red-200 rounded" value={currentData.menstrualLeaveHours} onChange={e=>updateCurrentData('menstrualLeaveHours',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-xs text-red-800 font-bold">äº‹å‡ (æ‰£å…¨è–ª)</label><input type="number" className="w-full p-2 border border-red-200 rounded" value={currentData.personalLeaveHours} onChange={e=>updateCurrentData('personalLeaveHours',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                    <div><label className="text-xs text-red-800 font-bold">å®¶åº­ç…§é¡§ (æ‰£å…¨è–ª)</label><input type="number" className="w-full p-2 border border-red-200 rounded" value={currentData.familyCareLeaveHours} onChange={e=>updateCurrentData('familyCareLeaveHours',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                                </div>
                                            </div>
                                            <div><label className="text-xs text-slate-500">å…¶ä»–æ‰£æ¬¾ (é‡‘é¡)</label><input type="number" className="w-full p-2 border rounded text-red-600 font-mono" value={currentData.otherDeduct} onChange={e=>updateCurrentData('otherDeduct',e.target.value)} onFocus={e=>e.target.select()} /></div>
                                        </div>

                                        <div className="space-y-3">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">ä¸æ‰£è–ªå‡åˆ¥ (ç´”ç´€éŒ„)</div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div><label className="text-xs text-slate-500">ç‰¹ä¼‘</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.specialLeaveHours} onChange={e=>updateCurrentData('specialLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">è£œä¼‘</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.compLeaveHours} onChange={e=>updateCurrentData('compLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">å…¬å‡</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.officialLeaveHours} onChange={e=>updateCurrentData('officialLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">å©šå‡</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.weddingLeaveHours} onChange={e=>updateCurrentData('weddingLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">å–ªå‡</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.funeralLeaveHours} onChange={e=>updateCurrentData('funeralLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">ç”¢æª¢</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.prenatalLeaveHours} onChange={e=>updateCurrentData('prenatalLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">é™ªç”¢</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.paternityLeaveHours} onChange={e=>updateCurrentData('paternityLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">ç”¢å‡</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.maternityLeaveHours} onChange={e=>updateCurrentData('maternityLeaveHours',e.target.value)} /></div>
                                                <div><label className="text-xs text-slate-500">ç¥­å„€</label><input type="number" className="w-full p-2 border rounded bg-slate-50" value={currentData.ritualLeaveHours} onChange={e=>updateCurrentData('ritualLeaveHours',e.target.value)} /></div>
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">å‹é€€è‡ªæ</div>
                                            <div><label className="text-xs text-slate-500">è‡ªææ¯”ä¾‹ (%)</label><input type="number" className="w-full p-2 border rounded" value={currentData.pensionSelfRate} onChange={e=>updateCurrentData('pensionSelfRate',e.target.value)} onFocus={e=>e.target.select()} placeholder="ä¾‹å¦‚: 6" /></div>
                                        </div>

                                        <div className="space-y-3">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">å‚™è¨»</div>
                                            <textarea className="w-full p-2 border rounded h-20 text-sm" value={currentData.note} onChange={e=>updateCurrentData('note',e.target.value)} placeholder="é¡¯ç¤ºæ–¼è–ªè³‡å–®åº•éƒ¨..."></textarea>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="col-span-7 bg-slate-500 rounded-xl shadow-inner p-8 overflow-auto flex justify-center relative">
                                {!selectedEmpId || !result ? (
                                    <div className="text-white opacity-50 self-center">è«‹é¸æ“‡è¡Œæ”¿äººå“¡ä»¥é è¦½è–ªè³‡å–®</div>
                                ) : (
                                    <div className="relative">
                                        <div className="absolute -top-12 right-0 flex gap-2">
                                            <button onClick={handleDownloadJPG} className="bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 flex items-center gap-2 text-sm font-bold">
                                                <ImageDown className="w-4 h-4"/> ä¸‹è¼‰æœ¬é  JPG
                                            </button>
                                        </div>
                                        <div ref={previewRef} className="salary-slip shadow-2xl scale-[0.85] origin-top">
                                            <div dangerouslySetInnerHTML={{__html: getSalarySlipHTML(result).replace(/<div class="salary-slip"[^>]*>|<\/div>$/g, '')}} />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PayrollSystem />);
    </script>
</body>
</html>