<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤èˆ‡å¯©æ ¸ç®¡ç†å¾Œå° (ERPæ ¸å¿ƒ-å®‰å…¨ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; } 
        .nav-item { cursor: pointer; transition: all 0.2s; border-radius: 8px; margin-bottom: 4px; padding: 12px 16px; color: #64748b; font-weight: 600; display: flex; align-items: center; gap: 12px; }
        .nav-item:hover { background-color: #f1f5f9; color: #334155; }
        .nav-item.active { background-color: #e0f2fe; color: #0284c7; border-left: 4px solid #0284c7; }
        #iframe-container { width: 100%; height: calc(100vh - 64px); background: #fff; position: relative; }
        #app-frame { width: 100%; height: 100%; border: none; display: block; }
        .view-section { height: calc(100vh - 64px); overflow-y: auto; }
        #sidebar { transition: transform 0.3s ease; }
        .sidebar-hidden { transform: translateX(-100%); }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc, query, where, orderBy, updateDoc, addDoc, deleteDoc, writeBatch, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 

        // ç¶å®šå…¨åŸŸ
        window.db = db; window.collection = collection; window.getDoc = getDoc; window.doc = doc; window.updateDoc = updateDoc; window.addDoc = addDoc; window.deleteDoc = deleteDoc; window.writeBatch = writeBatch; window.setDoc = setDoc;

        let currentUser = null; 
        let systemSettings = { allowedProxies: [], allowedEmployee: [], allowedLeave: [], allowedSalary: [], allowedAssessment: [], workStartTime: "08:30", workEndTime: "17:30", clockBuffer: 5 }; 
        let allAdmins = []; let adminIds = new Set(); let allCaregivers = [];
        let currentEditAttendanceId = null; let currentAttendanceData = [];

        window.loginAs = loginAs;
        window.toggleSidebar = toggleSidebar;
        window.switchTab = switchTab;
        window.openExternalSystem = openExternalSystem;
        window.processRequest = processRequest;
        window.logout = logout;
        window.navigate = navigate;
        
        window.saveSettings = saveSettings;
        window.submitProxyRequest = submitProxyRequest;
        window.changeAttendanceFilter = changeAttendanceFilter;
        window.exportAttendance = exportAttendance;
        window.openEditAttendance = openEditAttendance;
        window.closeEditModal = closeEditModal;
        window.submitEditAttendance = submitEditAttendance;
        window.deleteAttendance = deleteAttendance;
        window.openManualEntry = openManualEntry;
        window.closeManualEntry = closeManualEntry;
        window.submitManualEntry = submitManualEntry;
        window.approveCorrection = approveCorrection;

        // â˜… æ ¸å¿ƒä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ UID ç›´è®€æ¨¡å¼
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // ç›´æ¥ç”¨ Auth UID è®€å– Firestore è³‡æ–™ï¼Œä¸å†å€åˆ† admin å­—ä¸²
                    const userDocRef = doc(db, "employees", user.uid);
                    const userSnap = await getDoc(userDocRef);

                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        
                        // æ¬Šé™æª¢æŸ¥ï¼šå¿…é ˆæ˜¯ admin (åŒ…å«ä¸€èˆ¬è¡Œæ”¿èˆ‡è¶…ç´šç®¡ç†å“¡)
                        if (userData.role === 'admin' || userData.role === 'super_admin') {
                            // ç‚ºäº†ç›¸å®¹èˆŠè³‡æ–™ï¼Œè‹¥ role æ˜¯ admin ä½† code æ˜¯ adminï¼Œè¦–ç‚ºè¶…ç´šç®¡ç†å“¡
                            if (userData.code === 'admin') userData.role = 'super_admin'; 
                            
                            performLoginSuccess({ id: user.uid, ...userData });
                        } else {
                            alert("â›” æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å“¡");
                            await signOut(auth);
                        }
                    } else {
                        // æœ‰ Auth ä½†ç„¡è³‡æ–™åº«ç´€éŒ„
                        alert("âŒ å¸³è™Ÿè³‡æ–™ç•°å¸¸ (No Profile)");
                        await signOut(auth);
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤");
                    await signOut(auth);
                }
            } else {
                // æœªç™»å…¥
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-screen').classList.add('hidden');
                sessionStorage.removeItem('kuangyou_user');
            }
        });

        // ç™»å…¥æˆåŠŸå¾Œçš„è™•ç†
        function performLoginSuccess(user) {
            currentUser = user;
            sessionStorage.setItem('kuangyou_user', JSON.stringify(user));
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            document.getElementById('current-user').innerText = user.name || user.code;
            
            startSettingsListener();
            loadEmployeeData().then(() => {
                renderSidebar();
                handleLoginRedirect(user);
            });
        }

        function handleLoginRedirect(user) {
            // é è¨­è·³è½‰é‚è¼¯
            if (user.role === 'super_admin') { switchTab('dashboard'); } 
            else {
                if (systemSettings.allowedProxies?.includes(user.id)) { switchTab('proxy'); } 
                else { switchTab('dashboard'); }
            }
        }

        function startSettingsListener() {
            onSnapshot(doc(db, "system_settings", "config"), (docSnap) => {
                if (docSnap.exists()) {
                    systemSettings = { ...systemSettings, ...docSnap.data() };
                    if(document.getElementById('work-start')) {
                        document.getElementById('work-start').value = systemSettings.workStartTime || "08:30";
                        document.getElementById('work-end').value = systemSettings.workEndTime || "17:30";
                        document.getElementById('clock-buffer').value = systemSettings.clockBuffer || 5;
                    }
                    if(allAdmins.length > 0) renderPermissionTable();
                }
            });
        }

        async function loadEmployeeData() {
            try {
                const q = query(collection(db, "employees"));
                const snapshot = await getDocs(q);
                allAdmins = []; allCaregivers = []; adminIds.clear();
                snapshot.forEach(doc => {
                    const e = { id: doc.id, ...doc.data() };
                    if (!e.resignDate) {
                        // çµ±ä¸€ç®¡ç†å“¡èˆ‡è¶…ç´šç®¡ç†å“¡éƒ½è¦–ç‚º Admin ç¾¤çµ„
                        if (e.role === 'admin' || e.role === 'super_admin') { 
                            allAdmins.push(e); adminIds.add(e.id); 
                        } 
                        else if (e.role === 'caregiver') { allCaregivers.push(e); }
                    }
                });
                allAdmins.sort((a, b) => (a.code || "").localeCompare(b.code || ""));
                allCaregivers.sort((a, b) => (a.code || "").localeCompare(b.code || ""));

                const attFilter = document.getElementById('attendance-employee-filter');
                if(attFilter) {
                    attFilter.innerHTML = '<option value="all">å…¨é«”è¡Œæ”¿äººå“¡</option>';
                    allAdmins.forEach(e => attFilter.innerHTML += `<option value="${e.id}">${e.name}</option>`);
                }
                renderCaregiverSelect(); renderPermissionTable(); updateDashboardStats();
            } catch (e) { console.error("Load Data Error:", e); }
        }

        function updateDashboardStats() {
            const totalEmployees = allAdmins.length + allCaregivers.length;
            document.getElementById('stat-employees').innerText = totalEmployees;
            // åªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥çœ‹åˆ°å¾…ç°½æ ¸æç¤º (æˆ–æ˜¯æœ‰æ¬Šé™çš„äºº)
            if (currentUser && currentUser.role === 'super_admin') {
                document.getElementById('card-pending').classList.remove('hidden');
            } else {
                document.getElementById('card-pending').classList.add('hidden');
            }
        }

        async function loginAs() {
            const codeInput = document.getElementById('login-code').value.trim();
            const pwdInput = document.getElementById('login-password').value.trim();
            if(!codeInput || !pwdInput) return alert("è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿèˆ‡å¯†ç¢¼");

            const email = `${codeInput}@kuangyou.internal`;

            try {
                const btn = document.querySelector('#login-screen button');
                const oldText = btn.innerText;
                btn.innerText = "é©—è­‰ä¸­...";
                btn.disabled = true;

                await signInWithEmailAndPassword(auth, email, pwdInput);
                // æˆåŠŸå¾Œäº¤ç”± onAuthStateChanged è™•ç†
                
            } catch (e) { 
                console.error(e); 
                if(e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    alert("âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
                } else {
                    alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
                }
                const btn = document.querySelector('#login-screen button');
                btn.innerText = "é€²å…¥ç³»çµ± â”";
                btn.disabled = false;
            }
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                signOut(auth).then(() => {
                    sessionStorage.removeItem('kuangyou_user');
                    window.location.reload();
                });
            }
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar').classList.toggle('w-0'); document.getElementById('sidebar').classList.toggle('w-64'); }

        function renderSidebar() {
            const nav = document.getElementById('nav-menu');
            nav.innerHTML = '';
            nav.innerHTML += `<div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item"><span>ğŸ </span> é¦–é å„€è¡¨æ¿</div>`;
            nav.innerHTML += `<div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-2">ç°½æ ¸èˆ‡ç›£æ§</div>`;
            
            // æ¬Šé™åˆ¤æ–·ï¼šè¶…ç´šç®¡ç†å“¡æ“æœ‰æ‰€æœ‰æ¬Šé™
            const isSuper = currentUser.role === 'super_admin';

            if (isSuper) {
                nav.innerHTML += `<div onclick="switchTab('approval')" id="nav-approval" class="nav-item"><span>âœ…</span> å¾…ç°½æ ¸æ¸…å–® <span id="badge-count" class="bg-red-500 text-white text-[10px] px-2 rounded-full hidden">0</span></div>`;
                nav.innerHTML += `<div onclick="switchTab('attendance')" id="nav-attendance" class="nav-item"><span>ğŸ“Š</span> è¡Œæ”¿å‡ºå‹¤ç›£æ§</div>`;
            }
            if (isSuper || hasPermission('allowedProxies')) { nav.innerHTML += `<div onclick="switchTab('proxy')" id="nav-proxy" class="nav-item"><span>ğŸ“</span> å±…æœå“¡ä»£ç”³è«‹</div>`; }
            
            nav.innerHTML += `<div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-4">ERP æ ¸å¿ƒç³»çµ±</div>`;
            
            if (isSuper || hasPermission('allowedEmployee')) { nav.innerHTML += `<div id="nav-emp" onclick="openExternalSystem('employee.html', this)" class="nav-item"><span>ğŸ‘¥</span> å“¡å·¥è³‡æ–™åº«</div>`; }
            if (isSuper || hasPermission('allowedLeave')) { nav.innerHTML += `<div onclick="openExternalSystem('leave.html', this)" class="nav-item"><span>ğŸ“š</span> ç‰¹ä¼‘å­˜æ‘ºç®¡ç†</div>`; }
            if (isSuper || hasPermission('allowedSalary')) {
                nav.innerHTML += `<div onclick="openExternalSystem('salary.html', this)" class="nav-item"><span>ğŸ’°</span> è¡Œæ”¿äººå“¡è–ªè³‡</div>`;
                nav.innerHTML += `<div onclick="openExternalSystem('salary_caregiver.html', this)" class="nav-item"><span>ğŸ¥</span> å±…æœå“¡è–ªè³‡</div>`;
            }
            if (isSuper || hasPermission('allowedAssessment')) { nav.innerHTML += `<div onclick="openExternalSystem('assessment.html', this)" class="nav-item"><span>ğŸ“‹</span> è€ƒæ ¸è©•é‘‘ç³»çµ±</div>`; }
            
            if (isSuper) { nav.innerHTML += `<div class="mt-auto border-t pt-2"><div onclick="switchTab('settings')" id="nav-settings" class="nav-item"><span>âš™ï¸</span> ç³»çµ±æ¬Šé™è¨­å®š</div></div>`; }
        }

        function hasPermission(permKey) { 
            if(!currentUser) return false; 
            // Super Admin æ°¸é å›å‚³ true
            if(currentUser.role === 'super_admin') return true; 
            return systemSettings[permKey]?.includes(currentUser.id); 
        }

        function switchTab(tabId) {
            document.getElementById('iframe-container').classList.add('hidden');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-placeholder').classList.add('hidden');
            const target = document.getElementById(`view-${tabId}`);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${tabId}`);
            if(activeNav) activeNav.classList.add('active');
            if(tabId === 'approval') loadPendingRequests();
            if(tabId === 'dashboard') updateDashboardStats();
            if(tabId === 'attendance') { 
                const currentMonth = dayjs().format('YYYY-MM'); 
                document.getElementById('attendance-month').value = currentMonth; 
                if(allAdmins.length === 0) loadEmployeeData().then(() => loadAttendanceStats());
                else loadAttendanceStats();
            }
        }

        function openExternalSystem(url, element) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-placeholder').classList.add('hidden');
            const container = document.getElementById('iframe-container');
            const frame = document.getElementById('app-frame');
            container.classList.remove('hidden');
            // é˜²æ­¢é‡è¤‡è¼‰å…¥
            if(!frame.getAttribute('src') || frame.getAttribute('src') !== url) {
                frame.src = url;
            }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
        }

        function navigate(url, el) { openExternalSystem(url, el); }

        // --- æ¥­å‹™é‚è¼¯ (ç¶­æŒä¸è®Š) ---
        function loadPendingRequests(){
            const q = query(collection(db, "requests"), where("status", "==", "pending"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('approval-list'); list.innerHTML = "";
                const badge = document.getElementById('badge-count');
                const statPending = document.getElementById('stat-pending'); 
                const count = snap.size;
                if(badge) { badge.innerText = count; badge.classList.toggle('hidden', count===0); }
                if(statPending) { statPending.innerText = count; } 
                if(snap.empty) { list.innerHTML = `<div class="text-center text-slate-400 py-10">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å–®æ“š</div>`; return; }

                snap.forEach(d => {
                    const r = {id: d.id, ...d.data()};
                    let typeBadge = "", actionBtn = "";
                    if (r.category === 'correction') {
                        typeBadge = `<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">â° è£œç™» (${r.type})</span>`;
                        actionBtn = `<button onclick="approveCorrection('${r.id}', '${r.empId}', '${r.name}', '${r.date}', '${r.type}')" class="px-3 py-1 bg-purple-600 text-white rounded-lg text-sm font-bold shadow hover:bg-purple-700">å‰å¾€è£œç™»</button>`;
                    } else {
                        typeBadge = r.category === 'leave' ? `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">è«‹å‡</span>` : `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">åŠ ç­</span>`;
                        actionBtn = `<button onclick="processRequest('${r.id}','approved')" class="px-4 py-1 bg-green-600 text-white rounded-lg text-sm font-bold shadow transition">æ ¸å‡†</button>`;
                    }
                    list.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-3 flex justify-between items-center"><div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-lg text-slate-800">${r.name}</span>${typeBadge}</div><div class="text-sm text-slate-500">æ—¥æœŸï¼š${r.date} | ${r.hours||0} H</div><div class="text-xs text-slate-400 mt-1">${r.note||'ç„¡'}</div></div><div class="flex gap-2"><button onclick="processRequest('${r.id}','rejected')" class="px-4 py-1 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-bold transition">é§å›</button>${actionBtn}</div></div>`;
                });
            });
        }

        function approveCorrection(reqId, empId, empName, date, type) {
            openManualEntry();
            setTimeout(() => {
                const sel = document.getElementById('manual-emp'); sel.value = empId;
                document.getElementById('manual-date').value = date;
                if(type === 'ä¸Šç­') document.getElementById('manual-in').focus(); else document.getElementById('manual-out').focus();
                window.processingReqId = reqId;
            }, 100);
        }

        async function processRequest(reqId, action) {
            if (action === 'rejected') {
                const reason = prompt("è«‹è¼¸å…¥é§å›åŸå› ï¼š", "è³‡æ–™ä¸å…¨");
                if (reason === null) return;
                const batch = writeBatch(db);
                batch.update(doc(db, "requests", reqId), { status: 'rejected', rejectReason: reason || "æœªå¡«å¯«", reviewedAt: new Date().toISOString() });
                await batch.commit();
                return;
            }

            if (!confirm(`ç¢ºå®šè¦æ ¸å‡†æ­¤ç”³è«‹å—ï¼Ÿ`)) return;

            const reqRef = doc(db, "requests", reqId);
            const reqSnap = await getDoc(reqRef);
            const reqData = reqSnap.data();
            const batch = writeBatch(db);

            batch.update(reqRef, { status: 'approved', reviewedAt: new Date().toISOString() });

            if (reqData.category === 'overtime') {
                const ledgerRef = doc(collection(db, "leave_ledger"));
                batch.set(ledgerRef, {
                    empId: reqData.empId,
                    sourceType: `åŠ ç­è£œä¼‘ (${reqData.date})`,
                    originalHours: reqData.hours,
                    remaining: reqData.hours,
                    validFrom: reqData.date,
                    expiryDate: dayjs(reqData.date).add(1, 'year').format('YYYY-MM-DD'),
                    createdAt: new Date().toISOString()
                });
            } 
            else if (reqData.category === 'leave') {
                let deductionLog = [];
                let isPaidLeave = (reqData.type === 'ç‰¹ä¼‘' || reqData.type === 'è£œä¼‘');

                if (isPaidLeave) {
                    const qLedger = query(collection(db, "leave_ledger"), where("empId", "==", reqData.empId));
                    const ledgerSnap = await getDocs(qLedger);
                    let ledgers = [];
                    ledgerSnap.forEach(d => ledgers.push({ id: d.id, ...d.data() }));

                    ledgers = ledgers.filter(l => l.remaining > 0 && dayjs(l.expiryDate).isAfter(dayjs()))
                                     .sort((a, b) => dayjs(a.expiryDate).unix() - dayjs(b.expiryDate).unix());

                    const totalBalance = ledgers.reduce((sum, l) => sum + l.remaining, 0);
                    if (totalBalance < reqData.hours) {
                        return alert(`âŒ æ ¸å‡†å¤±æ•—ï¼šé¤˜é¡ä¸è¶³ï¼\n\nå¯ç”¨é¤˜é¡ï¼š${totalBalance} H\nç”³è«‹æ™‚æ•¸ï¼š${reqData.hours} H`);
                    }

                    let hoursToDeduct = reqData.hours;
                    for (let l of ledgers) {
                        if (hoursToDeduct <= 0) break;
                        const deduct = Math.min(l.remaining, hoursToDeduct);
                        const ledgerRef = doc(db, "leave_ledger", l.id);
                        batch.update(ledgerRef, { remaining: l.remaining - deduct });
                        deductionLog.push({ ledgerId: l.id, source: l.sourceType, amount: deduct });
                        hoursToDeduct -= deduct;
                    }
                }

                const recordRef = doc(collection(db, "leave_records"));
                batch.set(recordRef, {
                    empId: reqData.empId,
                    date: reqData.date,
                    type: reqData.type,
                    hours: reqData.hours,
                    note: reqData.note || "ç·šä¸Šç”³è«‹æ ¸å‡†",
                    deductionLog: deductionLog, 
                    createdAt: new Date().toISOString()
                });
            }

            try {
                await batch.commit();
                alert("âœ… æ ¸å‡†æˆåŠŸï¼");
            } catch (e) {
                console.error(e);
                alert("æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        }
        
        function changeAttendanceFilter(){loadAttendanceStats()}
        function loadAttendanceStats(){
            const monthStr = document.getElementById('attendance-month').value;
            const targetEmpId = document.getElementById('attendance-employee-filter').value;
            if(!monthStr) return;
            const startStr = monthStr + "-01";
            const endStr = dayjs(monthStr).endOf('month').format('YYYY-MM-DD');
            const q = query(collection(db, "attendance"), where("date", ">=", startStr), where("date", "<=", endStr));
            
            onSnapshot(q, (snap) => {
                const list = document.getElementById('attendance-list'); list.innerHTML = "";
                currentAttendanceData = [];
                snap.forEach(doc => {
                    const r = {id: doc.id, ...doc.data()};
                    if (targetEmpId === 'all' || r.empId === targetEmpId) currentAttendanceData.push(r);
                });
                currentAttendanceData.sort((a,b) => a.date.localeCompare(b.date));
                if(currentAttendanceData.length === 0) { list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400">å°šç„¡ç´€éŒ„</td></tr>`; return; }
                
                currentAttendanceData.forEach(r => {
                    const isLate = r.inTime > "08:35";
                    const status = isLate ? `<span class="text-red-500 font-bold">é²åˆ°</span>` : `<span class="text-green-600 font-bold">æ­£å¸¸</span>`;
                    const locIn = r.location || '-';
                    const locOut = r.locationOut || '-';
                    const styleIn = locIn.includes('å…¬å¸') ? 'text-blue-500 bg-blue-50' : 'text-purple-600 bg-purple-50';
                    const styleOut = locOut.includes('å…¬å¸') ? 'text-blue-500 bg-blue-50' : 'text-purple-600 bg-purple-50';

                    list.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-3"><div class="font-bold text-slate-700">${r.date}</div><div class="text-xs text-slate-400">${r.name}</div></td><td class="p-3 text-center font-mono text-lg font-bold">${r.inTime||'-'}<div class="text-[10px] ${styleIn} px-1 rounded inline-block ml-1">${locIn}</div></td><td class="p-3 text-center font-mono text-lg font-bold">${r.outTime||'-'}<div class="text-[10px] ${styleOut} px-1 rounded inline-block ml-1">${locOut}</div></td><td class="p-3 text-center">${status}</td><td class="p-3 text-center"><button onclick="openEditAttendance('${r.id}','${r.inTime||''}','${r.outTime||''}')" class="text-xs bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 px-2 py-1 rounded transition mr-1">âœï¸</button><button onclick="deleteAttendance('${r.id}')" class="text-xs bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-600 px-2 py-1 rounded transition">ğŸ—‘ï¸</button></td></tr>`;
                });
            });
        }

        function openManualEntry() { document.getElementById('manual-entry-modal').classList.remove('hidden'); }
        function closeManualEntry() { document.getElementById('manual-entry-modal').classList.add('hidden'); window.processingReqId = null; }
        
        async function submitManualEntry() { 
            const empSel = document.getElementById('manual-emp'); const empId = empSel.value; const empName = empSel.options[empSel.selectedIndex]?.text; const date = document.getElementById('manual-date').value; const inTime = document.getElementById('manual-in').value; const outTime = document.getElementById('manual-out').value; 
            if(!empId || !date) return alert("è«‹é¸æ“‡äººå“¡èˆ‡æ—¥æœŸ"); 
            try { 
                await addDoc(collection(db, "attendance"), { empId, name: empName, date, inTime: inTime || null, outTime: outTime || null, location: 'ğŸ¢ å…¬å¸ (è£œç™»)', isManual: true, lastEditedBy: currentUser.name, timestamp: new Date().toISOString() }); 
                if(window.processingReqId) { await updateDoc(doc(db, "requests", window.processingReqId), { status: 'approved', reviewedAt: new Date().toISOString() }); window.processingReqId = null; }
                alert("è£œç™»å®Œæˆï¼"); closeManualEntry(); if(!document.getElementById('view-attendance').classList.contains('hidden')) loadAttendanceStats();
            } catch(e) { console.error(e); alert("è£œç™»å¤±æ•—"); } 
        }

        function renderPermissionTable() { const tbody = document.getElementById('permission-table-body'); if(!tbody) return; tbody.innerHTML = ""; allAdmins.forEach(admin => { const pProxy = systemSettings.allowedProxies?.includes(admin.id) ? 'checked' : ''; const pEmp = systemSettings.allowedEmployee?.includes(admin.id) ? 'checked' : ''; const pLeave = systemSettings.allowedLeave?.includes(admin.id) ? 'checked' : ''; const pSalary = systemSettings.allowedSalary?.includes(admin.id) ? 'checked' : ''; const pAssess = systemSettings.allowedAssessment?.includes(admin.id) ? 'checked' : ''; tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold text-slate-700">${admin.name}</td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedProxies" value="${admin.id}" ${pProxy}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedEmployee" value="${admin.id}" ${pEmp}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedLeave" value="${admin.id}" ${pLeave}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedSalary" value="${admin.id}" ${pSalary}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedAssessment" value="${admin.id}" ${pAssess}></td></tr>`; }); }
        function renderCaregiverSelect() { const sel = document.getElementById('proxy-caregiver'); if(!sel) return; sel.innerHTML = '<option value="">è«‹é¸æ“‡å±…æœå“¡</option>'; allCaregivers.forEach(c => { sel.innerHTML += `<option value="${c.id}" data-name="${c.name}">${c.name} (${c.code})</option>`; }); }
        async function saveSettings() { const newPermissions = { allowedProxies: [], allowedEmployee: [], allowedLeave: [], allowedSalary: [], allowedAssessment: [] }; document.querySelectorAll('.perm-chk:checked').forEach(chk => { const type = chk.dataset.type; const uid = chk.value; if(newPermissions[type]) newPermissions[type].push(uid); }); const workStart = document.getElementById('work-start').value; const workEnd = document.getElementById('work-end').value; const clockBuffer = Number(document.getElementById('clock-buffer').value); try { await setDoc(doc(db, "system_settings", "config"), { ...newPermissions, workStartTime: workStart, workEndTime: workEnd, clockBuffer: clockBuffer, updatedAt: new Date().toISOString() }, { merge: true }); alert("è¨­å®šå·²å„²å­˜ï¼"); } catch(e) { console.error(e); alert("å„²å­˜å¤±æ•—"); } }
        async function submitProxyRequest(){const sel=document.getElementById('proxy-caregiver');const empId=sel.value;const empName=sel.options[sel.selectedIndex]?.dataset.name;const date=document.getElementById('proxy-date').value;const type=document.getElementById('proxy-type').value;const hours=document.getElementById('proxy-hours').value;if(!empId||!date||!hours)return alert("è«‹å¡«å¯«å®Œæ•´");await addDoc(collection(db,"requests"),{empId,name:empName,category:"leave",type,date,hours:Number(hours),createdBy:currentUser.id,note:`ç”± ${currentUser.name} ä»£ç”³è«‹`,status:"pending",createdAt:new Date().toISOString()});alert("ä»£ç”³è«‹å·²é€å‡ºï¼");document.getElementById('proxy-hours').value=""}
        function openEditAttendance(id,i,o){currentEditAttendanceId=id;document.getElementById('edit-modal').classList.remove('hidden');document.getElementById('edit-in').value=i;document.getElementById('edit-out').value=o}
        function closeEditModal(){document.getElementById('edit-modal').classList.add('hidden')}
        async function submitEditAttendance(){if(!currentEditAttendanceId)return;await updateDoc(doc(db,"attendance",currentEditAttendanceId),{inTime:document.getElementById('edit-in').value||null,outTime:document.getElementById('edit-out').value||null,lastEditedBy:currentUser.name,lastEditedAt:new Date().toISOString()});closeEditModal()}
        async function deleteAttendance(id){if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ"))await deleteDoc(doc(db,"attendance",id))}
        function exportAttendance(){if(currentAttendanceData.length===0)return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");let csvContent="\uFEFFæ—¥æœŸ,å§“å,ç°½åˆ°æ™‚é–“,ç°½é€€æ™‚é–“,ç‹€æ…‹\n";currentAttendanceData.forEach(r=>{const status=(r.inTime>"08:35")?"é²åˆ°":"æ­£å¸¸";csvContent+=`${r.date},${r.name},${r.inTime||''},${r.outTime||''},${status}\n`});const url=URL.createObjectURL(new Blob([csvContent],{type:"text/csv;charset=utf-8;"}));const link=document.createElement("a");link.href=url;link.download=`è€ƒå‹¤ç´€éŒ„_${dayjs().format('YYYYMMDD')}.csv`;link.click()}
    </script>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div id="login-screen" class="fixed inset-0 bg-slate-800 z-50 flex flex-col items-center justify-center text-white">
        <div class="bg-white text-slate-800 p-8 rounded-2xl shadow-2xl w-96 text-center animate-fade-in-up">
            <div class="text-4xl mb-4">ğŸ¥</div>
            <h1 class="text-2xl font-black mb-2">å…‰ç¥é•·ç…§ ERP</h1>
            <p class="text-slate-400 text-sm mb-6">ç®¡ç†å¾Œå°ç™»å…¥</p>
            <div class="text-left mb-4 space-y-3">
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">å“¡å·¥ç·¨è™Ÿ</label>
                    <input type="text" id="login-code" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-lg outline-none focus:border-blue-500 bg-slate-50 mt-1" placeholder="è«‹è¼¸å…¥ç·¨è™Ÿ">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">ç™»å…¥å¯†ç¢¼</label>
                    <input type="password" id="login-password" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-lg outline-none focus:border-blue-500 bg-slate-50 mt-1" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
            </div>
            <button onclick="loginAs()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:scale-[1.02]">é€²å…¥ç³»çµ± â”</button>
            <div class="mt-6"><a href="index.html" class="text-xs text-slate-400 hover:text-blue-500 underline">â† è¿”å›å…¥å£å¤§å»³</a></div>
        </div>
    </div>

    <div id="main-screen" class="hidden flex h-screen w-screen">
        <div id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">K</div>
                <div><h2 class="font-black text-slate-800 tracking-tight">å…‰ç¥ç®¡ç†ä¸­å¿ƒ</h2><div class="text-xs text-slate-400">ERP System</div></div>
            </div>
            <div id="nav-menu" class="flex-1 overflow-y-auto p-4 space-y-1"></div>
            <div class="p-4 border-t border-slate-100 bg-slate-50">
                <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-white font-bold">U</div><div class="text-sm font-bold text-slate-700" id="current-user">User</div></div>
                <button onclick="logout()" class="w-full py-2 bg-white border border-slate-300 rounded text-xs font-bold text-slate-500 hover:bg-slate-100 transition">ç™»å‡º</button>
            </div>
        </div>

        <div class="flex-1 flex flex-col min-w-0 bg-slate-100">
            <div class="bg-white h-16 border-b flex items-center px-4 justify-between shadow-sm z-10">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
                <div class="text-xs text-slate-400 font-mono">KY-ERP v1.0.0 Stable</div>
            </div>
            
            <div id="iframe-container" class="w-full h-full hidden"><iframe id="app-frame" src=""></iframe></div>
            
            <div id="view-placeholder" class="view-section h-full flex flex-col items-center justify-center hidden"><div class="text-6xl mb-4">ğŸ”’</div><div class="text-slate-400 font-bold">è«‹é¸æ“‡åŠŸèƒ½</div></div>
            
            <div id="view-dashboard" class="view-section h-full flex flex-col p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">é¦–é å„€è¡¨æ¿</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-blue-100 rounded-xl text-blue-600 text-2xl">ğŸ‘¥</div>
                            <div>
                                <div class="text-sm text-slate-400 font-bold">ç›®å‰åœ¨è·äººæ•¸</div>
                                <div class="text-3xl font-black text-slate-800" id="stat-employees">0</div>
                            </div>
                        </div>
                    </div>
                    <div id="card-pending" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hidden">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-red-100 rounded-xl text-red-600 text-2xl">âš¡</div>
                            <div>
                                <div class="text-sm text-slate-400 font-bold">å°šæœªç°½æ ¸è³‡æ–™</div>
                                <div class="text-3xl font-black text-slate-800" id="stat-pending">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-approval" class="view-section h-full flex flex-col p-8 hidden"><h2 class="text-2xl font-bold text-slate-800 mb-6">å¾…ç°½æ ¸æ¸…å–®</h2><div id="approval-list" class="flex-1 overflow-y-auto pr-2 pb-20"></div></div>
            <div id="view-attendance" class="view-section h-full flex flex-col p-8 hidden">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <div class="flex items-center gap-2"><h2 class="text-2xl font-bold text-slate-800 mr-2">è¡Œæ”¿å‡ºå‹¤ç›£æ§</h2><input type="month" id="attendance-month" class="border rounded-lg p-2 text-sm font-bold text-slate-600 bg-white shadow-sm" onchange="changeAttendanceFilter()"><select id="attendance-employee-filter" class="border rounded-lg p-2 text-sm font-bold text-slate-600 bg-white shadow-sm max-w-xs" onchange="changeAttendanceFilter()"></select></div>
                    <div class="flex gap-2"><button onclick="openManualEntry()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2"><span>â•</span> è£œç™»</button><button onclick="exportAttendance()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2"><span>ğŸ–¨ï¸</span> åŒ¯å‡ºå ±è¡¨</button></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 overflow-y-auto"><table class="w-full text-left relative"><thead class="bg-slate-100 text-slate-500 font-bold text-sm sticky top-0 z-10 shadow-sm"><tr><th class="p-4">æ—¥æœŸ / å§“å</th><th class="p-4 text-center">ç°½åˆ°</th><th class="p-4 text-center">ç°½é€€</th><th class="p-4 text-center">ç‹€æ…‹</th><th class="p-4 text-center">æ“ä½œ</th></tr></thead><tbody id="attendance-list" class="divide-y divide-slate-100 text-sm"></tbody></table></div>
            </div>
            <div id="view-proxy" class="view-section h-full flex flex-col p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">å±…æœå“¡ä¼‘å‡ä»£ç”³è«‹</h2>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 max-w-2xl">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="col-span-2"><label class="block text-sm font-bold text-slate-500 mb-2">é¸æ“‡å±…æœå“¡</label><select id="proxy-caregiver" class="w-full border rounded-lg p-3 bg-slate-50 font-bold text-slate-700"></select></div>
                        <div><label class="block text-sm font-bold text-slate-500 mb-2">æ—¥æœŸ</label><input type="date" id="proxy-date" class="w-full border rounded-lg p-3"></div>
                        <div><label class="block text-sm font-bold text-slate-500 mb-2">å‡åˆ¥</label><select id="proxy-type" class="w-full border rounded-lg p-3 bg-white"><option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option><option value="è£œä¼‘">è£œä¼‘</option><option value="ç—…å‡">ç—…å‡</option><option value="äº‹å‡">äº‹å‡</option><option value="å©šå‡">å©šå‡</option><option value="å–ªå‡">å–ªå‡</option><option value="å…¬å‡">å…¬å‡</option><option value="ç”¢å‡">ç”¢å‡</option><option value="é™ªç”¢å‡">é™ªç”¢å‡</option><option value="ç”Ÿç†å‡">ç”Ÿç†å‡</option><option value="å®¶åº­ç…§é¡§å‡">å®¶åº­ç…§é¡§å‡</option><option value="æ­²æ™‚ç¥­å„€å‡">æ­²æ™‚ç¥­å„€å‡</option></select></div>
                        <div><label class="block text-sm font-bold text-slate-500 mb-2">æ™‚æ•¸</label><input type="number" id="proxy-hours" class="w-full border rounded-lg p-3" placeholder="4.0"></div>
                    </div>
                    <button onclick="submitProxyRequest()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">é€å‡ºç”³è«‹</button>
                </div>
            </div>
            <div id="view-settings" class="view-section h-full flex flex-col p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">ç³»çµ±è¨­å®š</h2>
                <div class="grid grid-cols-2 gap-8"><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="font-bold text-lg text-slate-700 mb-4 border-b pb-2">ğŸ”‘ ç³»çµ±æ¬Šé™åˆ†é…è¡¨</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-600 uppercase font-bold text-xs"><tr><th class="p-3">è¡Œæ”¿äººå“¡</th><th class="p-3 text-center">ğŸ“ ä»£ç”³è«‹</th><th class="p-3 text-center">ğŸ‘¥ å“¡å·¥è³‡æ–™</th><th class="p-3 text-center">ğŸ“š ç‰¹ä¼‘å­˜æ‘º</th><th class="p-3 text-center">ğŸ’° è–ªè³‡ç³»çµ±</th><th class="p-3 text-center">ğŸ“‹ è€ƒæ ¸ç³»çµ±</th></tr></thead><tbody id="permission-table-body"></tbody></table></div></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 max-w-2xl"><h3 class="font-bold text-lg text-slate-700 mb-4 border-b pb-2">â° è€ƒå‹¤è¦å‰‡è¨­å®š</h3><div class="grid grid-cols-2 gap-6"><div><label class="block text-sm font-bold text-slate-500 mb-1">æ¨™æº–ä¸Šç­æ™‚é–“</label><input type="time" id="work-start" class="w-full border rounded p-2 text-slate-700 font-bold" value="08:30"></div><div><label class="block text-sm font-bold text-slate-500 mb-1">æ¨™æº–ä¸‹ç­æ™‚é–“</label><input type="time" id="work-end" class="w-full border rounded p-2 text-slate-700 font-bold" value="17:30"></div><div class="col-span-2"><label class="block text-sm font-bold text-slate-500 mb-1">æ‰“å¡å½ˆæ€§ç·©è¡ (åˆ†é˜)</label><div class="flex items-center gap-2"><input type="number" id="clock-buffer" class="w-24 border rounded p-2 text-center font-bold" value="5"><span class="text-xs text-slate-400">åˆ†é˜å…§ä¸ç®—é²åˆ°/æ—©é€€</span></div></div></div></div></div>
                <div class="mt-6"><button onclick="saveSettings()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition">å„²å­˜æ‰€æœ‰è¨­å®š</button></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 border border-slate-200">
            <h3 class="font-bold text-lg mb-4 text-slate-800">âœï¸ ä¿®æ­£è€ƒå‹¤ç´€éŒ„</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½åˆ°æ™‚é–“</label><input type="time" id="edit-in" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½é€€æ™‚é–“</label><input type="time" id="edit-out" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div class="flex gap-2 justify-end mt-6 pt-4 border-t border-slate-100"><button onclick="closeEditModal()" class="px-3 py-1 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="submitEditAttendance()" class="px-4 py-1 bg-blue-600 text-white font-bold rounded shadow-md text-sm">æ›´æ–°</button></div>
            </div>
        </div>
    </div>

    <div id="manual-entry-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 border border-slate-200">
            <h3 class="font-bold text-lg mb-4 text-slate-800">â• è£œç™»æ‰“å¡ç´€éŒ„</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">è¡Œæ”¿äººå“¡</label><select id="manual-emp" class="w-full border rounded p-2 font-bold text-slate-700"></select></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="manual-date" class="w-full border rounded p-2 font-bold text-slate-700"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½åˆ°æ™‚é–“</label><input type="time" id="manual-in" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½é€€æ™‚é–“</label><input type="time" id="manual-out" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div class="flex gap-2 justify-end mt-6 pt-4 border-t border-slate-100"><button onclick="closeManualEntry()" class="px-3 py-1 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="submitManualEntry()" class="px-4 py-1 bg-emerald-600 text-white font-bold rounded shadow-md text-sm">ç¢ºèªè£œç™»</button></div>
            </div>
        </div>
    </div>
</body>
</html>