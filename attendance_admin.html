<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤èˆ‡å¯©æ ¸ç®¡ç†å¾Œå° (ERPæ•´åˆæ ¸å¿ƒ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; } 
        .nav-item { cursor: pointer; transition: all 0.2s; border-radius: 8px; margin-bottom: 4px; padding: 12px; color: #64748b; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background-color: #f1f5f9; color: #334155; }
        .nav-item.active { background-color: #e0f2fe; color: #0284c7; border-right: 4px solid #0284c7; }
        
        /* Iframe èˆ‡ å…§å»ºå€å¡Šåˆ‡æ› */
        #iframe-container { width: 100%; height: calc(100vh - 64px); background: #fff; }
        #app-frame { width: 100%; height: 100%; border: none; }
        
        .sidebar-hidden { width: 0px !important; opacity: 0; pointer-events: none; }
        #sidebar-panel { transition: width 0.3s ease-in-out; white-space: nowrap; overflow: hidden; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null; 
        let systemSettings = { allowedProxies: [], allowedEmployee: [], allowedLeave: [], allowedSalary: [], allowedAssessment: [], workStartTime: "08:30", workEndTime: "17:30", clockBuffer: 5 }; 
        let allAdmins = []; let adminIds = new Set(); let allCaregivers = [];
        let currentEditAttendanceId = null; let currentAttendanceData = [];

        // ç¶å®šå…¨åŸŸå‡½å¼
        window.loginAs = loginAs;
        window.toggleSidebar = toggleSidebar;
        window.switchTab = switchTab;
        window.openExternalSystem = openExternalSystem; // â˜… æ–°å¢ï¼šåˆ‡æ›åˆ°å¤–éƒ¨ç³»çµ±
        
        // åŸæœ‰åŠŸèƒ½
        window.processRequest = processRequest; 
        window.saveSettings = saveSettings;
        window.submitProxyRequest = submitProxyRequest;
        window.changeAttendanceFilter = changeAttendanceFilter;
        window.exportAttendance = exportAttendance;
        window.openEditAttendance = openEditAttendance;
        window.closeEditModal = closeEditModal;
        window.submitEditAttendance = submitEditAttendance;
        window.deleteAttendance = deleteAttendance;
        window.openManualEntry = openManualEntry;
        window.closeManualEntry = closeManualEntry;
        window.submitManualEntry = submitManualEntry;

        // ç›£è½ç³»çµ±è¨­å®š
        onSnapshot(doc(db, "system_settings", "config"), (docSnap) => {
            if (docSnap.exists()) {
                systemSettings = { ...systemSettings, ...docSnap.data() };
                if(document.getElementById('work-start')) {
                    document.getElementById('work-start').value = systemSettings.workStartTime;
                    document.getElementById('work-end').value = systemSettings.workEndTime;
                    document.getElementById('clock-buffer').value = systemSettings.clockBuffer;
                }
            }
            if (currentUser) renderSidebar();
            if (allAdmins.length > 0) renderPermissionTable();
        });

        // è¼‰å…¥å“¡å·¥ (ç”¨æ–¼ç™»å…¥é¸å–®)
        const qEmp = query(collection(db, "employees"), orderBy("code"));
        onSnapshot(qEmp, (snap) => {
            const sel = document.getElementById('user-select');
            const attFilter = document.getElementById('attendance-employee-filter');
            
            // åªæœ‰åœ¨é‚„æ²’ç™»å…¥æ™‚æ‰é‡ç¹ªç™»å…¥é¸å–®ï¼Œé¿å…å¹²æ“¾
            if(!currentUser) {
                sel.innerHTML = '<option value="super_admin">ğŸ‘‘ ç¸½ç®¡ç†å“¡ (Super Admin)</option>';
            }
            
            attFilter.innerHTML = '<option value="all">å…¨é«”è¡Œæ”¿äººå“¡</option>';
            allAdmins = []; allCaregivers = []; adminIds.clear();
            
            snap.forEach(doc => {
                const e = { id: doc.id, ...doc.data() };
                if (!e.resignDate) {
                    if (e.role === 'admin') {
                        allAdmins.push(e); adminIds.add(e.id);
                        if(!currentUser) sel.innerHTML += `<option value="${e.id}" data-role="admin" data-name="${e.name}">ğŸ‘¤ ${e.name}</option>`;
                        attFilter.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                    } else { allCaregivers.push(e); }
                }
            });
            renderPermissionTable(); renderCaregiverSelect();
        });

        function loginAs(select) {
            const val = select.value;
            if (val === 'super_admin') { currentUser = { id: 'super', name: 'ç¸½ç®¡ç†å“¡', role: 'super_admin' }; } 
            else { const opt = select.options[select.selectedIndex]; currentUser = { id: val, name: opt.dataset.name, role: 'admin' }; }
            
            sessionStorage.setItem('kuangyou_user', JSON.stringify(currentUser));
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('main-panel').classList.remove('hidden');
            document.getElementById('current-user-name').innerText = currentUser.name;
            renderSidebar();
            
            // é è¨­é€²å…¥ç•«é¢
            if(currentUser.role === 'super_admin') switchTab('approval');
            else {
                // å¦‚æœæ˜¯ä¸€èˆ¬è¡Œæ”¿ï¼Œé è¨­é€²å…¥ç¬¬ä¸€å€‹æœ‰æ¬Šé™çš„åŠŸèƒ½ï¼Œæˆ–å€‹äººæ‰“å¡
                switchTab('approval'); 
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar-panel');
            sidebar.classList.toggle('sidebar-hidden');
            sidebar.classList.toggle('w-64');
        }

        // â˜… é‡é»ï¼šæ•´åˆæ‰€æœ‰ç³»çµ±çš„å´é‚Šæ¬„
        function renderSidebar() {
            const nav = document.getElementById('nav-menu');
            nav.innerHTML = '';
            
            // 1. å…§å»ºåŠŸèƒ½ (Native DIVs)
            nav.innerHTML += `<div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-2">ç°½æ ¸èˆ‡ç›£æ§</div>`;
            
            if (currentUser.role === 'super_admin') {
                nav.innerHTML += `<div onclick="switchTab('approval')" id="nav-approval" class="nav-item"><span>âœ…</span> å¾…ç°½æ ¸æ¸…å–® <span id="badge-count" class="bg-red-500 text-white text-[10px] px-2 rounded-full hidden">0</span></div>`;
                nav.innerHTML += `<div onclick="switchTab('attendance')" id="nav-attendance" class="nav-item"><span>ğŸ“Š</span> è¡Œæ”¿å‡ºå‹¤ç›£æ§</div>`;
            }
            if (hasPermission('allowedProxies')) { 
                nav.innerHTML += `<div onclick="switchTab('proxy')" id="nav-proxy" class="nav-item"><span>ğŸ“</span> å±…æœå“¡ä»£ç”³è«‹</div>`; 
            }
            
            // 2. å¤–éƒ¨ç³»çµ± (Iframe Modules)
            nav.innerHTML += `<div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider mt-4">ERP æ ¸å¿ƒç³»çµ±</div>`;

            if (hasPermission('allowedEmployee')) { 
                nav.innerHTML += `<div onclick="openExternalSystem('employee.html', this)" class="nav-item"><span>ğŸ‘¥</span> å“¡å·¥è³‡æ–™åº«</div>`; 
            }
            
            if (hasPermission('allowedLeave')) { 
                nav.innerHTML += `<div onclick="openExternalSystem('leave.html', this)" class="nav-item"><span>ğŸ“š</span> ç‰¹ä¼‘å­˜æ‘ºç®¡ç†</div>`; 
            }

            if (hasPermission('allowedSalary')) {
                nav.innerHTML += `<div onclick="openExternalSystem('salary.html', this)" class="nav-item"><span>ğŸ’°</span> è¡Œæ”¿äººå“¡è–ªè³‡</div>`;
                nav.innerHTML += `<div onclick="openExternalSystem('salary_caregiver.html', this)" class="nav-item"><span>ğŸ¥</span> å±…æœå“¡è–ªè³‡</div>`;
            }

            if (hasPermission('allowedAssessment')) {
                nav.innerHTML += `<div onclick="openExternalSystem('assessment.html', this)" class="nav-item"><span>ğŸ“‹</span> è€ƒæ ¸è©•é‘‘ç³»çµ±</div>`;
            }

            // 3. è¨­å®š (Native DIV)
            if (currentUser.role === 'super_admin') { 
                nav.innerHTML += `<div class="mt-auto border-t pt-2"><div onclick="switchTab('settings')" id="nav-settings" class="nav-item"><span>âš™ï¸</span> ç³»çµ±æ¬Šé™è¨­å®š</div></div>`; 
            }
        }

        function hasPermission(permKey) { 
            if(!currentUser) return false; 
            if(currentUser.role === 'super_admin') return true; 
            return systemSettings[permKey]?.includes(currentUser.id); 
        }
        
        // åˆ‡æ›åˆ°å…§å»ºåŠŸèƒ½ (éš±è— Iframe)
        function switchTab(tabId) {
            // éš±è—æ‰€æœ‰ Iframe èˆ‡ Div
            document.getElementById('iframe-container').classList.add('hidden');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-placeholder').classList.add('hidden');
            
            // é¡¯ç¤ºç›®æ¨™ Div
            const target = document.getElementById(`view-${tabId}`);
            if(target) target.classList.remove('hidden');
            
            // æ›´æ–°é¸å–®ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${tabId}`);
            if(activeNav) activeNav.classList.add('active');
            
            // åˆå§‹åŒ–ç‰¹å®šåŠŸèƒ½
            if(tabId === 'approval') loadPendingRequests();
            if(tabId === 'attendance') { 
                const currentMonth = dayjs().format('YYYY-MM'); 
                document.getElementById('attendance-month').value = currentMonth; 
                loadAttendanceStats(); 
            }
        }

        // â˜… æ–°å¢ï¼šåˆ‡æ›åˆ°å¤–éƒ¨ç³»çµ± (é¡¯ç¤º Iframe)
        function openExternalSystem(url, element) {
            // éš±è—æ‰€æœ‰ Div
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-placeholder').classList.add('hidden');
            
            // é¡¯ç¤º Iframe
            const container = document.getElementById('iframe-container');
            const frame = document.getElementById('app-frame');
            container.classList.remove('hidden');
            
            // è¼‰å…¥ç¶²å€ (é¿å…é‡è¤‡è¼‰å…¥)
            if(frame.getAttribute('src') !== url) frame.src = url;
            
            // æ›´æ–°é¸å–®ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
        }

        // --- ä»¥ä¸‹ç‚ºåŸæœ‰çš„å…§å»ºåŠŸèƒ½é‚è¼¯ (ä¿æŒä¸è®Š) ---
        function openManualEntry() { const sel = document.getElementById('manual-emp'); sel.innerHTML = '<option value="">-- è«‹é¸æ“‡è¡Œæ”¿äººå“¡ --</option>'; allAdmins.forEach(admin => { sel.innerHTML += `<option value="${admin.id}">${admin.name}</option>`; }); document.getElementById('manual-date').value = dayjs().format('YYYY-MM-DD'); document.getElementById('manual-in').value = systemSettings.workStartTime || "08:30"; document.getElementById('manual-out').value = systemSettings.workEndTime || "17:30"; document.getElementById('manual-entry-modal').classList.remove('hidden'); }
        function closeManualEntry() { document.getElementById('manual-entry-modal').classList.add('hidden'); }
        async function submitManualEntry() { const empSel = document.getElementById('manual-emp'); const empId = empSel.value; const empName = empSel.options[empSel.selectedIndex]?.text; const date = document.getElementById('manual-date').value; const inTime = document.getElementById('manual-in').value; const outTime = document.getElementById('manual-out').value; if(!empId || !date) return alert("è«‹é¸æ“‡äººå“¡èˆ‡æ—¥æœŸ"); try { await addDoc(collection(db, "attendance"), { empId: empId, name: empName, date: date, inTime: inTime || null, outTime: outTime || null, isManual: true, lastEditedBy: currentUser.name, timestamp: new Date().toISOString() }); alert("è£œç™»å®Œæˆï¼"); closeManualEntry(); } catch(e) { console.error(e); alert("è£œç™»å¤±æ•—"); } }
        function renderPermissionTable() { const tbody = document.getElementById('permission-table-body'); tbody.innerHTML = ""; allAdmins.forEach(admin => { const pProxy = systemSettings.allowedProxies?.includes(admin.id) ? 'checked' : ''; const pEmp = systemSettings.allowedEmployee?.includes(admin.id) ? 'checked' : ''; const pLeave = systemSettings.allowedLeave?.includes(admin.id) ? 'checked' : ''; const pSalary = systemSettings.allowedSalary?.includes(admin.id) ? 'checked' : ''; const pAssess = systemSettings.allowedAssessment?.includes(admin.id) ? 'checked' : ''; tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold text-slate-700">${admin.name}</td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedProxies" value="${admin.id}" ${pProxy}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedEmployee" value="${admin.id}" ${pEmp}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedLeave" value="${admin.id}" ${pLeave}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedSalary" value="${admin.id}" ${pSalary}></td><td class="p-3 text-center"><input type="checkbox" class="w-5 h-5 perm-chk" data-type="allowedAssessment" value="${admin.id}" ${pAssess}></td></tr>`; }); }
        async function saveSettings() { const newPermissions = { allowedProxies: [], allowedEmployee: [], allowedLeave: [], allowedSalary: [], allowedAssessment: [] }; document.querySelectorAll('.perm-chk:checked').forEach(chk => { const type = chk.dataset.type; const uid = chk.value; if(newPermissions[type]) newPermissions[type].push(uid); }); const workStart = document.getElementById('work-start').value; const workEnd = document.getElementById('work-end').value; const clockBuffer = Number(document.getElementById('clock-buffer').value); try { await setDoc(doc(db, "system_settings", "config"), { ...newPermissions, workStartTime: workStart, workEndTime: workEnd, clockBuffer: clockBuffer, updatedAt: new Date().toISOString() }, { merge: true }); alert("è¨­å®šå·²å„²å­˜ï¼"); } catch(e) { console.error(e); alert("å„²å­˜å¤±æ•—"); } }
        function loadPendingRequests(){const q=query(collection(db,"requests"),where("status","==","pending"));onSnapshot(q,(snap)=>{const list=document.getElementById('approval-list');list.innerHTML="";const count=snap.size;const badge=document.getElementById('badge-count');if(badge){badge.innerText=count;badge.classList.toggle('hidden',count===0)}let requests=[];snap.forEach(doc=>requests.push({id:doc.id,...doc.data()}));requests.sort((a,b)=>dayjs(b.createdAt).unix()-dayjs(a.createdAt).unix());if(requests.length===0){list.innerHTML=`<div class="text-center text-slate-400 py-10">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å–®æ“š</div>`;return}requests.forEach(r=>{let typeBadge=r.category==='leave'?`<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">è«‹å‡-${r.type}</span>`:`<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">åŠ ç­ç”³è«‹</span>`;list.innerHTML+=`<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-3 flex justify-between items-center"><div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-lg text-slate-800">${r.name}</span>${typeBadge}</div><div class="text-sm text-slate-500">æ—¥æœŸï¼š<span class="font-bold text-slate-700">${r.date}</span> | æ™‚æ•¸ï¼š<span class="font-bold text-slate-700">${r.hours} H</span></div><div class="text-xs text-slate-400 mt-1">äº‹ç”±ï¼š${r.note||'ç„¡'}</div></div><div class="flex gap-2"><button onclick="processRequest('${r.id}','rejected')" class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-bold transition">é§å›</button><button onclick="processRequest('${r.id}','approved')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-bold shadow transition">æ ¸å‡†</button></div></div>`})})}
        async function processRequest(reqId,action){let rejectReason="";if(action==='rejected'){rejectReason=prompt("è«‹è¼¸å…¥é§å›åŸå› ï¼š","è³‡æ–™ä¸å…¨ / è©¦ç®—æœ‰èª¤");if(rejectReason===null)return;if(rejectReason.trim()==="")rejectReason="æœªå¡«å¯«åŸå› "}else{if(!confirm(`ç¢ºå®šè¦æ ¸å‡†æ­¤ç”³è«‹å—ï¼Ÿ`))return}const reqRef=doc(db,"requests",reqId);const reqSnap=await getDoc(reqRef);const reqData=reqSnap.data();const batch=writeBatch(db);batch.update(reqRef,{status:action,reviewedAt:new Date().toISOString(),rejectReason:rejectReason});if(action==='approved'){if(reqData.category==='overtime'){const ledgerRef=doc(collection(db,"leave_ledger"));batch.set(ledgerRef,{empId:reqData.empId,sourceType:`åŠ ç­è£œä¼‘ (${reqData.date})`,originalHours:reqData.hours,remaining:reqData.hours,validFrom:reqData.date,expiryDate:dayjs(reqData.date).add(1,'year').format('YYYY-MM-DD'),createdAt:new Date().toISOString()})}else if(reqData.category==='leave'&&(reqData.type==='ç‰¹ä¼‘'||reqData.type==='è£œä¼‘')){const qLedger=query(collection(db,"leave_ledger"),where("empId","==",reqData.empId));const ledgerSnap=await getDocs(qLedger);let ledgers=[];ledgerSnap.forEach(d=>ledgers.push({id:d.id,...d.data()}));ledgers=ledgers.filter(l=>l.remaining>0&&dayjs(l.expiryDate).isAfter(dayjs())).sort((a,b)=>dayjs(a.expiryDate).unix()-dayjs(b.expiryDate).unix());let remainingToDeduct=reqData.hours;let deductionLog=[];for(let l of ledgers){if(remainingToDeduct<=0)break;const deduct=Math.min(l.remaining,remainingToDeduct);batch.update(doc(db,"leave_ledger",l.id),{remaining:l.remaining-deduct});deductionLog.push({ledgerId:l.id,source:l.sourceType,amount:deduct});remainingToDeduct-=deduct}if(remainingToDeduct>0)return alert("âš ï¸ é¤˜é¡ä¸è¶³");const recRef=doc(collection(db,"leave_records"));batch.set(recRef,{empId:reqData.empId,date:reqData.date,type:reqData.type,hours:reqData.hours,note:reqData.note,deductionLog:deductionLog,createdAt:new Date().toISOString()})}else{const recRef=doc(collection(db,"leave_records"));batch.set(recRef,{empId:reqData.empId,date:reqData.date,type:reqData.type,hours:reqData.hours,note:reqData.note,deductionLog:[],createdAt:new Date().toISOString()})} }try{await batch.commit()}catch(e){console.error(e);alert("æ“ä½œå¤±æ•—")}}
        function changeAttendanceFilter(){loadAttendanceStats()}
        function loadAttendanceStats(){const monthStr=document.getElementById('attendance-month').value;const targetEmpId=document.getElementById('attendance-employee-filter').value;if(!monthStr)return;const startStr=monthStr+"-01";const endStr=dayjs(monthStr).endOf('month').format('YYYY-MM-DD');let conditions=[where("date",">=",startStr),where("date","<=",endStr)];if(targetEmpId!=='all')conditions.push(where("empId","==",targetEmpId));const q=query(collection(db,"attendance"),...conditions);onSnapshot(q,(snap)=>{const list=document.getElementById('attendance-list');list.innerHTML="";currentAttendanceData=[];snap.forEach(doc=>{const r={id:doc.id,...doc.data()};if(adminIds.has(r.empId))currentAttendanceData.push(r)});currentAttendanceData.sort((a,b)=>a.date.localeCompare(b.date));if(currentAttendanceData.length===0){list.innerHTML=`<tr><td colspan="5" class="p-8 text-center text-slate-400">å°šç„¡è¡Œæ”¿äººå“¡æ‰“å¡ç´€éŒ„</td></tr>`;return}currentAttendanceData.forEach(r=>{const isLate=r.inTime>"08:35";const status=isLate?`<span class="text-red-500 font-bold">é²åˆ°</span>`:`<span class="text-green-600 font-bold">æ­£å¸¸</span>`;let actionBtns=`<button onclick="openEditAttendance('${r.id}','${r.inTime||''}','${r.outTime||''}')" class="text-xs bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 px-2 py-1 rounded transition mr-1">âœï¸</button><button onclick="deleteAttendance('${r.id}')" class="text-xs bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-600 px-2 py-1 rounded transition">ğŸ—‘ï¸</button>`;list.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="p-3"><div class="font-bold text-slate-700">${r.date}</div><div class="text-xs text-slate-400">${r.name}</div></td><td class="p-3 text-center font-mono">${r.inTime||'-'}</td><td class="p-3 text-center font-mono">${r.outTime||'-'}</td><td class="p-3 text-center">${status}</td><td class="p-3 text-center">${actionBtns}</td></tr>`})})}
        function exportAttendance(){if(currentAttendanceData.length===0)return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");let csvContent="\uFEFFæ—¥æœŸ,å§“å,ç°½åˆ°æ™‚é–“,ç°½é€€æ™‚é–“,ç‹€æ…‹\n";currentAttendanceData.forEach(r=>{const status=(r.inTime>"08:35")?"é²åˆ°":"æ­£å¸¸";csvContent+=`${r.date},${r.name},${r.inTime||''},${r.outTime||''},${status}\n`});const url=URL.createObjectURL(new Blob([csvContent],{type:"text/csv;charset=utf-8;"}));const link=document.createElement("a");link.href=url;link.download=`è€ƒå‹¤ç´€éŒ„_${dayjs().format('YYYYMMDD')}.csv`;link.click()}
        async function deleteAttendance(id){if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ"))await deleteDoc(doc(db,"attendance",id))}
        function openEditAttendance(id,i,o){currentEditAttendanceId=id;document.getElementById('edit-modal').classList.remove('hidden');document.getElementById('edit-in').value=i;document.getElementById('edit-out').value=o}
        function closeEditModal(){document.getElementById('edit-modal').classList.add('hidden')}
        async function submitEditAttendance(){if(!currentEditAttendanceId)return;await updateDoc(doc(db,"attendance",currentEditAttendanceId),{inTime:document.getElementById('edit-in').value||null,outTime:document.getElementById('edit-out').value||null,lastEditedBy:currentUser.name,lastEditedAt:new Date().toISOString()});closeEditModal()}
        function renderCaregiverSelect(){const sel=document.getElementById('proxy-caregiver');sel.innerHTML='<option value="">è«‹é¸æ“‡å±…æœå“¡</option>';allCaregivers.forEach(c=>{sel.innerHTML+=`<option value="${c.id}" data-name="${c.name}">${c.name} (${c.code})</option>`})}
        async function submitProxyRequest(){const sel=document.getElementById('proxy-caregiver');const empId=sel.value;const empName=sel.options[sel.selectedIndex]?.dataset.name;const date=document.getElementById('proxy-date').value;const type=document.getElementById('proxy-type').value;const hours=document.getElementById('proxy-hours').value;if(!empId||!date||!hours)return alert("è«‹å¡«å¯«å®Œæ•´");await addDoc(collection(db,"requests"),{empId,name:empName,category:"leave",type,date,hours:Number(hours),createdBy:currentUser.id,note:`ç”± ${currentUser.name} ä»£ç”³è«‹`,status:"pending",createdAt:new Date().toISOString()});alert("ä»£ç”³è«‹å·²é€å‡ºï¼");document.getElementById('proxy-hours').value=""}
    </script>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div id="login-panel" class="absolute inset-0 bg-slate-800 z-50 flex flex-col items-center justify-center">
        <div class="bg-white p-8 rounded-2xl w-96 shadow-2xl text-center">
            <h1 class="text-2xl font-bold text-slate-800 mb-6">å¾Œå°ç®¡ç†ç™»å…¥</h1>
            <select id="user-select" class="w-full p-3 border rounded-lg mb-4 font-bold bg-slate-50 text-lg"><option>è¼‰å…¥ä¸­...</option></select>
            <button onclick="loginAs(document.getElementById('user-select'))" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 transition">é€²å…¥å¾Œå°</button>
        </div>
    </div>

    <div id="main-panel" class="flex h-full hidden">
        <div id="sidebar-panel" class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
                <h2 class="text-xl font-black text-slate-800 tracking-tight">ç®¡ç†ä¸­å¿ƒ</h2>
                <div class="text-xs text-slate-400 mt-1">Hello, <span id="current-user-name" class="font-bold text-blue-600">---</span></div>
            </div>
            <div id="nav-menu" class="flex-1 flex flex-col py-4 overflow-y-auto"></div>
            <div class="p-4 border-t"><button onclick="location.reload()" class="w-full py-2 text-slate-400 hover:text-slate-600 text-sm font-bold">ç™»å‡ºç³»çµ±</button></div>
        </div>

        <div class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col">
            <div class="bg-white border-b p-3 flex items-center shadow-sm z-10">
                <button onclick="toggleSidebar()" class="mr-4 p-2 text-slate-500 hover:bg-slate-100 rounded-lg focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <h2 class="text-lg font-bold text-slate-700" id="page-title">å„€è¡¨æ¿</h2>
            </div>

            <div id="iframe-container" class="w-full h-full hidden"><iframe id="app-frame" src=""></iframe></div>

            <div id="view-placeholder" class="view-section h-full flex flex-col items-center justify-center hidden"><div class="text-6xl mb-4">ğŸ”’</div><div class="text-slate-400 font-bold">æ‚¨ç›®å‰ç„¡ä»»ä½•å¾Œå°ç®¡ç†æ¬Šé™</div></div>
            
            <div id="view-approval" class="view-section h-full flex flex-col p-8 hidden"><h2 class="text-2xl font-bold text-slate-800 mb-6">å¾…ç°½æ ¸æ¸…å–®</h2><div id="approval-list" class="flex-1 overflow-y-auto pr-2 pb-20"></div></div>
            
            <div id="view-attendance" class="view-section h-full flex flex-col p-8 hidden">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <div class="flex items-center gap-2"><h2 class="text-2xl font-bold text-slate-800 mr-2">è¡Œæ”¿å‡ºå‹¤ç›£æ§</h2><input type="month" id="attendance-month" class="border rounded-lg p-2 text-sm font-bold text-slate-600 bg-white shadow-sm" onchange="changeAttendanceFilter()"><select id="attendance-employee-filter" class="border rounded-lg p-2 text-sm font-bold text-slate-600 bg-white shadow-sm max-w-xs" onchange="changeAttendanceFilter()"></select></div>
                    <div class="flex gap-2"><button onclick="openManualEntry()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2"><span>â•</span> è£œç™»</button><button onclick="exportAttendance()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2"><span>ğŸ–¨ï¸</span> åŒ¯å‡ºå ±è¡¨</button></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 overflow-y-auto"><table class="w-full text-left relative"><thead class="bg-slate-100 text-slate-500 font-bold text-sm sticky top-0 z-10 shadow-sm"><tr><th class="p-4">æ—¥æœŸ / å§“å</th><th class="p-4 text-center">ç°½åˆ°</th><th class="p-4 text-center">ç°½é€€</th><th class="p-4 text-center">ç‹€æ…‹</th><th class="p-4 text-center">æ“ä½œ</th></tr></thead><tbody id="attendance-list" class="divide-y divide-slate-100 text-sm"></tbody></table></div>
            </div>
            
            <div id="view-proxy" class="view-section h-full flex flex-col p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">å±…æœå“¡ä¼‘å‡ä»£ç”³è«‹</h2>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 max-w-2xl">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="col-span-2"><label class="block text-sm font-bold text-slate-500 mb-2">é¸æ“‡å±…æœå“¡</label><select id="proxy-caregiver" class="w-full border rounded-lg p-3 bg-slate-50 font-bold text-slate-700"></select></div>
                        <div><label class="block text-sm font-bold text-slate-500 mb-2">æ—¥æœŸ</label><input type="date" id="proxy-date" class="w-full border rounded-lg p-3"></div>
                        <div><label class="block text-sm font-bold text-slate-500 mb-2">å‡åˆ¥</label><select id="proxy-type" class="w-full border rounded-lg p-3 bg-white"><option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option><option value="è£œä¼‘">è£œä¼‘</option><option value="ç—…å‡">ç—…å‡</option><option value="äº‹å‡">äº‹å‡</option><option value="å©šå‡">å©šå‡</option><option value="å–ªå‡">å–ªå‡</option><option value="å…¬å‡">å…¬å‡</option><option value="ç”¢å‡">ç”¢å‡</option><option value="é™ªç”¢å‡">é™ªç”¢å‡</option><option value="ç”Ÿç†å‡">ç”Ÿç†å‡</option><option value="å®¶åº­ç…§é¡§å‡">å®¶åº­ç…§é¡§å‡</option><option value="æ­²æ™‚ç¥­å„€å‡">æ­²æ™‚ç¥­å„€å‡</option></select></div>
                        <div><label class="block text-sm font-bold text-slate-500 mb-2">æ™‚æ•¸</label><input type="number" id="proxy-hours" class="w-full border rounded-lg p-3" placeholder="4.0"></div>
                    </div>
                    <button onclick="submitProxyRequest()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">é€å‡ºç”³è«‹</button>
                </div>
            </div>
            
            <div id="view-settings" class="view-section h-full flex flex-col p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">ç³»çµ±è¨­å®š</h2>
                <div class="grid grid-cols-2 gap-8"><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="font-bold text-lg text-slate-700 mb-4 border-b pb-2">ğŸ”‘ ç³»çµ±æ¬Šé™åˆ†é…è¡¨</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-600 uppercase font-bold text-xs"><tr><th class="p-3">è¡Œæ”¿äººå“¡</th><th class="p-3 text-center">ğŸ“ ä»£ç”³è«‹</th><th class="p-3 text-center">ğŸ‘¥ å“¡å·¥è³‡æ–™</th><th class="p-3 text-center">ğŸ“š ç‰¹ä¼‘å­˜æ‘º</th><th class="p-3 text-center">ğŸ’° è–ªè³‡ç³»çµ±</th><th class="p-3 text-center">ğŸ“‹ è€ƒæ ¸ç³»çµ±</th></tr></thead><tbody id="permission-table-body"></tbody></table></div></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 max-w-2xl"><h3 class="font-bold text-lg text-slate-700 mb-4 border-b pb-2">â° è€ƒå‹¤è¦å‰‡è¨­å®š</h3><div class="grid grid-cols-2 gap-6"><div><label class="block text-sm font-bold text-slate-500 mb-1">æ¨™æº–ä¸Šç­æ™‚é–“</label><input type="time" id="work-start" class="w-full border rounded p-2 text-slate-700 font-bold" value="08:30"></div><div><label class="block text-sm font-bold text-slate-500 mb-1">æ¨™æº–ä¸‹ç­æ™‚é–“</label><input type="time" id="work-end" class="w-full border rounded p-2 text-slate-700 font-bold" value="17:30"></div><div class="col-span-2"><label class="block text-sm font-bold text-slate-500 mb-1">æ‰“å¡å½ˆæ€§ç·©è¡ (åˆ†é˜)</label><div class="flex items-center gap-2"><input type="number" id="clock-buffer" class="w-24 border rounded p-2 text-center font-bold" value="5"><span class="text-xs text-slate-400">åˆ†é˜å…§ä¸ç®—é²åˆ°/æ—©é€€</span></div></div></div></div></div>
                <div class="mt-6"><button onclick="saveSettings()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition">å„²å­˜æ‰€æœ‰è¨­å®š</button></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 border border-slate-200">
            <h3 class="font-bold text-lg mb-4 text-slate-800">âœï¸ ä¿®æ­£è€ƒå‹¤ç´€éŒ„</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½åˆ°æ™‚é–“</label><input type="time" id="edit-in" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½é€€æ™‚é–“</label><input type="time" id="edit-out" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div class="flex gap-2 justify-end mt-6 pt-4 border-t border-slate-100"><button onclick="closeEditModal()" class="px-3 py-1 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="submitEditAttendance()" class="px-4 py-1 bg-blue-600 text-white font-bold rounded shadow-md text-sm">æ›´æ–°</button></div>
            </div>
        </div>
    </div>

    <div id="manual-entry-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 border border-slate-200">
            <h3 class="font-bold text-lg mb-4 text-slate-800">â• è£œç™»æ‰“å¡ç´€éŒ„</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">è¡Œæ”¿äººå“¡</label><select id="manual-emp" class="w-full border rounded p-2 font-bold text-slate-700"></select></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" id="manual-date" class="w-full border rounded p-2 font-bold text-slate-700"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½åˆ°æ™‚é–“</label><input type="time" id="manual-in" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">ç°½é€€æ™‚é–“</label><input type="time" id="manual-out" class="w-full border rounded p-2 text-center font-bold text-slate-700"></div>
                <div class="flex gap-2 justify-end mt-6 pt-4 border-t border-slate-100"><button onclick="closeManualEntry()" class="px-3 py-1 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="submitManualEntry()" class="px-4 py-1 bg-emerald-600 text-white font-bold rounded shadow-md text-sm">ç¢ºèªè£œç™»</button></div>
            </div>
        </div>
    </div>
</body>
</html>